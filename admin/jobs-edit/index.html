<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Jobs | FormanPacific Service Claims Management</title>
  <meta name="description" content="Edit and manage jobs in SharePoint BookAJobMaster list"/>
  <meta name="robots" content="noindex, nofollow"/>

  <!-- MSAL -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <!-- AG Grid Community -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css"/>
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>

  <style>
    :root{
      --primary:#1e3c72;--primary-dark:#152a52;--secondary:#2a5298;
      --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;
      --text-primary:#1e293b;--text-secondary:#64748b;--border:#e2e8f0;
      --bg-light:#f8fafc;--bg-white:#ffffff;
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1);
      --shadow-xl:0 20px 25px -5px rgba(0,0,0,.1)
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;
      color:var(--text-primary);
      background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);
      min-height:100vh;line-height:1.6
    }
    header{position:sticky;top:0;z-index:100;background:var(--bg-white);
      box-shadow:var(--shadow-md);border-bottom:2px solid var(--border)}
    .header-inner{max-width:1600px;margin:0 auto;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px}
    .brand{display:flex;align-items:center;gap:16px}
    .logo{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#fff;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:var(--shadow-md)}
    .brand-text h1{font-size:24px;color:var(--primary);margin:0;font-weight:700}
    .brand-text small{display:block;color:var(--text-secondary);font-size:14px;margin-top:2px}
    .header-actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:10px 20px;font-weight:600;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all .2s ease;text-decoration:none;white-space:nowrap}
    .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-dark)}
    .btn.secondary{background:var(--bg-light);color:var(--text-primary);border:2px solid var(--border)}
    .btn.secondary:hover{background:var(--border)}
    .btn.success{background:var(--success);color:#fff}
    .btn.success:hover{background:#059669}
    .btn.warning{background:var(--warning);color:#fff}
    .btn.warning:hover{background:#d97706}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.danger:hover{background:#dc2626}
    .btn.info{background:var(--info);color:#fff}
    .btn.info:hover{background:#2563eb}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
    .container{max-width:1600px;margin:24px auto;padding:0 24px 40px}
    .panel{background:var(--bg-white);border-radius:16px;box-shadow:var(--shadow-lg);padding:24px;border:1px solid var(--border)}
    .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:20px;padding-bottom:20px;border-bottom:2px solid var(--border)}
    .toolbar-group{display:flex;gap:8px;align-items:center}
    .toolbar .spacer{flex:1}
    .pill{background:var(--bg-light);color:var(--text-primary);padding:6px 14px;border-radius:999px;font-size:13px;font-weight:500;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border)}
    .pill.success{background:#d1fae5;color:#065f46;border-color:#6ee7b7}
    .pill.warning{background:#fed7aa;color:#92400e;border-color:#fb923c}
    .pill.danger{background:#fee2e2;color:#991b1b;border-color:#fca5a5}
    .pill.info{background:#dbeafe;color:#1e40af;border-color:#93c5fd}
    .statusbar{display:flex;gap:12px;align-items:center;margin-top:20px;padding-top:20px;border-top:2px solid var(--border);flex-wrap:wrap}
    #grid{height:600px;width:100%;border:2px solid var(--border);border-radius:10px;overflow:hidden}
    .search-box{position:relative;flex:0 1 300px}
    .search-input{width:100%;border:2px solid var(--border);border-radius:10px;padding:8px 36px 8px 12px;font-size:14px;transition:all .2s ease}
    .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary);pointer-events:none}
    select{border:2px solid var(--border);border-radius:10px;padding:8px 12px;font-size:14px;background:var(--bg-white);cursor:pointer;transition:all .2s ease}
    select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .overlay-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
    .overlay-content{text-align:center;max-width:480px;padding:40px;background:var(--bg-white);border-radius:20px;box-shadow:var(--shadow-xl)}
    .spinner{width:60px;height:60px;border:4px solid var(--border);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s cubic-bezier(.68,-.55,.265,1.55) infinite;margin:0 auto 20px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none!important}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
    .modal.active{display:flex;animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal-card{background:var(--bg-white);border-radius:16px;width:520px;max-width:92vw;max-height:85vh;overflow-y:auto;padding:24px;box-shadow:var(--shadow-xl);animation:slideUp .3s ease}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--border)}
    .modal-title{font-size:20px;font-weight:700;color:var(--text-primary)}
    .modal-close{background:none;border:none;font-size:24px;color:var(--text-secondary);cursor:pointer;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .modal-close:hover{background:var(--bg-light);color:var(--text-primary)}
    .form-row{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-weight:500;color:var(--text-primary);font-size:14px}
    .form-input,.form-select{width:100%;border:2px solid var(--border);border-radius:10px;padding:10px 14px;font-size:14px;transition:all .2s ease}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .form-help{font-size:12px;color:var(--text-secondary);margin-top:4px}
    .modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:20px;border-top:2px solid var(--border)}
    .toast-container{position:fixed;top:20px;right:20px;z-index:9999}
    .toast{background:var(--bg-white);padding:14px 18px;border-radius:10px;box-shadow:var(--shadow-lg);margin-bottom:10px;display:flex;align-items:center;gap:12px;min-width:300px;animation:slideInRight .3s ease;border-left:4px solid}
    .toast.success{border-left-color:var(--success)}.toast.error{border-left-color:var(--danger)}
    .toast.warning{border-left-color:var(--warning)}.toast.info{border-left-color:var(--info)}
    @keyframes slideInRight{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
    .bulk-actions{position:relative;display:inline-block}
    .bulk-menu{position:absolute;top:100%;left:0;margin-top:8px;background:var(--bg-white);border-radius:10px;box-shadow:var(--shadow-lg);border:1px solid var(--border);padding:8px;min-width:200px;display:none;z-index:50}
    .bulk-menu.show{display:block}
    .bulk-menu-item{padding:8px 12px;border-radius:6px;cursor:pointer;transition:background .2s ease;font-size:14px;display:flex;align-items:center;gap:8px}
    .bulk-menu-item:hover{background:var(--bg-light)}
    .bulk-menu-divider{height:1px;background:var(--border);margin:8px 0}
    .grid-stats{display:flex;gap:20px;align-items:center;font-size:13px;color:var(--text-secondary)}
    .grid-stat{display:flex;align-items:center;gap:4px}.grid-stat strong{color:var(--text-primary);font-weight:600}
    .column-config{position:relative}
    .column-menu{position:absolute;top:100%;right:0;margin-top:8px;background:var(--bg-white);border-radius:10px;box-shadow:var(--shadow-lg);border:1px solid var(--border);padding:12px;width:300px;max-height:400px;overflow-y:auto;display:none;z-index:50}
    .column-menu.show{display:block}
    .column-list{display:flex;flex-direction:column;gap:8px}
    .column-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;transition:background .2s ease}
    .column-item:hover{background:var(--bg-light)}
    .column-checkbox{width:16px;height:16px;cursor:pointer}
    @media (max-width:768px){
      .header-inner{padding:12px 16px}.brand-text h1{font-size:20px}
      .container{padding:0 16px 24px;margin:16px auto}.panel{padding:16px}
      .toolbar{gap:8px}#grid{height:400px}.modal-card{width:95vw;padding:20px}
      .search-box{flex:1 1 100%}
    }
    @media (prefers-color-scheme:dark){
      :root{--bg-white:#0f172a;--bg-light:#1e293b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#334155}
      body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%)}
      .ag-theme-alpine{--ag-background-color:var(--bg-white);--ag-header-background-color:var(--bg-light);--ag-odd-row-background-color:var(--bg-light);--ag-border-color:var(--border)}
      .form-input,.form-select,select{background:var(--bg-light);color:var(--text-primary)}
    }
    @media print{
      header,.toolbar,.statusbar{display:none}.panel{box-shadow:none;border:1px solid #000}#grid{height:auto}
    }
  </style>
</head>
<body>
  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Login -->
  <div id="loginScreen" class="overlay-screen">
    <div class="overlay-content">
      <div class="logo" style="margin:0 auto 20px;width:80px;height:80px;font-size:32px">FP</div>
      <h2 style="margin-bottom:12px;color:var(--text-primary)">Sign In Required</h2>
      <p style="color:var(--text-secondary);margin-bottom:24px">Access the Jobs Editor with your Microsoft work account. SharePoint permissions are enforced.</p>
      <div class="pill info" style="margin:0 auto 24px;display:inline-flex"><span>🔒</span> Secure SharePoint Integration</div>
      <button id="btnLogin" class="btn primary" style="font-size:16px;padding:12px 24px">Sign in with Microsoft</button>
      <p style="font-size:12px;color:var(--text-secondary);margin-top:16px">You'll be redirected to Microsoft's secure login</p>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingScreen" class="overlay-screen hidden">
    <div class="overlay-content">
      <div class="spinner"></div>
      <h3 style="color:var(--text-primary)">Loading Jobs Editor</h3>
      <p style="color:var(--text-secondary);margin-top:8px">Connecting to SharePoint...</p>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo">FP</div>
        <div class="brand-text">
          <h1>FormanPacific <small>Jobs Editor</small></h1>
          <small>📊 BookAJobMaster (SharePoint Live)</small>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn secondary" onclick="location.href='/admin/dashboard'">← Dashboard</button>
        <button class="btn secondary" onclick="location.href='/admin/jobs-master'">👁️ View Only</button>
        <button class="btn info" id="btnRefresh">🔄 Refresh</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <div class="container">
    <div class="panel">
      <div class="toolbar">
        <div class="toolbar-group">
          <button id="btnAddRow" class="btn success">➕ Add Row</button>

          <div class="bulk-actions">
            <button id="btnBulkActions" class="btn secondary">Bulk Actions ▼</button>
            <div id="bulkMenu" class="bulk-menu">
              <div class="bulk-menu-item" id="btnDeleteSelected">🗑️ Delete Selected</div>
              <div class="bulk-menu-item" id="btnDuplicateSelected">📋 Duplicate Selected</div>
              <div class="bulk-menu-divider"></div>
              <div class="bulk-menu-item" id="btnExportSelected">📥 Export Selected</div>
              <div class="bulk-menu-item" id="btnExportAll">📥 Export All</div>
            </div>
          </div>

          <button id="btnSave" class="btn primary" disabled>💾 Save Changes</button>
          <button id="btnDiscard" class="btn secondary" disabled>❌ Discard Changes</button>
        </div>

        <div class="spacer"></div>

        <div class="toolbar-group">
          <div class="search-box">
            <input type="text" id="quickSearch" class="search-input" placeholder="Quick search..."/>
            <span class="search-icon">🔍</span>
          </div>

          <div class="column-config">
            <button id="btnColumnConfig" class="btn secondary">⚙️ Columns</button>
            <div id="columnMenu" class="column-menu">
              <h4 style="margin:0 0 12px;font-size:14px">Visible Columns</h4>
              <div id="columnList" class="column-list"></div>
            </div>
          </div>

          <button id="btnAddColumn" class="btn warning">➕ Add Column</button>
        </div>
      </div>

      <div id="grid" class="ag-theme-alpine"></div>

      <div class="statusbar">
        <div class="grid-stats">
          <div class="grid-stat"><span>Rows:</span> <strong id="rowCount">0</strong></div>
          <div class="grid-stat"><span>Selected:</span> <strong id="selectedCount">0</strong></div>
          <div class="grid-stat"><span>Filtered:</span> <strong id="filteredCount">0</strong></div>
        </div>
        <div class="spacer"></div>
        <span id="userPill" class="pill">Not signed in</span>
        <span id="changesPill" class="pill">0 pending changes</span>
        <span id="statusPill" class="pill info">Ready</span>
      </div>
    </div>
  </div>

  <!-- Add Column Modal -->
  <div id="columnModal" class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="modal-title">Add New Column</h3>
        <button class="modal-close" onclick="closeColumnModal()">×</button>
      </div>

      <div class="form-row">
        <label class="form-label">Display Name</label>
        <input id="colDisplay" type="text" class="form-input" placeholder="e.g., Unit Price, Status, Due Date"/>
        <div class="form-help">This is how the column will appear in the grid</div>
      </div>

      <div class="form-row">
        <label class="form-label">Internal Name</label>
        <input id="colInternal" type="text" class="form-input" placeholder="Auto-generated from display name" disabled/>
        <div class="form-help">SharePoint internal field name (auto-generated)</div>
      </div>

      <div class="form-row">
        <label class="form-label">Column Type</label>
        <select id="colType" class="form-select">
          <option value="Text">Single line of text</option>
          <option value="Note">Multiple lines of text</option>
          <option value="Number">Number</option>
          <option value="Currency">Currency ($)</option>
          <option value="DateTime">Date and Time</option>
          <option value="Boolean">Yes/No (checkbox)</option>
          <option value="Choice">Choice (dropdown)</option>
          <option value="MultiChoice">Multiple choice (checkboxes)</option>
          <option value="URL">Hyperlink</option>
        </select>
      </div>

      <div class="form-row" id="choiceRow" style="display:none">
        <label class="form-label">Choices</label>
        <textarea id="colChoices" class="form-input" rows="4" placeholder="Enter each choice on a new line:&#10;Open&#10;In Progress&#10;Closed"></textarea>
        <div class="form-help">Enter one choice per line</div>
      </div>

      <div class="form-row" id="defaultRow">
        <label class="form-label">Default Value (optional)</label>
        <input id="colDefault" type="text" class="form-input" placeholder="Leave blank for no default"/>
      </div>

      <div class="form-row">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="colRequired" style="width:18px;height:18px"/>
          <span class="form-label" style="margin:0">Require that this column contains information</span>
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="closeColumnModal()">Cancel</button>
        <button id="btnCreateColumn" class="btn primary">Create Column</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    /* =============== CONFIG =============== */
    const CONFIG = {
      sharepoint: {
        tenant: 'roadandrescue.sharepoint.com',
        siteRelative: '/sites/rar',
        listTitle: 'BookAJobMaster'
      },
      msal: {
        auth: {
          clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
          authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
          redirectUri: window.location.origin + '/admin/jobs-edit'
        },
        cache: { cacheLocation: 'sessionStorage', storeAuthStateInCookie: true }
      },
      spoScopes: [`https://roadandrescue.sharepoint.com/AllSites.FullControl`],
      grid: {
        pagination: true,
        paginationPageSize: 100,
        animateRows: true,
        enableRangeSelection: true,
        enableCellChangeFlash: true,
        undoRedoCellEditing: true,
        undoRedoCellEditingLimit: 20,
        stopEditingWhenCellsLoseFocus: true,
        rowHeight: 54
      }
    };

    /* =============== STATE =============== */
    const state = {
      msalInstance: null,
      account: null,
      accessToken: null,
      gridApi: null,
      columnApi: null,
      originalData: [],
      pendingChanges: { updates: new Map(), creates: [], deletes: new Set() },
      columnDefs: [],
      viewFields: [],
      isDirty: false,
      listItemEntityType: null
    };

    /* =============== UTILS =============== */
    const $ = s => document.querySelector(s);
    function showToast(message, type='info'){
      const c = $('#toastContainer');
      const el = document.createElement('div');
      const icons = { success:'✓', error:'✖', warning:'⚠', info:'ℹ' };
      el.className = `toast ${type}`;
      el.innerHTML = `<span style="font-size:18px">${icons[type]||'ℹ'}</span>
        <span style="flex:1">${message}</span>
        <button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;font-size:18px">×</button>`;
      c.appendChild(el);
      setTimeout(()=>el.remove(),5000);
    }
    function setStatus(text, type='info'){ const p=$('#statusPill'); p.textContent=text; p.className=`pill ${type}`; }
    function updateChangeCount(){
      const count = state.pendingChanges.updates.size + state.pendingChanges.creates.length + state.pendingChanges.deletes.size;
      $('#changesPill').textContent = `${count} pending changes`;
      $('#changesPill').className = count>0 ? 'pill warning':'pill';
      $('#btnSave').disabled = count===0; $('#btnDiscard').disabled = count===0;
      state.isDirty = count>0; updateGridStats();
    }
    function updateGridStats(){
      if(!state.gridApi) return;
      $('#rowCount').textContent = state.gridApi.getDisplayedRowCount();
      $('#selectedCount').textContent = state.gridApi.getSelectedRows().length;
      const model = state.gridApi.getModel?.();
      const filtered = model?.getRowCount ? model.getRowCount() : state.gridApi.getDisplayedRowCount();
      $('#filteredCount').textContent = filtered;
    }
    function generateInternalName(display){ return display.replace(/[^a-zA-Z0-9]/g,''); }
    const odataQuote = s => String(s).replace(/'/g,"''");
    const spSiteUrl = path => `https://${CONFIG.sharepoint.tenant}${CONFIG.sharepoint.siteRelative}${path}`;
    const listRoot = () => spSiteUrl(`/_api/web/lists/getbytitle('${odataQuote(CONFIG.sharepoint.listTitle)}')`);

    /* =============== AUTH =============== */
    const canPopup = () => {
      const w = window.open('', '_blank', 'width=1,height=1,left=-10000,top=-10000');
      if (!w || w.closed || typeof w.closed === 'undefined') return false;
      w.close(); return true;
    };

    async function initAuth(){
      try{
        state.msalInstance = new msal.PublicClientApplication(CONFIG.msal);
        await state.msalInstance.initialize();

        const rr = await state.msalInstance.handleRedirectPromise();
        if (rr?.account) state.account = rr.account;

        const accounts = state.msalInstance.getAllAccounts();
        if (!state.account && accounts.length) state.account = accounts[0];

        if(state.account){
          $('#loginScreen').classList.add('hidden');
          $('#loadingScreen').classList.remove('hidden');
          $('#userPill').textContent = state.account.username || state.account.name || 'Signed in';
          await getAccessToken();
          await initializeApp();
          $('#loadingScreen').classList.add('hidden');
        }else{
          // show login overlay
          $('#loginScreen').classList.remove('hidden');
        }

        $('#btnLogin').onclick = async () => {
          const loginReq = { scopes: CONFIG.spoScopes, redirectStartPage: window.location.href };
          if (canPopup()){
            try{
              const res = await state.msalInstance.loginPopup(loginReq);
              state.account = res.account; $('#userPill').textContent = state.account.username || state.account.name || 'Signed in';
              $('#loginScreen').classList.add('hidden'); $('#loadingScreen').classList.remove('hidden');
              await getAccessToken(); await initializeApp(); $('#loadingScreen').classList.add('hidden');
            }catch(e){ showToast('Popup blocked or cancelled. Using redirect…','warning'); await state.msalInstance.loginRedirect(loginReq); }
          }else{
            await state.msalInstance.loginRedirect(loginReq);
          }
        };
      }catch(err){
        console.error('Auth init failed', err);
        showToast('Authentication failed. Refresh and try again.','error');
      }
    }

    async function getAccessToken(){
      const req = { scopes: CONFIG.spoScopes, account: state.account };
      try{
        const r = await state.msalInstance.acquireTokenSilent(req);
        state.accessToken = r.accessToken; return r.accessToken;
      }catch(_){
        // fallback: popup if possible else redirect
        if (canPopup()){
          const r = await state.msalInstance.acquireTokenPopup(req);
          state.accessToken = r.accessToken; return r.accessToken;
        }
        await state.msalInstance.acquireTokenRedirect({ ...req, redirectStartPage: window.location.href });
      }
    }

    /* =============== SHAREPOINT REST =============== */
    async function spRequest(url, options={}){
      const r = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${state.accessToken}`,
          'Accept': options.accept || 'application/json;odata=nometadata',
          ...options.headers
        }
      });
      if(!r.ok){
        const t = await r.text().catch(()=> '');
        throw new Error(`SharePoint API error: ${r.status} ${r.statusText} ${t}`);
      }
      if(r.status === 204) return null;
      const ct = r.headers.get('content-type') || '';
      return ct.includes('application/json') ? r.json() : r.text();
    }

    async function getListItemEntityType(){
      if (state.listItemEntityType) return state.listItemEntityType;
      const info = await spRequest(`${listRoot()}?$select=ListItemEntityTypeFullName`);
      state.listItemEntityType = info.ListItemEntityTypeFullName;
      return state.listItemEntityType;
    }

    // Fast, view-aware read
    async function loadListData(){
      setStatus('Loading data...','info');
      const body = {
        parameters: {
          RenderOptions: 570,
          ViewXml: '<View><RowLimit>5000</RowLimit><Query><OrderBy><FieldRef Name="Created" Ascending="FALSE"/></OrderBy></Query></View>'
        }
      };
      return spRequest(`${listRoot()}/RenderListDataAsStream`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json;odata=verbose' },
        body: JSON.stringify(body),
        accept: 'application/json;odata=verbose'
      });
    }

    async function loadFieldsSchemaOnly(){
      const data = await spRequest(`${listRoot()}/fields?$select=Title,InternalName,TypeAsString,Hidden,ReadOnlyField,Sealed,Choices`);
      const arr = data.value || data.d?.results || [];
      return arr.map(f => ({
        Name: f.InternalName,
        DisplayName: f.Title,
        Type: f.TypeAsString,
        Hidden: !!f.Hidden,
        ReadOnlyField: !!f.ReadOnlyField,
        Sealed: !!f.Sealed,
        Choices: Array.isArray(f.Choices?.results) ? f.Choices.results : f.Choices
      }));
    }

    async function createItem(fieldBag){
      const entityType = await getListItemEntityType();
      const payload = { '__metadata': { 'type': entityType }, ...fieldBag };
      return spRequest(`${listRoot()}/items`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json;odata=verbose' },
        body: JSON.stringify(payload),
        accept: 'application/json;odata=verbose'
      });
    }

    async function updateItem(id, updates){
      const entityType = await getListItemEntityType();
      const payload = { '__metadata': { 'type': entityType }, ...updates };
      await spRequest(`${listRoot()}/items(${id})`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json;odata=verbose','IF-MATCH':'*','X-HTTP-Method':'MERGE' },
        body: JSON.stringify(payload)
      });
    }

    async function deleteItem(id){
      await spRequest(`${listRoot()}/items(${id})`, {
        method:'POST',
        headers:{ 'IF-MATCH':'*','X-HTTP-Method':'DELETE' }
      });
    }

    async function addField(cfg){
      const base = { Title: cfg.displayName, Required: !!cfg.required };
      let body;
      switch(cfg.type){
        case 'Number':     body={...base,'__metadata':{type:'SP.FieldNumber'},     FieldTypeKind:9};  break;
        case 'Currency':   body={...base,'__metadata':{type:'SP.FieldCurrency'},   FieldTypeKind:10, CurrencyLocaleId:1033}; break;
        case 'DateTime':   body={...base,'__metadata':{type:'SP.FieldDateTime'},   FieldTypeKind:4,  DisplayFormat:1}; break;
        case 'Boolean':    body={...base,'__metadata':{type:'SP.Field'},           FieldTypeKind:8};  break;
        case 'Choice':     body={...base,'__metadata':{type:'SP.FieldChoice'},     FieldTypeKind:6,  Choices:{results:cfg.choices||[]}}; break;
        case 'MultiChoice':body={...base,'__metadata':{type:'SP.FieldMultiChoice'},FieldTypeKind:15, Choices:{results:cfg.choices||[]}}; break;
        case 'URL':        body={...base,'__metadata':{type:'SP.FieldUrl'},        FieldTypeKind:11}; break;
        case 'Note':       body={...base,'__metadata':{type:'SP.FieldMultiLineText'},FieldTypeKind:3}; break;
        default:           body={...base,'__metadata':{type:'SP.FieldText'},       FieldTypeKind:2};
      }
      if(cfg.defaultValue) body.DefaultValue = cfg.defaultValue;

      return spRequest(`${listRoot()}/fields`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json;odata=verbose' },
        body: JSON.stringify(body),
        accept: 'application/json;odata=verbose'
      });
    }

    /* =============== GRID =============== */
    function humanizeHeader(h){
      return String(h).replace(/_x0020_/g,' ').replace(/([A-Z])/g,' $1').replace(/^\s+/,'').trim();
    }

    function buildColumnDefs(schemaFields){
      const visible = (schemaFields || []).filter(f => !f.Hidden);
      state.viewFields = visible.map(f => f.Name);

      const defs = [
        { headerName:'', field:'__selection__', checkboxSelection:true, headerCheckboxSelection:true, width:50, pinned:'left', lockPosition:true, suppressMenu:true },
        { headerName:'ID', field:'ID', width:90, pinned:'left', editable:false, cellStyle:{ fontWeight:'bold' } }
      ];

      visible.forEach(field => {
        if(field.Name === 'ID') return;
        const type = String(field.Type || field.TypeAsString || '').toLowerCase();
        const col = {
          headerName: field.DisplayName || field.Title || field.Name,
          field: field.Name,
          editable: !field.ReadOnlyField && !field.Sealed,
          sortable: true, filter: true, resizable: true,
          minWidth: 110, flex: 1
        };
        if(type.includes('number') || type.includes('currency')){
          col.filter = 'agNumberColumnFilter';
          col.valueParser = p => { const v=p.newValue; return v===''||v==null?null:Number(v); };
        }
        if(type.includes('datetime')){
          col.filter = 'agDateColumnFilter';
          col.valueFormatter = p => {
            if (!p.value) return '';
            const d = new Date(p.value);
            return isNaN(d) ? p.value : d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
          };
          col.minWidth = Math.max(col.minWidth, 160);
        }
        if(type.includes('boolean')){
          col.cellRenderer = p => (p.value ? '✓' : '✗');
          col.cellEditor = 'agSelectCellEditor';
          col.cellEditorParams = { values:[true,false] };
          col.minWidth = Math.max(col.minWidth, 110);
        }
        if(type.includes('choice') && field.Choices){
          const choices = Array.isArray(field.Choices?.results) ? field.Choices.results : field.Choices;
          if(Array.isArray(choices) && choices.length){
            col.cellEditor = 'agSelectCellEditor';
            col.cellEditorParams = { values: choices };
          }
        }
        const lname = String(field.Name || '').toLowerCase();
        if (/notes?|description|comment|details?/.test(lname)){
          col.autoHeight = true; col.wrapText = true; col.minWidth = 240; col.flex = Math.max(col.flex, 2);
        }
        defs.push(col);
      });
      return defs;
    }

    function initGrid(columnDefs, rowData){
      const gridOptions = {
        ...CONFIG.grid,
        columnDefs,
        rowData,
        defaultColDef: { flex:1, minWidth:100, resizable:true, sortable:true, filter:true },
        rowSelection: 'multiple',
        onCellValueChanged,
        onSelectionChanged: updateGridStats,
        onFilterChanged: updateGridStats,
        onSortChanged: updateGridStats,
        onGridReady: p => { state.gridApi = p.api; state.columnApi = p.columnApi; updateGridStats(); populateColumnMenu(); },
        onColumnVisible: populateColumnMenu
      };
      new agGrid.Grid(document.getElementById('grid'), gridOptions);
    }

    function onCellValueChanged(params){
      const id = params.data.ID;
      if(String(id).startsWith('NEW_')){
        params.data[params.colDef.field] = params.newValue;
      }else{
        const updates = state.pendingChanges.updates.get(id) || {};
        updates[params.colDef.field] = params.newValue;
        state.pendingChanges.updates.set(id, updates);
      }
      updateChangeCount();
    }

    /* =============== APP FLOW =============== */
    async function initializeApp(){
      try{
        setStatus('Loading list data...','info');

        const listData = await loadListData();

        // Schema (RLDAS or fallback to /fields)
        let schemaFields = Array.isArray(listData?.ListSchema?.Field)
          ? listData.ListSchema.Field.map(f => ({
              Name: f.Name ?? f.InternalName ?? f.StaticName,
              DisplayName: f.DisplayName ?? f.Title ?? f.Name,
              Type: f.Type ?? f.TypeAsString,
              Hidden: !!f.Hidden,
              ReadOnlyField: !!f.ReadOnlyField,
              Sealed: !!f.Sealed,
              Choices: f.Choices
            }))
          : await loadFieldsSchemaOnly();

        const columnDefs = buildColumnDefs(schemaFields);

        // Rows
        const rowData = Array.isArray(listData?.Row)
          ? listData.Row.map(r => ({ ...r }))
          : Array.isArray(listData?.ListData?.Rows)
            ? listData.ListData.Rows.map(r => ({ ...r }))
            : [];

        state.columnDefs = columnDefs;
        state.originalData = JSON.parse(JSON.stringify(rowData));

        initGrid(columnDefs, rowData);
        setupEventHandlers();

        setStatus(`Loaded ${rowData.length} rows`,'success');
        showToast(`Loaded ${rowData.length} rows from SharePoint`,'success');
      }catch(err){
        console.error('Init failed:', err);
        setStatus('Failed to load data','error');
        showToast('Failed to load data from SharePoint. Please refresh.','error');
      }
    }

    function populateColumnMenu(){
      const list = $('#columnList');
      if (!state.columnApi) return;
      list.innerHTML = '';
      state.columnDefs.forEach(cd=>{
        if (!cd.field || cd.field === '__selection__') return;
        const id = `colvis_${cd.field}`;
        const colState = state.columnApi.getColumn(cd.field);
        const visible = colState ? colState.isVisible() !== false : true;

        const row = document.createElement('label');
        row.className = 'column-item';
        row.style.cursor = 'pointer';
        row.innerHTML = `
          <input type="checkbox" id="${id}" class="column-checkbox" ${visible ? 'checked' : ''} />
          <span>${cd.headerName}</span>
        `;
        row.querySelector('input').onchange = (e)=> state.columnApi.setColumnVisible(cd.field, e.target.checked);
        list.appendChild(row);
      });
    }

    function setupEventHandlers(){
      $('#btnRefresh').onclick = () => {
        if(state.isDirty && !confirm('You have unsaved changes. Refresh anyway?')) return;
        window.location.reload();
      };
      $('#btnAddRow').onclick = () => {
        const newRow = { ID: `NEW_${Date.now()}`, Title: 'New Job' };
        state.pendingChanges.creates.push(newRow);
        state.gridApi.applyTransaction({ add: [newRow], addIndex: 0 });
        updateChangeCount(); showToast('New row added','info');
      };
      $('#btnBulkActions').onclick = () => { $('#bulkMenu').classList.toggle('show'); };
      $('#btnDeleteSelected').onclick = () => {
        const sel = state.gridApi.getSelectedRows();
        if(sel.length===0){ showToast('No rows selected','warning'); return; }
        if(!confirm(`Delete ${sel.length} selected rows?`)) return;
        sel.forEach(row=>{
          if(String(row.ID).startsWith('NEW_')){
            state.pendingChanges.creates = state.pendingChanges.creates.filter(r=>r.ID!==row.ID);
          }else{
            state.pendingChanges.deletes.add(row.ID);
          }
        });
        state.gridApi.applyTransaction({ remove: sel });
        updateChangeCount(); showToast(`${sel.length} rows marked for deletion`,'warning');
        $('#bulkMenu').classList.remove('show');
      };
      $('#btnDuplicateSelected').onclick = () => {
        const sel = state.gridApi.getSelectedRows();
        if(sel.length===0){ showToast('No rows selected','warning'); return; }
        const copies = sel.map(r=>{ const c={...r}; c.ID=`NEW_${Date.now()}_${Math.random()}`; delete c.__selection__; state.pendingChanges.creates.push(c); return c; });
        state.gridApi.applyTransaction({ add: copies });
        updateChangeCount(); showToast(`${copies.length} rows duplicated`,'success');
        $('#bulkMenu').classList.remove('show');
      };
      $('#btnExportSelected').onclick = () => {
        const sel = state.gridApi.getSelectedRows();
        if(sel.length===0){ showToast('No rows selected','warning'); return; }
        exportToCSV(sel, 'jobs_selected');
        $('#bulkMenu').classList.remove('show');
      };
      $('#btnExportAll').onclick = () => {
        const rows = [];
        state.gridApi.forEachNode(n => rows.push(n.data));
        if(!rows.length){ showToast('No data to export','warning'); return; }
        exportToCSV(rows, 'jobs_all');
        $('#bulkMenu').classList.remove('show');
      };
      $('#btnSave').onclick = saveChanges;
      $('#btnDiscard').onclick = () => {
        if(!confirm('Discard all pending changes?')) return;
        state.pendingChanges.updates.clear(); state.pendingChanges.creates=[]; state.pendingChanges.deletes.clear();
        state.gridApi.setRowData(JSON.parse(JSON.stringify(state.originalData)));
        updateChangeCount(); showToast('Changes discarded','info');
      };
      $('#quickSearch').oninput = e => state.gridApi.setQuickFilter(e.target.value);
      $('#btnColumnConfig').onclick = () => { $('#columnMenu').classList.toggle('show'); };
      $('#btnAddColumn').onclick = () => { $('#columnModal').classList.add('active'); };
      $('#colDisplay').oninput = e => { $('#colInternal').value = generateInternalName(e.target.value); };
      $('#colType').onchange = e => { const choice = e.target.value==='Choice' || e.target.value==='MultiChoice'; $('#choiceRow').style.display = choice?'block':'none'; };
      $('#btnCreateColumn').onclick = createColumn;

      document.querySelectorAll('.modal').forEach(m => m.onclick = e => { if(e.target===m) m.classList.remove('active'); });
      document.addEventListener('click', e => {
        if(!e.target.closest('.bulk-actions')) $('#bulkMenu').classList.remove('show');
        if(!e.target.closest('.column-config')) $('#columnMenu').classList.remove('show');
      });
      window.addEventListener('beforeunload', e => { if(state.isDirty){ e.preventDefault(); e.returnValue=''; } });
    }

    async function saveChanges(){
      try{
        setStatus('Saving changes...','info');
        $('#btnSave').disabled = true;
        let ok=0, err=0;
        const idMap = new Map(); // tempId -> realId

        // CREATES
        for(const newRow of state.pendingChanges.creates){
          try{
            const payload = {...newRow};
            const tempId = payload.ID;
            delete payload.ID; delete payload.__selection__;
            const created = await createItem(payload);
            const createdWrap = created?.d || created;
            const realId = createdWrap?.ID || createdWrap?.Id;
            if (realId){
              idMap.set(tempId, realId);
              // update displayed row ID
              let targetNode = null;
              state.gridApi.forEachNode(n => { if (n.data.ID === tempId) targetNode = n; });
              if (targetNode){
                targetNode.setData({
                  ...targetNode.data,
                  ID: realId,
                  Created: createdWrap.Created || targetNode.data.Created,
                  Modified: createdWrap.Modified || targetNode.data.Modified,
                });
              }
            }
            ok++;
          }catch(e){ console.error('Create failed',e); err++; }
        }

        // UPDATES
        for(const [id, updates] of state.pendingChanges.updates.entries()){
          try{
            const realId = idMap.get(id) || id;
            await updateItem(realId, updates);
            ok++;
          }catch(e){ console.error('Update failed',e); err++; }
        }

        // DELETES
        for(const id of state.pendingChanges.deletes){
          try{
            const realId = idMap.get(id) || id;
            await deleteItem(realId);
            ok++;
          }catch(e){ console.error('Delete failed',e); err++; }
        }

        state.pendingChanges.updates.clear(); state.pendingChanges.creates=[]; state.pendingChanges.deletes.clear();

        const allRows=[]; state.gridApi.forEachNode(n => allRows.push(n.data));
        state.originalData = JSON.parse(JSON.stringify(allRows));
        updateChangeCount();

        if(err>0){ setStatus(`Saved with ${err} errors`,'warning'); showToast(`Saved ${ok} changes, ${err} failed`,'warning'); }
        else{ setStatus('All changes saved','success'); showToast(`Successfully saved ${ok} changes`,'success'); }
      }catch(e){
        console.error('Save failed', e);
        setStatus('Save failed','error'); showToast('Failed to save changes. Please try again.','error');
      }finally{ $('#btnSave').disabled = false; }
    }

    async function createColumn(){
      const displayName = $('#colDisplay').value.trim();
      const type = $('#colType').value;
      const required = $('#colRequired').checked;
      const defVal = $('#colDefault').value.trim();
      const choices = $('#colChoices').value.split('\n').map(s=>s.trim()).filter(Boolean);

      if(!displayName){ showToast('Please enter a display name','warning'); return; }
      if ((type === 'Choice' || type === 'MultiChoice') && !choices.length){
        showToast('Enter at least one choice','warning'); return;
      }

      try{
        setStatus('Creating column...','info');
        await addField({ displayName, type, required, defaultValue: defVal || undefined, choices: choices.length?choices:undefined });
        closeColumnModal();
        showToast(`Column "${displayName}" created successfully`,'success');
        setTimeout(()=>{ if(confirm('Reload page to see the new column?')) window.location.reload(); }, 600);
      }catch(e){
        console.error('Add column failed', e);
        showToast('Failed to create column. Please try again.','error');
      }
    }

    function closeColumnModal(){
      $('#columnModal').classList.remove('active');
      $('#colDisplay').value=''; $('#colInternal').value=''; $('#colType').value='Text';
      $('#colRequired').checked=false; $('#colDefault').value=''; $('#colChoices').value=''; $('#choiceRow').style.display='none';
    }

    function exportToCSV(rows, basename){
      if(!rows.length){ showToast('No data to export','warning'); return; }
      const headers = Object.keys(rows[0]).filter(k=>k!=='__selection__');
      const csv = [headers.join(','), ...rows.map(r => headers.map(h => {
        let v = r[h]; if (v==null) v = '';
        v = String(v).replace(/"/g,'""');
        return (v.includes(',')||v.includes('"')||v.includes('\n')) ? `"${v}"` : v;
      }).join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv'}), url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`${basename}_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      showToast(`Exported ${rows.length} rows`,'success');
    }

    /* =============== BOOT =============== */
    window.addEventListener('DOMContentLoaded', initAuth);
  </script>
</body>
</html>
