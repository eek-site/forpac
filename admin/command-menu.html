<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FP Command Menu</title>

<!-- Microsoft Authentication Library -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#fff;height:100vh;overflow:hidden;width:100vw}
.loading{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999}
.loading.authenticated{display:none}
.spinner{width:40px;height:40px;border:3px solid #e2e8f0;border-top:3px solid #1e3c72;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:15px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:#718096;font-size:14px}
.menu-container{display:none;width:100vw;height:100vh;overflow:hidden}
.menu-container.authenticated{display:block}
.header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:12px 16px;font-size:14px;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid rgba(255,255,255,0.1);width:100%;box-sizing:border-box}
.header-title{font-size:16px;font-weight:700}
.header-hint{font-size:12px;opacity:0.9}

/* Grid that never requires horizontal scrolling */
.grid{
    display:grid;
    gap:3px;
    padding:12px;
    height:calc(100vh - 60px);
    overflow-y:auto;
    overflow-x:hidden;
    width:100%;
    box-sizing:border-box;
    grid-auto-flow:column;
}

.item{
    background:#f8fafc;
    border:1px solid #e2e8f0;
    border-radius:6px;
    padding:10px 12px;
    cursor:pointer;
    transition:all .2s ease;
    display:flex;
    align-items:flex-start;
    gap:10px;
    font-size:13px;
    min-height:60px;
    width:100%;
    min-width:0;
    box-sizing:border-box;
    text-decoration:none;
    color:#2d3748;
}

.item:hover{
    background:#1e3c72;
    color:#fff;
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(30,60,114,.3);
    text-decoration:none;
}

.num{
    background:#fff;
    border:1px solid #e2e8f0;
    border-radius:4px;
    width:28px;
    height:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:monospace;
    font-weight:700;
    font-size:11px;
    flex-shrink:0;
    color:#2d3748;
    margin-top:2px;
}

.item:hover .num{
    background:rgba(255,255,255,.95);
    color:#1e3c72;
}

.icon{
    font-size:18px;
    flex-shrink:0;
    width:20px;
    text-align:center;
    margin-top:4px;
}

.name{
    font-weight:500;
    line-height:1.4;
    flex:1;
    white-space:normal;
    word-wrap:break-word;
    overflow-wrap:break-word;
    hyphens:auto;
    min-width:0;
    padding-top:4px;
}

.cmd{
    position:fixed;
    bottom:12px;
    left:50%;
    transform:translateX(-50%);
    background:#1e3c72;
    color:#fff;
    padding:8px 16px;
    border-radius:6px;
    font-family:monospace;
    font-size:13px;
    font-weight:600;
    display:none;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    max-width:calc(100vw - 24px);
    text-align:center;
}

.cmd.show{display:block}

/* Desktop and large screens - 3 columns max */
@media (min-width: 768px) {
    .grid {
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(11, minmax(60px, 1fr));
    }
    .item {
        min-height:50px;
        padding:8px 10px;
    }
    .num {
        width:26px;
        height:26px;
    }
    .icon {
        font-size:16px;
        width:18px;
        margin-top:2px;
    }
    .name {
        padding-top:2px;
    }
}

/* Small tablets and large phones - 2 columns */
@media (min-width: 480px) and (max-width: 767px) {
    .grid {
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(16, minmax(65px, 1fr));
    }
    .item {
        font-size: 12px;
        padding: 8px 10px;
        min-height: 65px;
        gap: 8px;
    }
    .num {
        width: 26px;
        height: 26px;
        font-size: 10px;
    }
    .name {
        font-size: 12px;
        line-height: 1.3;
    }
}

/* Small phones - 1 column only */
@media (max-width: 479px) {
    .grid {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(31, minmax(50px, auto));
        grid-auto-flow: row;
    }
    .item {
        font-size: 13px;
        padding: 12px 14px;
        min-height: 50px;
        gap: 12px;
        align-items: center;
    }
    .header-hint {
        display: none;
    }
    .num {
        width: 30px;
        height: 30px;
        font-size: 12px;
        margin-top: 0;
    }
    .icon {
        font-size: 18px;
        width: 20px;
        margin-top: 0;
    }
    .name {
        padding-top: 0;
        font-size: 13px;
    }
}

/* Ultra-narrow screens */
@media (max-width: 320px) {
    .grid {
        padding: 8px;
        gap: 2px;
    }
    .item {
        padding: 10px 12px;
        gap: 10px;
        font-size: 12px;
        min-height: 48px;
    }
    .num {
        width: 26px;
        height: 26px;
        font-size: 10px;
    }
    .name {
        font-size: 12px;
    }
}
</style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading" id="loadingScreen">
  <div class="spinner"></div>
  <div class="loading-text">Verifying access...</div>
</div>

<!-- Menu Container -->
<div class="menu-container" id="menuContainer">
<div class="header">
<span class="header-title">Service Management Menu</span>
<span class="header-hint">Type number + Enter or click</span>
</div>
<div class="grid">
<a href="mark-dnc-job.html" class="item" data-number="0"><div class="num">0</div><div class="icon">ğŸš«</div><div class="name">Mark DNC Job</div></a>
<a href="triage-form.html" class="item" data-number="1"><div class="num">1</div><div class="icon">ğŸ”</div><div class="name">Triage Form</div></a>
<a href="booking-form.html" class="item" data-number="2"><div class="num">2</div><div class="icon">ğŸ“…</div><div class="name">Booking Form</div></a>
<a href="payment-gateway.html" class="item" data-number="3"><div class="num">3</div><div class="icon">ğŸ’³</div><div class="name">Send Payment Gateway</div></a>
<a href="add-supplier.html" class="item" data-number="4"><div class="num">4</div><div class="icon">â•</div><div class="name">Add Supplier</div></a>
<a href="update-job.html" class="item" data-number="5"><div class="num">5</div><div class="icon">âœï¸</div><div class="name">Update Job</div></a>
<a href="customer-address.html" class="item" data-number="6"><div class="num">6</div><div class="icon">ğŸ—ºï¸</div><div class="name">Open Customer Address</div></a>
<a href="customer-reply.html" class="item" data-number="7"><div class="num">7</div><div class="icon">ğŸ’¬</div><div class="name">Customer Reply</div></a>
<a href="call-customer.html" class="item" data-number="8"><div class="num">8</div><div class="icon">ğŸ“</div><div class="name">Call Customer</div></a>
<a href="send-job-supplier.html" class="item" data-number="9"><div class="num">9</div><div class="icon">ğŸ“¤</div><div class="name">Send Job to Supplier</div></a>
<a href="message-supplier.html" class="item" data-number="10"><div class="num">10</div><div class="icon">âœ‰ï¸</div><div class="name">Send Message To Supplier</div></a>
<a href="call-supplier.html" class="item" data-number="11"><div class="num">11</div><div class="icon">ğŸ“</div><div class="name">Call Supplier</div></a>
<a href="update-supplier.html" class="item" data-number="12"><div class="num">12</div><div class="icon">ğŸ‘¤</div><div class="name">Update Supplier Details</div></a>
<a href="driver-enroute.html" class="item" data-number="13"><div class="num">13</div><div class="icon">ğŸš—</div><div class="name">Driver en route</div></a>
<a href="revised-eta.html" class="item" data-number="14"><div class="num">14</div><div class="icon">â°</div><div class="name">Revised ETA</div></a>
<a href="cancellation.html" class="item" data-number="15"><div class="num">15</div><div class="icon">âŒ</div><div class="name">Cancellation</div></a>
<a href="bad-debt-notice.html" class="item" data-number="16"><div class="num">16</div><div class="icon">âš ï¸</div><div class="name">Bad Debt Notice</div></a>
<a href="job-complete.html" class="item" data-number="17"><div class="num">17</div><div class="icon">âœ…</div><div class="name">Job Complete</div></a>
<a href="close-job.html" class="item" data-number="18"><div class="num">18</div><div class="icon">ğŸ”’</div><div class="name">Close Job</div></a>
<a href="send-invoice.html" class="item" data-number="19"><div class="num">19</div><div class="icon">ğŸ§¾</div><div class="name">Send Invoice</div></a>
<a href="complaint-response.html" class="item" data-number="20"><div class="num">20</div><div class="icon">ğŸ“</div><div class="name">Complaint Response</div></a>
<a href="anz-batch-file.html" class="item" data-number="21"><div class="num">21</div><div class="icon">ğŸ“„</div><div class="name">Generate ANZ Batch File</div></a>
<a href="add-blacklist.html" class="item" data-number="22"><div class="num">22</div><div class="icon">ğŸš«</div><div class="name">Add to Blacklist</div></a>
<a href="api-call-menu.html" class="item" data-number="23"><div class="num">23</div><div class="icon">âš™ï¸</div><div class="name">API Call Menu</div></a>
<a href="profit-loss.html" class="item" data-number="24"><div class="num">24</div><div class="icon">ğŸ“Š</div><div class="name">Profit and Loss</div></a>
<a href="customer-refund.html" class="item" data-number="25"><div class="num">25</div><div class="icon">ğŸ’°</div><div class="name">Generate Refund File</div></a>
<a href="stripe-updates.html" class="item" data-number="26"><div class="num">26</div><div class="icon">ğŸ”„</div><div class="name">Run Stripe Updates</div></a>
<a href="update-job-address.html" class="item" data-number="27"><div class="num">27</div><div class="icon">ğŸš—</div><div class="name">Update Job Address</div></a>
<a href="location-request.html" class="item" data-number="28"><div class="num">28</div><div class="icon">ğŸ“</div><div class="name">Send Location Request</div></a>
<a href="prepurchase-inspection.html" class="item" data-number="29"><div class="num">29</div><div class="icon">ğŸ”</div><div class="name">Prepurchase Inspection</div></a>
<a href="send-manual-text.html" class="item" data-number="30"><div class="num">30</div><div class="icon">ğŸ’¬</div><div class="name">Send Manual Text</div></a>
</div>
<div id="commandDisplay" class="cmd"></div>
</div>

<script>
// MSAL Configuration (same as other admin pages)
let msalInstance = null;

const msalConfig = {
  auth: {
    clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
    authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
    redirectUri: window.location.origin + '/admin'
  },
  cache: {
    cacheLocation: 'sessionStorage',
    storeAuthStateInCookie: true  // Important for iframe contexts
  },
  system: {
    allowNativeBroker: false,  // Disable native broker in iframe
    windowHashTimeout: 10000,
    iframeHashTimeout: 10000
  }
};

async function initAuth(){
  try{
    if(!window.msal || !window.msal.PublicClientApplication){
      console.error('MSAL failed to load.');
      return false;
    }

    msalInstance = new msal.PublicClientApplication(msalConfig);
    const redirectResponse = await msalInstance.handleRedirectPromise();
    if (redirectResponse && redirectResponse.account){
      msalInstance.setActiveAccount(redirectResponse.account);
    }

    const active = msalInstance.getActiveAccount();
    const accounts = msalInstance.getAllAccounts();
    const account = active || accounts[0];

    if (account){
      msalInstance.setActiveAccount(account);
      return true;
    } else {
      return false;
    }
  } catch (e){
    console.error('Auth init error:', e);
    return false;
  }
}

function showMenu(){
  document.getElementById('loadingScreen').classList.add('authenticated');
  document.getElementById('menuContainer').classList.add('authenticated');
}

function showUnauthorized(){
  // If not authenticated, close the menu
  if(window.parent !== window){
    window.parent.postMessage({type:'fp-close-menu'},'*');
  } else if(window.opener){
    window.close();
  }
}

// Menu functionality for keyboard navigation
const pages = {
  '0': 'mark-dnc-job.html',
  '1': 'triage-form.html',
  '2': 'booking-form.html',
  '3': 'payment-gateway.html',
  '4': 'add-supplier.html',
  '5': 'update-job.html',
  '6': 'customer-address.html',
  '7': 'customer-reply.html',
  '8': 'call-customer.html',
  '9': 'send-job-supplier.html',
  '10': 'message-supplier.html',
  '11': 'call-supplier.html',
  '12': 'update-supplier.html',
  '13': 'driver-enroute.html',
  '14': 'revised-eta.html',
  '15': 'cancellation.html',
  '16': 'bad-debt-notice.html',
  '17': 'job-complete.html',
  '18': 'close-job.html',
  '19': 'send-invoice.html',
  '20': 'complaint-response.html',
  '21': 'anz-batch-file.html',
  '22': 'add-blacklist.html',
  '23': 'api-call-menu.html',
  '24': 'profit-loss.html',
  '25': 'customer-refund.html',
  '26': 'stripe-updates.html',
  '27': 'update-job-address.html',
  '28': 'location-request.html',
  '29': 'prepurchase-inspection.html',
  '30': 'send-manual-text.html'
};

let c='';

function navigateToPage(pageNum) {
  const page = pages[pageNum];
  if (page) {
    window.location.href = page;
    return true;
  }
  return false;
}

function updateCommandDisplay() {
  const d = document.getElementById('commandDisplay');
  if (c) {
    const page = pages[c];
    if (page) {
      d.textContent = `Navigate to: ${page} (Press Enter)`;
    } else {
      d.textContent = `Command: ${c} (Press Enter or continue typing)`;
    }
    d.classList.add('show');
  } else {
    d.classList.remove('show');
  }
}

// Keyboard handling - requires Enter to navigate
document.addEventListener('keydown', function(ev) {
  if (ev.key >= '0' && ev.key <= '9') {
    ev.preventDefault();
    c += ev.key;
    updateCommandDisplay();
    return;
  }
  if (ev.key === 'Enter' && c) {
    ev.preventDefault();
    navigateToPage(c);
    return;
  }
  if (ev.key === 'Backspace') {
    ev.preventDefault();
    c = c.slice(0, -1);
    updateCommandDisplay();
    return;
  }
  if (ev.key === 'Escape') {
    c = '';
    updateCommandDisplay();
    if (window.parent !== window) {
      window.parent.postMessage({type:'fp-close-menu'}, '*');
    } else if (window.opener) {
      window.close();
    }
  }
});

// Initialize
window.addEventListener('DOMContentLoaded', async function(){
  const authenticated = await initAuth();
  if(authenticated){
    showMenu();
    // Focus for keyboard input
    document.body.focus();
    document.body.setAttribute('tabindex','0');
  } else {
    showUnauthorized();
  }
});
</script>
</body>
</html>
