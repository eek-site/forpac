<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Activity ‚Äî Edit | FormanPacific Service Claims Management</title>
  <meta name="description" content="Edit and manage job activity in SharePoint JobBuildNotes list">
  <meta name="robots" content="noindex, nofollow">

  <!-- MSAL -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <!-- AG Grid Community v31 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>

  <style>
    :root{
      --primary:#1e3c72;--primary-dark:#152a52;--secondary:#2a5298;
      --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;
      --text-primary:#1e293b;--text-secondary:#64748b;
      --border:#e2e8f0;--bg-light:#f8fafc;--bg-white:#ffffff;
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1);
      --shadow-xl:0 20px 25px -5px rgba(0,0,0,.1);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;
      color:var(--text-primary);
      background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);
      min-height:100vh;line-height:1.6;
    }
    header{position:sticky;top:0;z-index:100;background:var(--bg-white);box-shadow:var(--shadow-md);border-bottom:2px solid var(--border)}
    .header-inner{max-width:1600px;margin:0 auto;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:16px}
    .logo{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#fff;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:var(--shadow-md)}
    .brand-text h1{font-size:24px;color:var(--primary);margin:0;font-weight:700}
    .brand-text small{display:block;color:var(--text-secondary);font-size:14px;margin-top:2px}
    .header-actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:10px 20px;font-weight:600;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all .2s ease;text-decoration:none;white-space:nowrap}
    .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .btn.primary{background:var(--primary);color:#fff}.btn.primary:hover{background:var(--primary-dark)}
    .btn.secondary{background:var(--bg-light);color:var(--text-primary);border:2px solid var(--border)}
    .btn.secondary:hover{background:var(--border)}
    .btn.success{background:var(--success);color:#fff}.btn.success:hover{background:#059669}
    .btn.warning{background:var(--warning);color:#fff}.btn.warning:hover{background:#d97706}
    .btn.danger{background:var(--danger);color:#fff}.btn.danger:hover{background:#dc2626}
    .btn.info{background:var(--info);color:#fff}.btn.info:hover{background:#2563eb}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
    .container{max-width:1600px;margin:24px auto;padding:0 24px 40px}
    .panel{background:var(--bg-white);border-radius:16px;box-shadow:var(--shadow-lg);padding:24px;border:1px solid var(--border)}
    .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:20px;padding-bottom:20px;border-bottom:2px solid var(--border)}
    .toolbar-group{display:flex;gap:8px;align-items:center}
    .toolbar .spacer{flex:1}
    .pill{background:var(--bg-light);color:var(--text-primary);padding:6px 14px;border-radius:999px;font-size:13px;font-weight:500;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border)}
    .pill.success{background:#d1fae5;color:#065f46;border-color:#6ee7b7}
    .pill.warning{background:#fed7aa;color:#92400e;border-color:#fb923c}
    .pill.danger{background:#fee2e2;color:#991b1b;border-color:#fca5a5}
    .pill.info{background:#dbeafe;color:#1e40af;border-color:#93c5fd}
    .statusbar{display:flex;gap:12px;align-items:center;margin-top:20px;padding-top:20px;border-top:2px solid var(--border);flex-wrap:wrap}
    #grid{height:600px;width:100%;border:2px solid var(--border);border-radius:10px;overflow:hidden}
    .search-box{position:relative;flex:0 1 300px}
    .search-input{width:100%;border:2px solid var(--border);border-radius:10px;padding:8px 36px 8px 12px;font-size:14px;transition:all .2s ease}
    .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary);pointer-events:none}
    select{border:2px solid var(--border);border-radius:10px;padding:8px 12px;font-size:14px;background:var(--bg-white);cursor:pointer;transition:all .2s ease}
    select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .overlay-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
    .overlay-content{text-align:center;max-width:480px;padding:40px;background:var(--bg-white);border-radius:20px;box-shadow:var(--shadow-xl)}
    .spinner{width:60px;height:60px;border:4px solid var(--border);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s cubic-bezier(.68,-.55,.265,1.55) infinite;margin:0 auto 20px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none!important}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
    .modal.active{display:flex;animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal-card{background:var(--bg-white);border-radius:16px;width:560px;max-width:92vw;max-height:85vh;overflow-y:auto;padding:24px;box-shadow:var(--shadow-xl);animation:slideUp .3s ease}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--border)}
    .modal-title{font-size:20px;font-weight:700;color:var(--text-primary)}
    .modal-close{background:none;border:none;font-size:24px;color:var(--text-secondary);cursor:pointer;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .modal-close:hover{background:var(--bg-light);color:var(--text-primary)}
    .form-row{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-weight:500;color:var(--text-primary);font-size:14px}
    .form-input,.form-select,.form-textarea{width:100%;border:2px solid var(--border);border-radius:10px;padding:10px 14px;font-size:14px;transition:all .2s ease;font-family:inherit}
    .form-textarea{min-height:120px;resize:vertical}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .form-help{font-size:12px;color:var(--text-secondary);margin-top:4px}
    .modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:20px;border-top:2px solid var(--border)}
    .toast-container{position:fixed;top:20px;right:20px;z-index:9999}
    .toast{background:var(--bg-white);padding:14px 18px;border-radius:10px;box-shadow:var(--shadow-lg);margin-bottom:10px;display:flex;align-items:center;gap:12px;min-width:300px;animation:slideInRight .3s ease;border-left:4px solid}
    .toast.success{border-left-color:var(--success)}.toast.error{border-left-color:var(--danger)}.toast.warning{border-left-color:var(--warning)}.toast.info{border-left-color:var(--info)}
    @keyframes slideInRight{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
    .bulk-actions{position:relative;display:inline-block}
    .bulk-menu{position:absolute;top:100%;left:0;margin-top:8px;background:var(--bg-white);border-radius:10px;box-shadow:var(--shadow-lg);border:1px solid var(--border);padding:8px;min-width:220px;display:none;z-index:50}
    .bulk-menu.show{display:block}
    .bulk-menu-item{padding:8px 12px;border-radius:6px;cursor:pointer;transition:background .2s ease;font-size:14px;display:flex;align-items:center;gap:8px}
    .bulk-menu-item:hover{background:var(--bg-light)}
    .bulk-menu-divider{height:1px;background:var(--border);margin:8px 0}
    .grid-stats{display:flex;gap:20px;align-items:center;font-size:13px;color:var(--text-secondary)}
    .grid-stat{display:flex;align-items:center;gap:4px}
    .grid-stat strong{color:var(--text-primary);font-weight:600}
    @media (max-width:768px){
      .header-inner{padding:12px 16px}
      .brand-text h1{font-size:20px}
      .container{padding:0 16px 24px;margin:16px auto}
      .panel{padding:16px}
      .toolbar{gap:8px}
      #grid{height:420px}
      .modal-card{width:95vw;padding:20px}
      .search-box{flex:1 1 100%}
    }
    @media (prefers-color-scheme:dark){
      :root{--bg-white:#0f172a;--bg-light:#1e293b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#334155}
      body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%)}
      .ag-theme-alpine{--ag-background-color:var(--bg-white);--ag-header-background-color:var(--bg-light);--ag-odd-row-background-color:var(--bg-light);--ag-border-color:var(--border)}
      .form-input,.form-select,.form-textarea,select{background:var(--bg-light);color:var(--text-primary)}
    }
  </style>
</head>
<body>
  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Login Screen -->
  <div id="loginScreen" class="overlay-screen">
    <div class="overlay-content">
      <div class="logo" style="margin:0 auto 20px;width:80px;height:80px;font-size:32px">FP</div>
      <h2 style="margin-bottom:12px;color:var(--text-primary)">Sign In Required</h2>
      <p style="color:var(--text-secondary);margin-bottom:24px">Access the Job Activity editor with your Microsoft work account.</p>
      <div class="pill info" style="margin:0 auto 24px;display:inline-flex"><span>üõ†Ô∏è</span> JobBuildNotes (SharePoint Live)</div>
      <button id="btnLogin" class="btn primary" style="font-size:16px;padding:12px 24px">Sign in with Microsoft</button>
      <p style="font-size:12px;color:var(--text-secondary);margin-top:16px">SharePoint permissions are enforced</p>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingScreen" class="overlay-screen hidden">
    <div class="overlay-content">
      <div class="spinner"></div>
      <h3 style="color:var(--text-primary)">Loading Job Activity</h3>
      <p style="color:var(--text-secondary);margin-top:8px">Connecting to SharePoint...</p>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo">FP</div>
        <div class="brand-text">
          <h1>FormanPacific <small>Activity Editor</small></h1>
          <small>üõ†Ô∏è JobBuildNotes (SharePoint Live)</small>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn secondary" onclick="location.href='/admin/dashboard'">‚Üê Dashboard</button>
        <button class="btn secondary" onclick="location.href='/admin/job-activity'">üëÅÔ∏è View Only</button>
        <button class="btn info" id="btnRefresh">üîÑ Refresh</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="panel">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="toolbar-group">
          <button id="btnAddRow" class="btn success">‚ûï Add Activity</button>

          <div class="bulk-actions">
            <button id="btnBulkActions" class="btn secondary">Bulk Actions ‚ñº</button>
            <div id="bulkMenu" class="bulk-menu">
              <div class="bulk-menu-item" id="btnDeleteSelected">üóëÔ∏è Delete Selected</div>
              <div class="bulk-menu-item" id="btnDuplicateSelected">üìã Duplicate Selected</div>
              <div class="bulk-menu-divider"></div>
              <div class="bulk-menu-item" id="btnExportSelected">üì• Export Selected</div>
              <div class="bulk-menu-item" id="btnExportAll">üì• Export All</div>
            </div>
          </div>

          <button id="btnSave" class="btn primary" disabled>üíæ Save Changes</button>
          <button id="btnDiscard" class="btn secondary" disabled>‚ùå Discard Changes</button>
        </div>

        <div class="spacer"></div>

        <div class="toolbar-group">
          <div class="search-box">
            <input type="text" id="quickSearch" class="search-input" placeholder="Quick search...">
            <span class="search-icon">üîç</span>
          </div>

          <div class="column-config" style="position:relative">
            <button id="btnColumnConfig" class="btn secondary">‚öôÔ∏è Columns</button>
            <div id="columnMenu" class="bulk-menu" style="right:0;left:auto;width:320px;max-height:400px;overflow:auto">
              <h4 style="margin:8px 8px 12px;font-size:14px">Visible Columns</h4>
              <div id="columnList" style="display:flex;flex-direction:column;gap:8px;padding:0 8px 8px"></div>
            </div>
          </div>

          <button id="btnAddColumn" class="btn warning">‚ûï Add Column</button>
          <button id="btnImport" class="btn warning">üì§ Import</button>
          <button id="btnExportAllTop" class="btn info">üì• Export All</button>
        </div>
      </div>

      <!-- Grid -->
      <div id="grid" class="ag-theme-alpine"></div>

      <!-- Status -->
      <div class="statusbar">
        <div class="grid-stats">
          <div class="grid-stat"><span>Rows:</span> <strong id="rowCount">0</strong></div>
          <div class="grid-stat"><span>Selected:</span> <strong id="selectedCount">0</strong></div>
          <div class="grid-stat"><span>Jobs Referenced:</span> <strong id="jobsReferenced">0</strong></div>
        </div>
        <div class="spacer"></div>
        <span id="userPill" class="pill">Not signed in</span>
        <span id="changesPill" class="pill">0 pending changes</span>
        <span id="statusPill" class="pill info">Ready</span>
      </div>
    </div>
  </div>

  <!-- Add/Edit Activity Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="modal-title" id="activityModalTitle">Add Activity</h3>
        <button class="modal-close" onclick="closeActivityModal()">√ó</button>
      </div>

      <div class="form-row">
        <label class="form-label">Job Reference</label>
        <input id="actJobRef" type="text" class="form-input" placeholder="Job ID / Rego / Reference">
        <div class="form-help">Link this activity to a specific job</div>
      </div>

      <div class="form-row">
        <label class="form-label">Activity Type</label>
        <select id="actType" class="form-select">
          <option>Update</option><option>Call</option><option>Email</option>
          <option>Assignment</option><option>Follow-up</option>
          <option>Onsite</option><option>Resolution</option>
        </select>
      </div>

      <div class="form-row">
        <label class="form-label">Status</label>
        <select id="actStatus" class="form-select">
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Completed">Completed</option>
          <option value="Blocked">Blocked</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>

      <div class="form-row">
        <label class="form-label">Performed By</label>
        <input id="actUser" type="text" class="form-input" placeholder="Person or team">
      </div>

      <div class="form-row">
        <label class="form-label">Date & Time</label>
        <input id="actWhen" type="datetime-local" class="form-input">
      </div>

      <div class="form-row">
        <label class="form-label">Duration (mins)</label>
        <input id="actDuration" type="number" class="form-input" min="0" step="1" placeholder="Optional">
      </div>

      <div class="form-row">
        <label class="form-label">Cost</label>
        <input id="actCost" type="number" class="form-input" min="0" step="0.01" placeholder="Optional">
      </div>

      <div class="form-row">
        <label class="form-label">Notes</label>
        <textarea id="actNotes" class="form-textarea" placeholder="What happened? What changed?" rows="5"></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="closeActivityModal()">Cancel</button>
        <button id="btnSaveActivity" class="btn primary">Save Activity</button>
      </div>
    </div>
  </div>

  <!-- Add Column Modal -->
  <div id="columnModal" class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="modal-title">Add New Column</h3>
        <button class="modal-close" onclick="closeColumnModal()">√ó</button>
      </div>

      <div class="form-row">
        <label class="form-label">Display Name</label>
        <input id="colDisplay" type="text" class="form-input" placeholder="e.g., Activity Score">
        <div class="form-help">How the column will appear in the grid</div>
      </div>

      <div class="form-row">
        <label class="form-label">Internal Name</label>
        <input id="colInternal" type="text" class="form-input" placeholder="Auto-generated from display name" disabled>
        <div class="form-help">SharePoint internal name (auto-generated)</div>
      </div>

      <div class="form-row">
        <label class="form-label">Column Type</label>
        <select id="colType" class="form-select">
          <option value="Text">Single line of text</option>
          <option value="Note">Multiple lines of text</option>
          <option value="Number">Number</option>
          <option value="Currency">Currency ($)</option>
          <option value="DateTime">Date and Time</option>
          <option value="Boolean">Yes/No (checkbox)</option>
          <option value="Choice">Choice (dropdown)</option>
          <option value="MultiChoice">Multiple choice (checkboxes)</option>
          <option value="URL">Hyperlink</option>
        </select>
      </div>

      <div class="form-row" id="choiceRow" style="display:none">
        <label class="form-label">Choices</label>
        <textarea id="colChoices" class="form-textarea" rows="4" placeholder="One per line..."></textarea>
      </div>

      <div class="form-row" id="defaultRow">
        <label class="form-label">Default Value (optional)</label>
        <input id="colDefault" type="text" class="form-input" placeholder="Leave blank for none">
      </div>

      <div class="form-row">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="colRequired" style="width:18px;height:18px">
          <span class="form-label" style="margin:0">Require a value</span>
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="closeColumnModal()">Cancel</button>
        <button id="btnCreateColumn" class="btn primary">Create Column</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    // ===== CONFIG =====
    const CONFIG = {
      sharepoint: {
        tenant: 'roadandrescue.sharepoint.com',
        siteRelative: '/sites/rar',
        listTitle: 'JobBuildNotes'
      },
      msal: {
        auth: {
          clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
          authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
          redirectUri: window.location.origin + '/admin/job-activity-edit'
        },
        cache: { cacheLocation: 'sessionStorage', storeAuthStateInCookie: true }
      },
      grid: {
        pagination: true,
        paginationPageSize: 100,
        animateRows: true,
        enableCellChangeFlash: true,
        undoRedoCellEditing: true,
        undoRedoCellEditingLimit: 20,
        stopEditingWhenCellsLoseFocus: true,
        rowHeight: 54
      }
    };

    // ===== STATE =====
    const state = {
      msalInstance: null,
      account: null,
      accessToken: null,
      gridApi: null,
      originalData: [],
      pendingChanges: { updates:new Map(), creates:[], deletes:new Set() },
      columnDefs: [],
      viewFields: [],
      isDirty: false,
      currentActivity: null
    };

    // ===== UTILS =====
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    function showToast(message, type='info'){
      const container = $('#toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = {success:'‚úì',error:'‚úñ',warning:'‚ö†',info:'‚Ñπ'};
      toast.innerHTML = `<span style="font-size:18px">${icons[type]}</span><span style="flex:1">${message}</span><button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;font-size:18px">√ó</button>`;
      container.appendChild(toast);
      setTimeout(()=> toast.remove(), 5000);
    }

    function setStatus(text, type='info'){
      const pill = $('#statusPill');
      pill.textContent = text;
      pill.className = `pill ${type}`;
    }

    function updateChangeCount(){
      const count = state.pendingChanges.updates.size + state.pendingChanges.creates.length + state.pendingChanges.deletes.size;
      $('#changesPill').textContent = `${count} pending changes`;
      $('#changesPill').className = count ? 'pill warning' : 'pill';
      $('#btnSave').disabled = !count;
      $('#btnDiscard').disabled = !count;
      state.isDirty = !!count;
      updateGridStats();
    }

    function updateGridStats(){
      if (!state.gridApi) return;
      $('#rowCount').textContent = state.gridApi.getDisplayedRowCount();
      $('#selectedCount').textContent = state.gridApi.getSelectedRows().length;

      const jobs = new Set();
      state.gridApi.forEachNode(n => {
        const jref = n.data.JobReference || n.data.JobID || n.data.JobId || n.data.Rego || n.data.Rego2;
        if (jref) jobs.add(jref);
      });
      $('#jobsReferenced').textContent = jobs.size;
    }

    function generateInternalName(displayName){
      return displayName.replace(/[^a-zA-Z0-9]/g,'');
    }

    // ===== AUTH =====
    async function initAuth(){
      try{
        state.msalInstance = new msal.PublicClientApplication(CONFIG.msal);
        await state.msalInstance.initialize();

        const resp = await state.msalInstance.handleRedirectPromise();
        if (resp) { /* handled */ }

        const accounts = state.msalInstance.getAllAccounts();
        if (accounts.length){
          state.account = accounts[0];
          $('#loginScreen').classList.add('hidden');
          $('#loadingScreen').classList.remove('hidden');
          $('#userPill').textContent = state.account.username;

          await getAccessToken();
          await initializeApp();

          $('#loadingScreen').classList.add('hidden');
        }
      }catch(err){
        console.error('Auth init failed', err);
        showToast('Authentication failed. Please refresh and try again.','error');
      }
    }

    async function getAccessToken(){
      const scopes = [`https://${CONFIG.sharepoint.tenant}/AllSites.FullControl`];
      try{
        const r = await state.msalInstance.acquireTokenSilent({ scopes, account: state.account });
        state.accessToken = r.accessToken;
        return r.accessToken;
      }catch{
        const r = await state.msalInstance.acquireTokenPopup({ scopes });
        state.accessToken = r.accessToken;
        return r.accessToken;
      }
    }

    // ===== SP REST =====
    async function spRequest(url, options = {}, _retried = false){
      const resp = await fetch(url, {
        ...options,
        headers:{
          'Authorization': `Bearer ${state.accessToken}`,
          'Accept':'application/json;odata=nometadata',
          ...(options.headers || {})
        }
      });

      // Retry once if token expired
      if ((resp.status === 401 || resp.status === 403) && !_retried) {
        try { await getAccessToken(); } catch {}
        return spRequest(url, options, true);
      }

      if (!resp.ok){
        const errText = await resp.text().catch(()=> '');
        const e = new Error(`SharePoint API error: ${resp.status} ${resp.statusText} ${errText}`);
        e.status = resp.status;
        e.body = errText;
        throw e;
      }

      if (resp.status === 204) return null; // no content

      const contentType = resp.headers.get('Content-Type') || '';
      const text = await resp.text().catch(()=> '');
      if (!text) return null;

      if (contentType.includes('application/json')) {
        try { return JSON.parse(text); } catch { return null; }
      }
      return text;
    }

    function getSiteUrl(path=''){
      return `https://${CONFIG.sharepoint.tenant}${CONFIG.sharepoint.siteRelative}${path}`;
    }

    async function loadListData(){
      setStatus('Loading data...', 'info');
      const url = getSiteUrl(`/_api/web/lists/getbytitle('${encodeURIComponent(CONFIG.sharepoint.listTitle)}')/RenderListDataAsStream`);
      const body = {
        parameters:{
          RenderOptions: 570,
          ViewXml: '<View><RowLimit>5000</RowLimit><Query><OrderBy><FieldRef Name="Created" Ascending="FALSE"/></OrderBy></Query></View>'
        }
      };
      return spRequest(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;odata=verbose' },
        body: JSON.stringify(body)
      });
    }

    async function createItem(item){
      const url = getSiteUrl(`/_api/web/lists/getbytitle('${encodeURIComponent(CONFIG.sharepoint.listTitle)}')/items`);
      return spRequest(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;odata=nometadata' },
        body: JSON.stringify(item)
      });
    }

    async function updateItem(id, updates){
      const url = getSiteUrl(`/_api/web/lists/getbytitle('${encodeURIComponent(CONFIG.sharepoint.listTitle)}')/items(${id})`);
      await spRequest(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;odata=nometadata',
          'IF-MATCH': '*',
          'X-HTTP-Method': 'MERGE'
        },
        body: JSON.stringify(updates)
      });
    }

    async function deleteItem(id){
      const url = getSiteUrl(`/_api/web/lists/getbytitle('${encodeURIComponent(CONFIG.sharepoint.listTitle)}')/items(${id})`);
      await spRequest(url, {
        method: 'DELETE',
        headers: { 'IF-MATCH': '*' }
      });
    }

    async function addField(fieldConfig){
      const url = getSiteUrl(`/_api/web/lists/getbytitle('${encodeURIComponent(CONFIG.sharepoint.listTitle)}')/fields`);
      const common = { Title: fieldConfig.displayName, Required: !!fieldConfig.required };
      let body;
      switch(fieldConfig.type){
        case 'Number':
          body = { ...common, '__metadata':{ 'type':'SP.FieldNumber' },   FieldTypeKind: 9 };
          break;
        case 'Currency':
          body = { ...common, '__metadata':{ 'type':'SP.FieldCurrency' }, FieldTypeKind:10, CurrencyLocaleId:1033 };
          break;
        case 'DateTime':
          body = { ...common, '__metadata':{ 'type':'SP.FieldDateTime' }, FieldTypeKind: 4, DisplayFormat: 1 };
          break;
        case 'Boolean':
          body = { ...common, '__metadata':{ 'type':'SP.Field' },         FieldTypeKind: 8 };
          break;
        case 'Choice':
          body = { ...common, '__metadata':{ 'type':'SP.FieldChoice' },   FieldTypeKind: 6, Choices:{ results: fieldConfig.choices || [] } };
          break;
        case 'MultiChoice':
          body = { ...common, '__metadata':{ 'type':'SP.FieldMultiChoice' }, FieldTypeKind: 15, Choices:{ results: fieldConfig.choices || [] } };
          break;
        case 'URL':
          body = { ...common, '__metadata':{ 'type':'SP.FieldUrl' }, FieldTypeKind: 11 };
          break;
        case 'Note':
          body = { ...common, '__metadata':{ 'type':'SP.FieldMultiLineText' }, FieldTypeKind: 3 };
          break;
        default: // Text
          body = { ...common, '__metadata':{ 'type':'SP.FieldText' },     FieldTypeKind: 2 };
      }
      if (fieldConfig.defaultValue) body.DefaultValue = fieldConfig.defaultValue;

      return spRequest(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;odata=verbose' },
        body: JSON.stringify(body)
      });
    }

    // ===== GRID =====
    function buildColumnDefs(schemaFields){
      const fields = Array.isArray(schemaFields) ? schemaFields : [];
      const visible = fields.filter(f => !f.Hidden);
      state.viewFields = visible.map(f => f.Name);

      const getType = (f) => String(f.TypeAsString || f.Type || '').toLowerCase();
      const getChoices = (f) => Array.isArray(f.Choices) ? f.Choices
                           : Array.isArray(f.Choice)   ? f.Choice
                           : Array.isArray(f.Choices?.results) ? f.Choices.results
                           : [];

      const defs = [
        { headerName:'', field:'__selection__', checkboxSelection:true, headerCheckboxSelection:true, width:50, pinned:'left', lockPosition:true, suppressMenu:true },
        { headerName:'ID', field:'ID', width:90, pinned:'left', editable:false, cellStyle:{ fontWeight:'bold' } }
      ];

      visible.forEach(field=>{
        if (field.Name === 'ID') return;

        const type = getType(field);
        const cd = {
          headerName: field.Title || field.DisplayName || field.Name,
          field: field.InternalName || field.Name,
          editable: !field.ReadOnlyField && !field.Sealed,
          sortable:true, filter:true, resizable:true, minWidth:110, flex:1
        };

        if (type === 'number' || type === 'currency'){
          cd.filter = 'agNumberColumnFilter';
          cd.valueParser = p => {
            const v = p.newValue;
            const n = Number(v);
            return (v==='' || v==null || Number.isNaN(n)) ? null : n;
          };
        }

        if (type === 'datetime'){
          cd.filter = 'agDateColumnFilter';
          cd.valueFormatter = p => {
            if (!p.value) return '';
            const d = new Date(p.value);
            return isNaN(d) ? p.value : d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
          };
          cd.minWidth = Math.max(cd.minWidth || 110, 160);
        }

        if (type === 'boolean'){
          cd.cellRenderer = p => p.value ? '‚úì' : '‚úó';
          cd.cellEditor = 'agSelectCellEditor';
          cd.cellEditorParams = { values:[true,false] };
          cd.minWidth = Math.max(cd.minWidth || 110, 110);
        }

        if (type === 'choice' || type === 'multichoice'){
          const values = getChoices(field);
          if (values.length){
            cd.cellEditor = 'agSelectCellEditor';
            cd.cellEditorParams = { values };
          }
        }

        const lname = String(field.InternalName || field.Name || '').toLowerCase();
        if (/notes?|description|comment|details?/.test(lname)){
          cd.autoHeight = true; cd.wrapText = true; cd.minWidth = 240; cd.flex = Math.max(cd.flex, 2);
        }
        if (/job(id|reference)|rego/.test(lname)){
          cd.cellStyle = { color:'var(--primary)', fontWeight:'600' };
          cd.minWidth = Math.max(cd.minWidth || 110, 150);
        }
        if (type === 'text' && /activity|type/.test(lname)){
          cd.cellEditor = 'agSelectCellEditor';
          cd.cellEditorParams = { values:['Update','Call','Email','Assignment','Follow-up','Onsite','Resolution'] };
        }
        if (type === 'text' && /status/.test(lname)){
          cd.cellEditor = 'agSelectCellEditor';
          cd.cellEditorParams = { values:['Open','In Progress','Completed','Blocked','Cancelled'] };
        }

        defs.push(cd);
      });

      return defs;
    }

    function initGrid(columnDefs, rowData){
      const gridOptions = {
        ...CONFIG.grid,
        rowSelection: 'multiple',
        columnDefs,
        rowData,
        defaultColDef:{
          flex:1, minWidth:100, resizable:true, sortable:true, filter:true,
          valueFormatter: (p) => {
            const v = p.value;
            if (v == null) return '';
            if (typeof v === 'object') {
              if (v.Url) return v.Url;
              if (v.Title) return v.Title;
              if (Array.isArray(v.results)) return v.results.join(', ');
              try { return JSON.stringify(v); } catch { return String(v); }
            }
            return v;
          },
          valueParser: (p) => p.newValue
        },
        onCellValueChanged,
        onSelectionChanged: updateGridStats,
        onFilterChanged: updateGridStats,
        onSortChanged: updateGridStats,
        onGridReady: () => {
          updateGridStats();
          populateColumnMenu();
        },
        onColumnVisible: populateColumnMenu
      };

      const api = agGrid.createGrid(document.getElementById('grid'), gridOptions);
      state.gridApi = api;
    }

    function onCellValueChanged(params){
      const id = params.data.ID;
      if (String(id).startsWith('NEW_')){
        params.data[params.colDef.field] = params.newValue;
      } else {
        const updates = state.pendingChanges.updates.get(id) || {};
        updates[params.colDef.field] = params.newValue;
        state.pendingChanges.updates.set(id, updates);
      }
      updateChangeCount();
    }

    // ===== APP =====
    async function initializeApp(){
      try{
        setStatus('Loading activity...', 'info');
        const listData = await loadListData();

        const schemaFields = Array.isArray(listData?.ListSchema?.Field) ? listData.ListSchema.Field : [];
        const rowDataRaw = Array.isArray(listData?.Row) ? listData.Row.map(r => ({ ...r })) : [];
        const columnDefs = schemaFields.length
          ? buildColumnDefs(schemaFields)
          : buildColumnDefs((Object.keys(rowDataRaw[0]||{})).map(k=>({ Name:k, Title:k, Type:'Text', Hidden:false })));

        state.columnDefs = columnDefs;
        state.originalData = JSON.parse(JSON.stringify(rowDataRaw));

        initGrid(columnDefs, rowDataRaw);
        setupEvents();

        setStatus(`Loaded ${rowDataRaw.length} rows`, 'success');
        showToast(`Loaded ${rowDataRaw.length} activities from SharePoint`,'success');
      }catch(err){
        console.error('Init failed', err);
        setStatus('Failed to load data','error');
        showToast('Failed to load activity. Please refresh.','error');
      }
    }

    function safeSetColumnVisible(field, visible){
      // AG Grid v31: gridApi has setColumnVisible; fallback to setColumnsVisible
      if (typeof state.gridApi.setColumnVisible === 'function') {
        state.gridApi.setColumnVisible(field, visible);
      } else if (typeof state.gridApi.setColumnsVisible === 'function') {
        state.gridApi.setColumnsVisible([field], visible);
      }
    }

    function populateColumnMenu(){
      const list = $('#columnList');
      if (!state.gridApi) return;
      list.innerHTML = '';

      // Use current columnDefs (API if available to capture any runtime changes)
      const defs = typeof state.gridApi.getColumnDefs === 'function'
        ? state.gridApi.getColumnDefs()
        : state.columnDefs;

      defs.forEach(cd=>{
        if (!cd.field || cd.field === '__selection__') return;
        const id = `colvis_${cd.field}`;
        const isHidden = !!cd.hide;
        const visible = !isHidden;

        const row = document.createElement('label');
        row.className = 'bulk-menu-item';
        row.style.cursor = 'pointer';
        row.innerHTML = `
          <input type="checkbox" id="${id}" class="column-checkbox" ${visible ? 'checked' : ''} />
          <span>${cd.headerName}</span>
        `;
        row.querySelector('input').onchange = (e)=> safeSetColumnVisible(cd.field, e.target.checked);
        list.appendChild(row);
      });
    }

    function setupEvents(){
      // Sign-in
      $('#btnLogin').onclick = async ()=>{
        await state.msalInstance.loginRedirect({ scopes:[`https://${CONFIG.sharepoint.tenant}/AllSites.FullControl`] });
      };

      // Refresh
      $('#btnRefresh').onclick = ()=>{
        if (state.isDirty && !confirm('You have unsaved changes. Refresh anyway?')) return;
        window.location.reload();
      };

      // Add activity (modal)
      $('#btnAddRow').onclick = ()=>{
        const now = new Date(Date.now() - (new Date()).getTimezoneOffset()*60000).toISOString().slice(0,16);
        $('#actWhen').value = now;
        openActivityModal();
      };

      // Save changes
      $('#btnSave').onclick = saveChanges;

      // Discard
      $('#btnDiscard').onclick = ()=>{
        if (!confirm('Discard all pending changes?')) return;
        state.pendingChanges.updates.clear();
        state.pendingChanges.creates = [];
        state.pendingChanges.deletes.clear();
        state.gridApi.setRowData(JSON.parse(JSON.stringify(state.originalData)));
        updateChangeCount();
        showToast('Changes discarded','info');
      };

      // Bulk menu toggles
      $('#btnBulkActions').onclick = ()=> $('#bulkMenu').classList.toggle('show');
      document.addEventListener('click', e=>{
        if (!e.target.closest('.bulk-actions')) $('#bulkMenu').classList.remove('show');
        if (!e.target.closest('.column-config')) $('#columnMenu').classList.remove('show');
      });

      // Delete selected
      $('#btnDeleteSelected').onclick = ()=>{
        const sel = state.gridApi.getSelectedRows();
        if (!sel.length) return showToast('No rows selected','warning');
        if (!confirm(`Delete ${sel.length} selected rows?`)) return;

        sel.forEach(r=>{
          if (String(r.ID).startsWith('NEW_')){
            state.pendingChanges.creates = state.pendingChanges.creates.filter(x=> x.ID !== r.ID);
          } else {
            state.pendingChanges.deletes.add(r.ID);
          }
        });
        state.gridApi.applyTransaction({ remove: sel });
        updateChangeCount();
        showToast(`${sel.length} rows marked for deletion`,'warning');
      };

      // Duplicate selected
      $('#btnDuplicateSelected').onclick = ()=>{
        const sel = state.gridApi.getSelectedRows();
        if (!sel.length) return showToast('No rows selected','warning');

        const dups = sel.map(r=>{
          const copy = { ...r };
          copy.ID = `NEW_${Date.now()}_${Math.random()}`;
          delete copy.__selection__;
          state.pendingChanges.creates.push(copy);
          return copy;
        });
        state.gridApi.applyTransaction({ add: dups, addIndex: 0 });
        updateChangeCount();
        showToast(`${dups.length} rows duplicated`,'success');
      };

      // Export selected / all
      $('#btnExportSelected').onclick = ()=>{
        const sel = state.gridApi.getSelectedRows();
        if (!sel.length) return showToast('No rows selected','warning');
        exportToCSV(sel, 'job_activity_selected');
      };
      const exportAll = ()=>{
        const rows = [];
        state.gridApi.forEachNode(n => rows.push(n.data));
        exportToCSV(rows, 'job_activity_all');
      };
      $('#btnExportAll').onclick = exportAll;
      $('#btnExportAllTop').onclick = exportAll;

      // Quick search
      $('#quickSearch').oninput = e => state.gridApi.setQuickFilter(e.target.value);

      // Column config
      $('#btnColumnConfig').onclick = ()=> $('#columnMenu').classList.toggle('show');

      // Add column modal behaviors
      $('#colDisplay').oninput = e => $('#colInternal').value = generateInternalName(e.target.value);
      $('#colType').onchange = e => { $('#choiceRow').style.display = (e.target.value === 'Choice' || e.target.value === 'MultiChoice') ? 'block' : 'none'; };
      $('#btnCreateColumn').onclick = createColumn;

      // Import
      $('#btnImport').onclick = ()=> openImport();

      // Modal save
      $('#btnSaveActivity').onclick = saveActivityFromModal;

      // Close modals on bg click
      $$('.modal').forEach(m => m.onclick = e => { if (e.target === m) m.classList.remove('active'); });

      // Navigation guard
      window.addEventListener('beforeunload', e=>{ if (state.isDirty){ e.preventDefault(); e.returnValue = ''; } });

      // Open column modal
      $('#btnAddColumn').addEventListener('click', openColumnModal);
    }

    function openActivityModal(activity = null){
      state.currentActivity = activity;
      $('#activityModalTitle').textContent = activity ? 'Edit Activity' : 'Add Activity';

      $('#actJobRef').value = activity?.JobReference || activity?.JobID || activity?.JobId || activity?.Rego || '';
      $('#actType').value   = activity?.ActivityType || 'Update';
      $('#actStatus').value = activity?.Status || 'Open';
      $('#actUser').value   = activity?.PerformedBy || activity?.Author || '';
      $('#actWhen').value   = activity?.When ? toLocalInput(activity.When) : $('#actWhen').value || '';
      $('#actDuration').value = activity?.Duration ?? '';
      $('#actCost').value     = activity?.Cost ?? '';
      $('#actNotes').value    = activity?.Notes || activity?.Description || '';

      $('#activityModal').classList.add('active');
    }
    function closeActivityModal(){ $('#activityModal').classList.remove('active'); state.currentActivity = null; }

    function toLocalInput(dt){
      const d = new Date(dt);
      if (isNaN(d)) return '';
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function saveActivityFromModal(){
      const payload = {
        JobReference: $('#actJobRef').value.trim(),
        ActivityType: $('#actType').value,
        Status: $('#actStatus').value,
        PerformedBy: $('#actUser').value.trim(),
        When: $('#actWhen').value ? new Date($('#actWhen').value).toISOString() : null,
        Duration: $('#actDuration').value ? Number($('#actDuration').value) : null,
        Cost: $('#actCost').value ? Number($('#actCost').value) : null,
        Notes: $('#actNotes').value.trim()
      };

      if (!payload.ActivityType && !payload.Notes){
        showToast('Provide at least an activity type or notes.','warning');
        return;
      }

      if (state.currentActivity){
        if (String(state.currentActivity.ID).startsWith('NEW_')){
          Object.assign(state.currentActivity, payload);
          state.gridApi.refreshCells();
        } else {
          const updates = state.pendingChanges.updates.get(state.currentActivity.ID) || {};
          Object.assign(updates, payload);
          state.pendingChanges.updates.set(state.currentActivity.ID, updates);
        }
      } else {
        const newRow = {
          ID: `NEW_${Date.now()}`,
          ...payload,
          Created: new Date().toISOString(),
          Modified: new Date().toISOString(),
          Author: state.account?.username
        };
        state.pendingChanges.creates.push(newRow);
        state.gridApi.applyTransaction({ add:[newRow], addIndex:0 });
      }

      updateChangeCount();
      closeActivityModal();
      showToast('Activity added to pending changes','info');
    }

    async function saveChanges(){
      try{
        setStatus('Saving changes...','info');
        $('#btnSave').disabled = true;

        try { await getAccessToken(); } catch {}

        let ok = 0, fail = 0;
        const idMap = new Map(); // tempId -> realId

        // CREATES
        for (const row of state.pendingChanges.creates){
          try{
            const copy = { ...row };
            const tempId = copy.ID;
            delete copy.ID; delete copy.__selection__;
            delete copy.Created; delete copy.Modified; delete copy.Author;

            const created = await createItem(copy);
            const realId = created?.ID ?? created?.Id;

            if (realId){
              idMap.set(tempId, realId);

              let targetNode = null;
              state.gridApi.forEachNode(n => { if (n.data.ID === tempId) targetNode = n; });
              if (targetNode){
                targetNode.setData({
                  ...targetNode.data,
                  ID: realId,
                  Created: created?.Created || targetNode.data.Created,
                  Modified: created?.Modified || targetNode.data.Modified,
                });
              }
            }

            ok++;
          }catch(e){ console.error('Create failed', e); fail++; }
        }

        // UPDATES
        for (const [id, updates] of state.pendingChanges.updates.entries()){
          try{
            const realId = idMap.get(id) || id;
            await updateItem(realId, updates);
            ok++;
          }catch(e){ console.error('Update failed', id, e); fail++; }
        }

        // DELETES
        for (const id of state.pendingChanges.deletes){
          try{
            const realId = idMap.get(id) || id;
            await deleteItem(realId);
            ok++;
          }catch(e){
            if (e?.status === 404) { ok++; } else { console.error('Delete failed', id, e); fail++; }
          }
        }

        // Clear pending
        state.pendingChanges.updates.clear();
        state.pendingChanges.creates = [];
        state.pendingChanges.deletes.clear();

        // Refresh originals from current grid
        const rowsNow = [];
        state.gridApi.forEachNode(n => rowsNow.push(n.data));
        state.originalData = JSON.parse(JSON.stringify(rowsNow));

        updateChangeCount();

        if (fail){
          setStatus(`Saved with ${fail} errors`,'warning');
          showToast(`Saved ${ok} ops, ${fail} failed`,'warning');
        }else{
          setStatus('All changes saved','success');
          showToast(`Successfully saved ${ok} operations`,'success');
        }
      }catch(err){
        console.error('Save error', err);
        setStatus('Save failed','error');
        showToast('Save failed. Try again.','error');
      }finally{
        $('#btnSave').disabled = false;
      }
    }

    // ===== COLUMN CONFIG =====
    async function createColumn(){
      const displayName = $('#colDisplay').value.trim();
      const type = $('#colType').value;
      const required = $('#colRequired').checked;
      const defaultValue = $('#colDefault').value.trim();
      const choices = $('#colChoices').value.split('\n').map(s=>s.trim()).filter(Boolean);

      if (!displayName) return showToast('Enter a display name','warning');
      if ((type === 'Choice' || type === 'MultiChoice') && !choices.length){
        return showToast('Enter at least one choice','warning');
      }

      try{
        setStatus('Creating column...','info');
        await addField({
          displayName, type, required,
          defaultValue: defaultValue || undefined,
          choices: choices.length ? choices : undefined
        });
        closeColumnModal();
        showToast(`Column "${displayName}" created`,'success');
        setTimeout(()=>{ if (confirm('Reload to see the new column?')) window.location.reload(); }, 600);
      }catch(err){
        console.error('Add column failed', err);
        showToast('Failed to create column','error');
      }
    }
    function closeColumnModal(){
      $('#columnModal').classList.remove('active');
      $('#colDisplay').value = ''; $('#colInternal').value = '';
      $('#colType').value = 'Text'; $('#colRequired').checked = false;
      $('#colDefault').value = ''; $('#colChoices').value = '';
      $('#choiceRow').style.display = 'none';
    }
    function openColumnModal(){ $('#columnModal').classList.add('active'); }

    // ===== IMPORT / EXPORT =====
    function openImport(){
      const input = document.createElement('input');
      input.type = 'file'; input.accept = '.csv';
      input.onchange = async (e)=>{
        const file = e.target.files?.[0]; if (!file) return;
        const text = await file.text();
        const [headerLine, ...lines] = text.split(/\r?\n/).filter(Boolean);
        const headers = headerLine.split(',').map(h=>h.replace(/^"|"$/g,''));
        const newRows = [];
        lines.forEach(line=>{
          const cols = parseCsvLine(line);
          const rec = { ID:`NEW_${Date.now()}_${Math.random()}` };
          headers.forEach((h, i)=> rec[h] = cols[i] ?? '');
          state.pendingChanges.creates.push(rec);
          newRows.push(rec);
        });
        state.gridApi.applyTransaction({ add: newRows, addIndex: 0 });
        updateChangeCount();
        showToast(`Imported ${newRows.length} rows (pending)`, 'success');
      };
      input.click();
    }
    function parseCsvLine(line){
      const out=[]; let cur='', inq=false;
      for (let i=0;i<line.length;i++){
        const c=line[i];
        if (c === '"' ){ if (inq && line[i+1] === '"'){ cur+='"'; i++; } else { inq=!inq; } }
        else if (c === ',' && !inq){ out.push(cur); cur=''; }
        else { cur+=c; }
      }
      out.push(cur); return out;
    }

    function exportToCSV(data, basename){
      if (!data?.length) return showToast('No data to export','warning');
      const headers = Object.keys(data[0]).filter(k => k !== '__selection__');
      const lines = [
        headers.join(','),
        ...data.map(row => headers.map(h=>{
          let v = row[h]; if (v == null) v = '';
          v = String(v).replace(/"/g,'""');
          return (v.includes(',')||v.includes('"')||v.includes('\n')) ? `"${v}"` : v;
        }).join(','))
      ];
      const blob = new Blob([lines.join('\n')], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${basename}_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast(`Exported ${data.length} rows`,'success');
    }

    // ===== INIT =====
    window.addEventListener('DOMContentLoaded', initAuth);
  </script>
</body>
</html>
