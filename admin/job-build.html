<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Job Build - FP Service Management</title>
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; min-height: 100vh; }

.loading { position: fixed; inset: 0; background: #fff; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; }
.loading.authenticated { display: none; }
.spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #1e3c72; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: #718096; font-size: 14px; }

.page-container { display: none; min-height: 100vh; }
.page-container.authenticated { display: block; }

.header { background: linear-gradient(135deg, #1e3c72, #2a5298); color: #fff; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.header-left { display: flex; align-items: center; gap: 16px; }
.back-btn { background: rgba(255,255,255,0.2); color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.2s; text-decoration: none; display: flex; align-items: center; gap: 6px; }
.back-btn:hover { background: rgba(255,255,255,0.3); color: #fff; text-decoration: none; }
.page-title { font-size: 20px; font-weight: 700; }
.page-icon { font-size: 24px; }

.main-content { padding: 24px; max-width: 900px; margin: 0 auto; }

.content-card { background: #fff; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }

.section-title { font-size: 1.4em; font-weight: 700; color: #1e3c72; margin-bottom: 8px; }
.section-description { color: #64748b; margin-bottom: 24px; line-height: 1.5; }

.form-step { display: none; }
.form-step.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.form-group { margin-bottom: 24px; }
.form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 15px; }
.form-label .required { color: #ef4444; margin-left: 4px; }
.form-label .helper-text { display: block; font-weight: 400; font-size: 13px; color: #6b7280; margin-top: 4px; }
.form-input { width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; }
.form-input:focus { outline: none; border-color: #1e3c72; box-shadow: 0 0 0 3px rgba(30,60,114,0.1); }
.form-input.error { border-color: #ef4444; }
.error-message { color: #ef4444; font-size: 13px; margin-top: 6px; display: none; }
.error-message.show { display: block; }

.info-display { background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
.info-display .info-label { font-weight: 600; color: #1e40af; margin-bottom: 8px; }
.info-display .info-value { color: #1e293b; font-size: 1.1em; }

.options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
.option-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s ease; text-align: center; }
.option-card:hover { border-color: #1e3c72; background: #f0f4ff; }
.option-card.selected { border-color: #1e3c72; background: #dbeafe; color: #1e3c72; font-weight: 600; }
.option-card .option-icon { font-size: 24px; margin-bottom: 8px; }
.option-card .option-label { font-size: 14px; font-weight: 500; }

.checkbox-group { display: flex; flex-direction: column; gap: 12px; }
.checkbox-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
.checkbox-item:hover { border-color: #1e3c72; background: #f0f4ff; }
.checkbox-item.selected { border-color: #1e3c72; background: #dbeafe; }
.checkbox-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
.checkbox-item label { flex: 1; cursor: pointer; font-weight: 500; }

.btn { padding: 12px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
.btn-primary { background: #1e3c72; color: #fff; }
.btn-primary:hover { background: #1a3260; }
.btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }
.btn-secondary { background: #6b7280; color: #fff; }
.btn-secondary:hover { background: #5b6370; }
.btn-success { background: #10b981; color: #fff; }
.btn-success:hover { background: #059669; }

.button-group { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }

.alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; border: 1px solid; }
.alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }
.alert-error { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
.alert-info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }

.loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.loading-overlay.show { display: flex; }
.loading-card { background: #fff; padding: 30px; border-radius: 8px; text-align: center; }

.completion-message { text-align: center; padding: 40px 20px; }
.completion-icon { font-size: 64px; margin-bottom: 20px; }
.completion-title { font-size: 1.8em; font-weight: 700; color: #1e3c72; margin-bottom: 12px; }
.completion-text { color: #64748b; font-size: 1.1em; line-height: 1.6; }

.job-picker-btn { background: #1e3c72; color: #fff; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: background 0.2s; width: 100%; justify-content: center; }
.job-picker-btn:hover { background: #1a3260; }

@media (max-width: 768px) {
  .header { padding: 12px 16px; }
  .page-title { font-size: 18px; }
  .main-content { padding: 16px; }
  .content-card { padding: 20px; }
  .options-grid { grid-template-columns: 1fr; }
  .button-group { flex-direction: column; }
  .button-group .btn { width: 100%; }
}
</style>
</head>
<body>

<div class="loading" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">Verifying access...</div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-card">
        <div class="spinner"></div>
        <div style="margin-top: 15px;">Processing...</div>
    </div>
</div>

<!-- Include Job Picker Modal -->
<iframe 
    id="jobPickerFrame"
    src="job-picker-modal.html" 
    style="display: none;" 
    onload="initJobPicker()"
></iframe>

<div class="page-container" id="pageContainer">
    <div class="header">
        <div class="header-left">
            <a href="command-menu.html" class="back-btn">‚Üê Back to Menu</a>
            <div class="page-icon">üî®</div>
            <div class="page-title">Job Build</div>
        </div>
    </div>

    <div class="main-content">
        <div class="content-card">
            <!-- Step 1: Rego & Type -->
            <div class="form-step active" data-step="1">
                <div class="section-title">Job Details</div>
                <div class="section-description">Select the job registration from existing jobs. The job must be in the system to add a supplier.</div>
                
                <div class="form-group">
                    <label class="form-label">Job Registration <span class="required">*</span></label>
                    <button class="job-picker-btn" onclick="openJobPicker()">
                        <span>üìã</span>
                        <span>Select Job Registration</span>
                    </button>
                </div>
                
                <div id="selectedRegoDisplay" style="display: none;">
                    <div class="info-display">
                        <div class="info-label">Selected Registration:</div>
                        <div class="info-value" id="selectedRegoValue"></div>
                    </div>
                </div>
                
                <div class="form-group" id="typeSelection" style="display: none;">
                    <label class="form-label">Type <span class="required">*</span></label>
                    <div class="options-grid">
                        <div class="option-card" data-type="Billable" onclick="selectType('Billable')">
                            <div class="option-icon">üí∞</div>
                            <div class="option-label">Billable</div>
                        </div>
                        <div class="option-card" data-type="Deposit" onclick="selectType('Deposit')">
                            <div class="option-icon">üíµ</div>
                            <div class="option-label">Deposit</div>
                        </div>
                        <div class="option-card" data-type="Supplier" onclick="selectType('Supplier')">
                            <div class="option-icon">üöö</div>
                            <div class="option-label">Supplier</div>
                        </div>
                        <div class="option-card" data-type="Reimbursement" onclick="selectType('Reimbursement')">
                            <div class="option-icon">üí∏</div>
                            <div class="option-label">Reimbursement</div>
                        </div>
                        <div class="option-card" data-type="Refund" onclick="selectType('Refund')">
                            <div class="option-icon">‚Ü©Ô∏è</div>
                            <div class="option-label">Refund</div>
                        </div>
                        <div class="option-card" data-type="Close Job" onclick="selectType('Close Job')">
                            <div class="option-icon">‚úÖ</div>
                            <div class="option-label">Close Job</div>
                        </div>
                        <div class="option-card" data-type="DNC" onclick="selectType('DNC')">
                            <div class="option-icon">‚ùå</div>
                            <div class="option-label">DNC</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Chargeables (for Billable type) -->
            <div class="form-step" data-step="2">
                <div class="section-title">Chargeables</div>
                <div class="section-description">Enter chargeable amount and client details</div>
                
                <div class="info-display">
                    <div class="info-label">Job Registration:</div>
                    <div class="info-value" id="regoDisplay2"></div>
                </div>
                
                <div class="form-group">
                    <label for="chargeables" class="form-label">
                        Chargeables
                        <span class="helper-text">Enter amount as a number</span>
                    </label>
                    <input 
                        type="number" 
                        id="chargeables" 
                        class="form-input" 
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">Existing Client?</label>
                    <div class="options-grid">
                        <div class="option-card" data-existing="Yes" onclick="selectExistingClient('Yes')">
                            <div class="option-label">Yes</div>
                        </div>
                        <div class="option-card" data-existing="No" onclick="selectExistingClient('No')">
                            <div class="option-label">No</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="clientMobileGroup" style="display: none;">
                    <label for="clientMobile" class="form-label">
                        Client Mobile Number
                        <span class="helper-text">Only required if client is already in the system and this is a new job</span>
                    </label>
                    <input 
                        type="tel" 
                        id="clientMobile" 
                        class="form-input" 
                        placeholder="Enter mobile number"
                    >
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="backToStep1()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="proceedFromChargeables()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Reimbursements (for Deposit/Reimbursement/Refund types) -->
            <div class="form-step" data-step="3">
                <div class="section-title">Reimbursement Amount</div>
                <div class="section-description">Enter the reimbursement amount</div>
                
                <div class="info-display">
                    <div class="info-label">Job Registration:</div>
                    <div class="info-value" id="regoDisplay3"></div>
                </div>
                
                <div class="form-group">
                    <label for="reimbursement" class="form-label">
                        Reimbursement
                        <span class="helper-text">Enter amount as a number</span>
                    </label>
                    <input 
                        type="number" 
                        id="reimbursement" 
                        class="form-input" 
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                    >
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="backToStep1()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="proceedFromReimbursements()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 3b: Text Supplier? (for Supplier type) -->
            <div class="form-step" data-step="3b">
                <div class="section-title">Text Supplier?</div>
                <div class="section-description">Should we send a text message to the supplier?</div>
                
                <div class="info-display">
                    <div class="info-label">Job Registration:</div>
                    <div class="info-value" id="regoDisplay3b"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Text Supplier? <span class="required">*</span></label>
                    <div class="options-grid">
                        <div class="option-card" data-text="Yes" onclick="selectTextSupplier('Yes')">
                            <div class="option-icon">üì±</div>
                            <div class="option-label">Yes</div>
                        </div>
                        <div class="option-card" data-text="No" onclick="selectTextSupplier('No')">
                            <div class="option-icon">üö´</div>
                            <div class="option-label">No</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Billables (Supplier Details) -->
            <div class="form-step" data-step="4">
                <div class="section-title">Supplier Details</div>
                <div class="section-description">Enter supplier information and costings</div>
                
                <div class="info-display">
                    <div class="info-label">Job Registration:</div>
                    <div class="info-value" id="regoDisplay4"></div>
                </div>
                
                <div class="form-group">
                    <label for="supplier" class="form-label">Supplier</label>
                    <input 
                        type="text" 
                        id="supplier" 
                        class="form-input" 
                        placeholder="Enter supplier name"
                    >
                </div>
                
                <div class="form-group">
                    <label for="textJobMobile" class="form-label">
                        Text Job to Mobile Number
                        <span class="helper-text">Supplier mobile number</span>
                    </label>
                    <input 
                        type="tel" 
                        id="textJobMobile" 
                        class="form-input" 
                        placeholder="Enter mobile number"
                    >
                </div>
                
                <div class="form-group">
                    <label for="emailJobSupplier" class="form-label">Email Job to Supplier</label>
                    <input 
                        type="email" 
                        id="emailJobSupplier" 
                        class="form-input" 
                        placeholder="supplier@example.com"
                    >
                </div>
                
                <div class="form-group">
                    <label for="costings" class="form-label">
                        Costings
                        <span class="helper-text">Enter amount as a number</span>
                    </label>
                    <input 
                        type="number" 
                        id="costings" 
                        class="form-input" 
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                    >
                </div>
                
                <div class="form-group">
                    <label for="bank" class="form-label">Bank</label>
                    <input 
                        type="text" 
                        id="bank" 
                        class="form-input" 
                        placeholder="Enter bank details"
                    >
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="backToPreviousFromBillables()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="proceedFromBillables()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 5: Routing (Job Notes & Payment) -->
            <div class="form-step" data-step="5">
                <div class="section-title">Job Routing & Completion</div>
                <div class="section-description">Final details before submission</div>
                
                <div class="info-display">
                    <div class="info-label">Job Registration:</div>
                    <div class="info-value" id="regoDisplay5"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Job Notes <span class="required">*</span>
                        <span class="helper-text">Select at most 2 options</span>
                    </label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" onclick="toggleJobNote(this, 'Services Rendered')">
                            <input type="checkbox" id="note1" value="Services Rendered">
                            <label for="note1">Services Rendered:</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleJobNote(this, 'Supplier Overage Charges')">
                            <input type="checkbox" id="note2" value="Supplier Overage Charges">
                            <label for="note2">Supplier Overage Charges:</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleJobNote(this, 'Close Job')">
                            <input type="checkbox" id="note3" value="Close Job">
                            <label for="note3">Close Job</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleJobNote(this, 'DNC')">
                            <input type="checkbox" id="note4" value="DNC">
                            <label for="note4">DNC</label>
                        </div>
                    </div>
                    <div class="error-message" id="jobNotesError">Please select 1 or 2 options</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Paid?</label>
                    <div class="options-grid">
                        <div class="option-card" data-paid="Cash" onclick="selectPaid('Cash')">
                            <div class="option-label">Cash</div>
                        </div>
                        <div class="option-card" data-paid="Bank" onclick="selectPaid('Bank')">
                            <div class="option-label">Bank</div>
                        </div>
                        <div class="option-card" data-paid="Reimbursable" onclick="selectPaid('Reimbursable')">
                            <div class="option-label">Reimbursable</div>
                        </div>
                        <div class="option-card" data-paid="Credit Card" onclick="selectPaid('Credit Card')">
                            <div class="option-label">Credit Card</div>
                        </div>
                        <div class="option-card" data-paid="No" onclick="selectPaid('No')">
                            <div class="option-label">No</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Close and Post Job For Billing <span class="required">*</span></label>
                    <div class="options-grid">
                        <div class="option-card" data-close="Yes" onclick="selectClosePost('Yes')">
                            <div class="option-label">Yes</div>
                        </div>
                        <div class="option-card" data-close="No" onclick="selectClosePost('No')">
                            <div class="option-label">No</div>
                        </div>
                    </div>
                    <div class="error-message" id="closePostError">Please select an option</div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="backFromRouting()">‚Üê Back</button>
                    <button class="btn btn-success" onclick="submitSupplier()">Submit</button>
                </div>
            </div>

            <!-- Completion Step -->
            <div class="form-step" data-step="complete">
                <div class="completion-message">
                    <div class="completion-icon">‚úÖ</div>
                    <div class="completion-title">Job Build Complete</div>
                    <div class="completion-text">
                        The job has been updated successfully and all details have been recorded.
                    </div>
                    <button class="btn btn-primary" onclick="startNew()" style="margin-top: 24px;">
                        Build Another Job
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let msalInstance = null;
let currentStep = 1;
let formData = {
    rego: '',
    jobData: null,
    type: '',
    chargeables: '',
    existingClient: '',
    clientMobile: '',
    reimbursement: '',
    textSupplier: '',
    supplier: '',
    textJobMobile: '',
    emailJobSupplier: '',
    costings: '',
    bank: '',
    jobNotes: [],
    paid: '',
    closeAndPost: ''
};

const msalConfig = {
  auth: {
    clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
    authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
    redirectUri: window.location.origin + '/admin'
  },
  cache: {
    cacheLocation: 'sessionStorage',
    storeAuthStateInCookie: true
  }
};

async function initAuth(){
  try{
    if(!window.msal || !window.msal.PublicClientApplication){
      console.error('MSAL failed to load.');
      return false;
    }

    msalInstance = new msal.PublicClientApplication(msalConfig);
    const redirectResponse = await msalInstance.handleRedirectPromise();
    if (redirectResponse && redirectResponse.account){
      msalInstance.setActiveAccount(redirectResponse.account);
    }

    const active = msalInstance.getActiveAccount();
    const accounts = msalInstance.getAllAccounts();
    const account = active || accounts[0];

    if (account){
      msalInstance.setActiveAccount(account);
      return true;
    } else {
      return false;
    }
  } catch (e){
    console.error('Auth init error:', e);
    return false;
  }
}

function showPage(){
  document.getElementById('loadingScreen').classList.add('authenticated');
  document.getElementById('pageContainer').classList.add('authenticated');
}

function showLoading(){
  document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading(){
  document.getElementById('loadingOverlay').classList.remove('show');
}

function showAlert(message, type = 'info'){
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = message;
  const contentCard = document.querySelector('.content-card');
  contentCard.insertBefore(alertDiv, contentCard.firstChild);
  setTimeout(() => alertDiv.remove(), 5000);
}

function showStep(stepId) {
  document.querySelectorAll('.form-step').forEach(step => {
    step.classList.remove('active');
  });
  
  const targetStep = document.querySelector(`.form-step[data-step="${stepId}"]`);
  if (targetStep) {
    targetStep.classList.add('active');
    currentStep = stepId;
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showError(fieldName) {
  const error = document.getElementById(fieldName + 'Error');
  if (error) error.classList.add('show');
}

function hideError(fieldName) {
  const error = document.getElementById(fieldName + 'Error');
  if (error) error.classList.remove('show');
}

// Job Picker Integration
function initJobPicker() {
  console.log('Job picker iframe loaded');
  window.addEventListener('message', handleJobPickerMessage);
}

function handleJobPickerMessage(event) {
  console.log('Received message:', event.data);
  
  if (event.data.type === 'JOB_SELECTED') {
    document.getElementById('jobPickerFrame').style.display = 'none';
    handleJobSelection(event.data);
  } else if (event.data.type === 'JOB_PICKER_CLOSED') {
    console.log('Job picker closed');
    document.getElementById('jobPickerFrame').style.display = 'none';
  }
}

function openJobPicker() {
  console.log('Opening job picker...');
  
  const iframe = document.getElementById('jobPickerFrame');
  
  if (!iframe) {
    showAlert('Job picker not available', 'error');
    return;
  }
  
  iframe.style.display = 'block';
  iframe.style.position = 'fixed';
  iframe.style.top = '0';
  iframe.style.left = '0';
  iframe.style.width = '100%';
  iframe.style.height = '100%';
  iframe.style.zIndex = '10000';
  iframe.style.border = 'none';
  
  iframe.contentWindow.postMessage({
    type: 'OPEN_PICKER',
    options: { filterPPI: false }
  }, '*');
}

function handleJobSelection(data) {
  console.log('Job selected:', data);
  formData.rego = data.rego;
  formData.jobData = data.job;
  
  document.getElementById('selectedRegoValue').textContent = data.rego;
  document.getElementById('selectedRegoDisplay').style.display = 'block';
  document.getElementById('typeSelection').style.display = 'block';
}

function selectType(type) {
  formData.type = type;
  
  document.querySelectorAll('[data-type]').forEach(card => {
    card.classList.remove('selected');
  });
  document.querySelector(`[data-type="${type}"]`).classList.add('selected');
  
  setTimeout(() => {
    // Branching logic based on type
    if (type === 'Billable') {
      document.getElementById('regoDisplay2').textContent = formData.rego;
      showStep(2);
    } else if (type === 'Deposit' || type === 'Reimbursement' || type === 'Refund') {
      document.getElementById('regoDisplay3').textContent = formData.rego;
      showStep(3);
    } else if (type === 'Supplier') {
      document.getElementById('regoDisplay3b').textContent = formData.rego;
      showStep('3b');
    } else if (type === 'Close Job' || type === 'DNC') {
      document.getElementById('regoDisplay5').textContent = formData.rego;
      showStep(5);
    }
  }, 300);
}

function backToStep1() {
  showStep(1);
}

function selectExistingClient(value) {
  formData.existingClient = value;
  
  document.querySelectorAll('[data-existing]').forEach(card => {
    card.classList.remove('selected');
  });
  document.querySelector(`[data-existing="${value}"]`).classList.add('selected');
  
  if (value === 'Yes') {
    document.getElementById('clientMobileGroup').style.display = 'block';
  } else {
    document.getElementById('clientMobileGroup').style.display = 'none';
  }
}

function proceedFromChargeables() {
  formData.chargeables = document.getElementById('chargeables').value.trim();
  formData.clientMobile = document.getElementById('clientMobile').value.trim();
  
  // Billable type skips supplier details and goes directly to Step 5 (Routing)
  document.getElementById('regoDisplay5').textContent = formData.rego;
  showStep(5);
}

function proceedFromReimbursements() {
  formData.reimbursement = document.getElementById('reimbursement').value.trim();
  
  // Deposit, Reimbursement, and Refund types skip Step 4 and go directly to Step 5 (Routing)
  document.getElementById('regoDisplay5').textContent = formData.rego;
  showStep(5);
}

function selectTextSupplier(value) {
  formData.textSupplier = value;
  
  document.querySelectorAll('[data-text]').forEach(card => {
    card.classList.remove('selected');
  });
  document.querySelector(`[data-text="${value}"]`).classList.add('selected');
  
  setTimeout(() => {
    document.getElementById('regoDisplay4').textContent = formData.rego;
    showStep(4);
  }, 300);
}

function backToPreviousFromBillables() {
  // Only Supplier type goes to Step 4, so it goes back to Step 3b
  showStep('3b');
}

function proceedFromBillables() {
  formData.supplier = document.getElementById('supplier').value.trim();
  formData.textJobMobile = document.getElementById('textJobMobile').value.trim();
  formData.emailJobSupplier = document.getElementById('emailJobSupplier').value.trim();
  formData.costings = document.getElementById('costings').value.trim();
  formData.bank = document.getElementById('bank').value.trim();
  
  document.getElementById('regoDisplay5').textContent = formData.rego;
  showStep(5);
}

function backFromRouting() {
  // Determine where to go back to based on type
  if (formData.type === 'Billable') {
    // Billable goes back to Step 2 (Chargeables)
    showStep(2);
  } else if (formData.type === 'Close Job' || formData.type === 'DNC') {
    // These types came directly to Step 5, go back to Step 1
    showStep(1);
  } else if (formData.type === 'Deposit' || formData.type === 'Reimbursement' || formData.type === 'Refund') {
    // These types skip Step 4, go back to Step 3 (Reimbursements)
    showStep(3);
  } else if (formData.type === 'Supplier') {
    // Supplier type goes back to Step 4
    showStep(4);
  }
}

function toggleJobNote(element, value) {
  const checkbox = element.querySelector('input[type="checkbox"]');
  checkbox.checked = !checkbox.checked;
  
  if (checkbox.checked) {
    element.classList.add('selected');
    if (!formData.jobNotes.includes(value)) {
      formData.jobNotes.push(value);
    }
  } else {
    element.classList.remove('selected');
    formData.jobNotes = formData.jobNotes.filter(note => note !== value);
  }
  
  // Limit to 2 selections
  if (formData.jobNotes.length > 2) {
    // Uncheck the oldest selection
    const oldestValue = formData.jobNotes.shift();
    const oldestCheckbox = document.querySelector(`input[value="${oldestValue}"]`);
    if (oldestCheckbox) {
      oldestCheckbox.checked = false;
      oldestCheckbox.parentElement.classList.remove('selected');
    }
  }
  
  hideError('jobNotes');
}

function selectPaid(value) {
  formData.paid = value;
  
  document.querySelectorAll('[data-paid]').forEach(card => {
    card.classList.remove('selected');
  });
  document.querySelector(`[data-paid="${value}"]`).classList.add('selected');
}

function selectClosePost(value) {
  formData.closeAndPost = value;
  
  document.querySelectorAll('[data-close]').forEach(card => {
    card.classList.remove('selected');
  });
  document.querySelector(`[data-close="${value}"]`).classList.add('selected');
  
  hideError('closePost');
}

async function submitSupplier() {
  // Validate required fields
  let isValid = true;
  
  if (formData.jobNotes.length === 0 || formData.jobNotes.length > 2) {
    showError('jobNotes');
    isValid = false;
  }
  
  if (!formData.closeAndPost) {
    showError('closePost');
    isValid = false;
  }
  
  if (!isValid) return;
  
  showLoading();
  
  try {
    await submitToFlow({
      action: 'JobBuild',
      rego: formData.rego,
      type: formData.type,
      chargeables: formData.chargeables,
      existingClient: formData.existingClient,
      clientMobile: formData.clientMobile,
      reimbursement: formData.reimbursement,
      textSupplier: formData.textSupplier,
      supplier: formData.supplier,
      textJobMobile: formData.textJobMobile,
      emailJobSupplier: formData.emailJobSupplier,
      costings: formData.costings,
      bank: formData.bank,
      jobNotes: formData.jobNotes,
      paid: formData.paid,
      closeAndPost: formData.closeAndPost,
      submittedBy: msalInstance.getActiveAccount()?.username || 'Unknown',
      submittedAt: new Date().toISOString()
    });
    
    hideLoading();
    showStep('complete');
  } catch (error) {
    hideLoading();
    showAlert('Failed to build job: ' + error.message, 'error');
  }
}

async function submitToFlow(data) {
  const flowEndpoint = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e1adbceb52c94e07b923228a8c05d29d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_ok7gvPEZKmPw9q2jiKY9Msqofd65YeMtuGfSjEqxJ4';
  
  const response = await fetch(flowEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      commandNumber: 4,
      formType: 'JobBuild',
      data: data
    })
  });
  
  if (!response.ok) {
    throw new Error(`Flow failed: ${response.status}`);
  }
  
  return response.json();
}

function startNew() {
  formData = {
    rego: '',
    jobData: null,
    type: '',
    chargeables: '',
    existingClient: '',
    clientMobile: '',
    reimbursement: '',
    textSupplier: '',
    supplier: '',
    textJobMobile: '',
    emailJobSupplier: '',
    costings: '',
    bank: '',
    jobNotes: [],
    paid: '',
    closeAndPost: ''
  };
  
  document.querySelectorAll('.form-input').forEach(input => {
    input.value = '';
  });
  
  document.querySelectorAll('.option-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  document.querySelectorAll('.checkbox-item').forEach(item => {
    item.classList.remove('selected');
    const checkbox = item.querySelector('input[type="checkbox"]');
    if (checkbox) checkbox.checked = false;
  });
  
  document.getElementById('selectedRegoDisplay').style.display = 'none';
  document.getElementById('typeSelection').style.display = 'none';
  document.getElementById('clientMobileGroup').style.display = 'none';
  
  showStep(1);
}

window.addEventListener('DOMContentLoaded', async function(){
  const authenticated = await initAuth();
  if(authenticated){
    showPage();
  } else {
    window.location.href = '/admin';
  }
});
</script>

</body>
</html>
