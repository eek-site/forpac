<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>New Job Form | FormanPacific</title>
  <meta name="description" content="Create new service jobs for multiple clients">
  <meta name="robots" content="noindex, nofollow">

  <!-- MSAL -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <!-- Command Menu -->
  <script src="/assets/js/fp-menu-loader.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-color:#1e3c72;--primary-dark:#152a52;--secondary-color:#2a5298;
      --success-color:#10b981;--warning-color:#f59e0b;--error-color:#ef4444;
      --info-color:#3b82f6;--text-primary:#1e293b;--text-secondary:#64748b;
      --border-color:#e2e8f0;--bg-light:#f8fafc;--bg-white:#ffffff;
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1);--shadow-xl:0 20px 25px -5px rgba(0,0,0,.1)
    }
    body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);min-height:100vh;color:var(--text-primary)}
    
    /* Header */
    .header{background:var(--bg-white);box-shadow:var(--shadow-md);position:sticky;top:0;z-index:1000;border-bottom:2px solid var(--border-color)}
    .header-content{max-width:1400px;margin:0 auto;padding:20px 30px;display:flex;justify-content:space-between;align-items:center}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:22px}
    .company-info{display:flex;flex-direction:column}
    .company-name{font-size:1.5em;font-weight:700;color:var(--primary-color)}
    .page-label{font-size:.9em;color:var(--text-secondary);font-weight:500}
    .nav-section{display:flex;gap:12px}
    .btn-nav{background:var(--text-secondary);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:8px;transition:all .2s}
    .btn-nav:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}

    /* Client Selector */
    .client-selector{max-width:1400px;margin:20px auto;padding:0 30px}
    .client-tabs{display:flex;gap:8px;background:var(--bg-white);padding:8px;border-radius:12px;box-shadow:var(--shadow-md)}
    .client-tab{flex:1;padding:16px;background:transparent;border:2px solid transparent;border-radius:8px;cursor:pointer;font-weight:600;color:var(--text-secondary);transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
    .client-tab.active{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border-color:var(--primary-color)}
    .client-tab:hover:not(.active){background:var(--bg-light);color:var(--primary-color)}
    .client-icon{font-size:20px}

    /* Main Form */
    .container{max-width:1400px;margin:0 auto;padding:20px 30px}
    .form-container{background:var(--bg-white);border-radius:16px;padding:32px;box-shadow:var(--shadow-lg);border:1px solid var(--border-color)}
    
    /* Form Sections */
    .form-section{margin-bottom:32px;padding-bottom:24px;border-bottom:2px solid var(--border-color)}
    .form-section:last-child{border-bottom:none}
    .section-title{font-size:1.1em;font-weight:600;color:var(--primary-color);margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .section-icon{width:28px;height:28px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px}
    
    /* Form Grid */
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
    .form-group{display:flex;flex-direction:column}
    .form-label{font-size:.85em;color:var(--text-secondary);font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .required{color:var(--error-color)}
    .form-input,.form-select,.form-textarea{padding:12px 16px;border:2px solid var(--border-color);border-radius:8px;font-size:1em;background:var(--bg-white);transition:all .2s}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .form-textarea{resize:vertical;min-height:100px;font-family:inherit}
    
    /* Type Selector */
    .type-selector{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .type-btn{padding:14px;background:var(--bg-white);border:2px solid var(--border-color);border-radius:10px;cursor:pointer;font-weight:600;text-align:center;transition:all .2s;position:relative;overflow:hidden}
    .type-btn:hover{border-color:var(--primary-color);transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .type-btn.selected{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border-color:var(--primary-color)}
    .type-btn.selected::after{content:'✓';position:absolute;top:4px;right:8px;font-size:16px}
    .type-icon{display:block;font-size:24px;margin-bottom:4px}
    .type-label{font-size:.9em}
    
    /* Conditional Sections */
    .conditional-section{display:none;animation:slideDown .3s ease}
    .conditional-section.show{display:block}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    
    /* Flags */
    .flag-group{display:flex;gap:20px;flex-wrap:wrap}
    .flag-item{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 16px;border:2px solid var(--border-color);border-radius:8px;transition:all .2s}
    .flag-item:hover{border-color:var(--primary-color);background:var(--bg-light)}
    .flag-checkbox{width:20px;height:20px;cursor:pointer}
    .flag-item.checked{background:linear-gradient(135deg,rgba(30,60,114,.1),rgba(42,82,152,.1));border-color:var(--primary-color)}
    
    /* Quick Fill */
    .quick-fill{background:var(--bg-light);padding:16px;border-radius:10px;margin-bottom:20px;border:2px dashed var(--primary-color)}
    .quick-fill-title{font-weight:600;color:var(--primary-color);margin-bottom:10px}
    .quick-actions{display:flex;gap:10px;flex-wrap:wrap}
    .quick-btn{padding:8px 16px;background:var(--bg-white);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-size:.9em;transition:all .2s}
    .quick-btn:hover{background:var(--primary-color);color:#fff;transform:translateY(-1px)}
    
    /* Submit Section */
    .submit-section{display:flex;justify-content:space-between;align-items:center;padding-top:24px;border-top:2px solid var(--border-color);margin-top:32px}
    .submit-actions{display:flex;gap:12px}
    .btn-submit{padding:14px 32px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:1em;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,var(--success-color),#059669);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .btn-secondary{background:var(--bg-light);color:var(--text-primary);border:2px solid var(--border-color)}
    .btn-danger{background:var(--error-color);color:#fff}
    
    /* Loading & Messages */
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-overlay.show{display:flex}
    .loading-content{background:var(--bg-white);padding:32px;border-radius:16px;text-align:center}
    .spinner{width:48px;height:48px;border:4px solid var(--border-color);border-top:4px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .message{padding:16px;border-radius:10px;margin-bottom:20px;display:none;animation:slideDown .3s ease}
    .message.show{display:block}
    .message.success{background:#d1fae5;border:1px solid #6ee7b7;color:#065f46}
    .message.error{background:#fee2e2;border:1px solid #fca5a5;color:#991b1b}
    .message.warning{background:#fed7aa;border:1px solid #fdba74;color:#92400e}
    
    /* Keyboard Shortcuts */
    .keyboard-hint{position:fixed;bottom:20px;right:20px;background:var(--bg-white);padding:12px 16px;border-radius:8px;box-shadow:var(--shadow-lg);font-size:.85em;color:var(--text-secondary);border:1px solid var(--border-color)}
    .shortcut{background:var(--bg-light);padding:2px 6px;border-radius:4px;font-family:monospace;font-weight:600;color:var(--primary-color)}
    
    /* Responsive */
    @media(max-width:768px){
      .form-grid{grid-template-columns:1fr}
      .type-selector{grid-template-columns:repeat(2,1fr)}
      .header-content{flex-direction:column;gap:16px}
      .submit-section{flex-direction:column;gap:16px}
    }
    
    /* Accessibility */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    :focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div style="display:flex;align-items:center;gap:15px">
        <div class="logo">FP</div>
        <div class="company-info">
          <div class="company-name">FormanPacific</div>
          <div class="page-label">New Job Form</div>
        </div>
      </div>
      <div class="nav-section">
        <button class="btn-nav" onclick="window.location.href='/admin/dashboard'">← Dashboard</button>
        <button class="btn-nav" onclick="window.location.href='/admin/jobs'">View Jobs</button>
        <span id="userInfo" style="padding:10px;color:var(--text-secondary)"></span>
      </div>
    </div>
  </header>

  <!-- Client Selector -->
  <div class="client-selector">
    <div class="client-tabs">
      <button class="client-tab active" data-client="coolth" onclick="selectClient('coolth')">
        <span class="client-icon">❄️</span>
        <span>Coolth Tech</span>
      </button>
      <button class="client-tab" data-client="eek" onclick="selectClient('eek')">
        <span class="client-icon">⚙️</span>
        <span>EEK Mechanical</span>
      </button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Messages -->
    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>
    <div id="warningMessage" class="message warning"></div>

    <!-- Form Container -->
    <div class="form-container">
      <form id="jobForm" onsubmit="handleSubmit(event)">
        
        <!-- Quick Fill Section (for common scenarios) -->
        <div class="quick-fill">
          <div class="quick-fill-title">⚡ Quick Fill Templates</div>
          <div class="quick-actions" id="quickFillButtons">
            <!-- EEK Mechanical Templates -->
            <button type="button" class="quick-btn" onclick="quickFill('tyre-change')">Tyre Change</button>
            <button type="button" class="quick-btn" onclick="quickFill('jump-start')">Jump Start</button>
            <button type="button" class="quick-btn" onclick="quickFill('fuel-delivery')">Fuel Delivery</button>
            <button type="button" class="quick-btn" onclick="quickFill('lockout')">Lockout</button>
            <button type="button" class="quick-btn" onclick="quickFill('towing')">Towing</button>
            <!-- Coolth Tech Templates (shown when Coolth is selected) -->
            <button type="button" class="quick-btn coolth-template" style="display:none;" onclick="quickFill('fridge-emergency')">Fridge Emergency</button>
            <button type="button" class="quick-btn coolth-template" style="display:none;" onclick="quickFill('freezer-breakdown')">Freezer Breakdown</button>
            <button type="button" class="quick-btn coolth-template" style="display:none;" onclick="quickFill('commercial-chiller')">Commercial Chiller</button>
            <button type="button" class="quick-btn coolth-template" style="display:none;" onclick="quickFill('hvac-maintenance')">HVAC Service</button>
          </div>
        </div>

        <!-- Basic Information -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">📋</div>
            <span>Basic Information</span>
          </div>
          <div class="form-grid">
            <!-- Coolth Tech Identifier (hidden for EEK) -->
            <div class="form-group" id="coolthIdentifierGroup">
              <label class="form-label">
                Invoice Identifier <span class="required">*</span>
              </label>
              <input type="text" id="invoiceIdentifier" class="form-input" placeholder="CTH-2025-001" pattern="CTH-\d{4}-\d{3}" title="Format: CTH-YYYY-###">
              <small style="color:var(--text-secondary);font-size:.8em">Format: CTH-YYYY-###</small>
            </div>

            <!-- Rego (main for EEK, optional for Coolth) -->
            <div class="form-group">
              <label class="form-label">
                Vehicle Rego <span class="required" id="regoRequired">*</span>
              </label>
              <input type="text" id="rego" name="Rego" class="form-input" placeholder="ABC123" style="text-transform:uppercase" maxlength="10" required>
            </div>

            <!-- Customer Name -->
            <div class="form-group">
              <label class="form-label">
                Customer Name <span class="required">*</span>
              </label>
              <input type="text" id="customerName" name="CustomerName" class="form-input" placeholder="John Smith" required>
            </div>

            <!-- Customer Phone -->
            <div class="form-group">
              <label class="form-label">
                Customer Phone <span class="required">*</span>
              </label>
              <input type="tel" id="customerPhone" name="CustomerPhone" class="form-input" placeholder="021 123 4567" required>
            </div>

            <!-- Customer Email -->
            <div class="form-group">
              <label class="form-label">
                Customer Email
              </label>
              <input type="email" id="customerEmail" name="CustomerEmail" class="form-input" placeholder="customer@email.com">
            </div>

            <!-- Caller Phone (if different) -->
            <div class="form-group">
              <label class="form-label">
                Caller Phone (if different from customer)
              </label>
              <input type="tel" id="callerPhone" name="Callerphone" class="form-input" placeholder="021 987 6543">
            </div>
          </div>
        </div>

        <!-- Job Type Selection -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">💼</div>
            <span>Job Type (Tab through or click)</span>
          </div>
          <div class="type-selector" id="typeSelector">
            <button type="button" class="type-btn" data-type="Billable" tabindex="0">
              <span class="type-icon">💵</span>
              <span class="type-label">Billable</span>
            </button>
            <button type="button" class="type-btn" data-type="Supplier" tabindex="0">
              <span class="type-icon">🏭</span>
              <span class="type-label">Supplier</span>
            </button>
            <button type="button" class="type-btn" data-type="Refund" tabindex="0">
              <span class="type-icon">↩️</span>
              <span class="type-label">Refund</span>
            </button>
            <button type="button" class="type-btn" data-type="Reimbursement" tabindex="0">
              <span class="type-icon">💳</span>
              <span class="type-label">Reimbursement</span>
            </button>
            <button type="button" class="type-btn" data-type="Deposit" tabindex="0">
              <span class="type-icon">🏦</span>
              <span class="type-label">Deposit</span>
            </button>
            <button type="button" class="type-btn" data-type="Warranty" tabindex="0">
              <span class="type-icon">🛡️</span>
              <span class="type-label">Warranty</span>
            </button>
            <button type="button" class="type-btn" data-type="Internal" tabindex="0">
              <span class="type-icon">🏢</span>
              <span class="type-label">Internal</span>
            </button>
            <button type="button" class="type-btn" data-type="Other" tabindex="0">
              <span class="type-icon">📦</span>
              <span class="type-label">Other</span>
            </button>
          </div>
          <input type="hidden" id="jobType" name="Type" required>
        </div>

        <!-- Financial Information (Conditional) -->
        <div class="form-section conditional-section" id="financialSection">
          <div class="section-title">
            <div class="section-icon">💰</div>
            <span>Financial Details</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Amount (excl. GST) <span class="required">*</span>
              </label>
              <input type="number" id="amount" name="Amount" class="form-input" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">
                GST Amount
              </label>
              <input type="number" id="gstAmount" class="form-input" placeholder="0.00" step="0.01" min="0" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">
                Total (incl. GST)
              </label>
              <input type="number" id="totalAmount" class="form-input" placeholder="0.00" step="0.01" min="0" readonly>
            </div>
          </div>
        </div>

        <!-- Supplier Information (Conditional) -->
        <div class="form-section conditional-section" id="supplierSection">
          <div class="section-title">
            <div class="section-icon">🏭</div>
            <span>Supplier Information</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Supplier Name <span class="required">*</span>
              </label>
              <input type="text" id="supplierName" name="SupplierName" class="form-input" placeholder="Supplier Company Ltd">
            </div>
            <div class="form-group">
              <label class="form-label">
                Supplier Email <span class="required">*</span>
              </label>
              <input type="email" id="supplierEmail" name="SuppEmail" class="form-input" placeholder="supplier@company.com">
            </div>
            <div class="form-group">
              <label class="form-label">
                Supplier Phone <span class="required">*</span>
              </label>
              <input type="tel" id="supplierPhone" name="SuppPhone" class="form-input" placeholder="09 123 4567">
            </div>
            <div class="form-group">
              <label class="form-label">
                Bank Account
              </label>
              <input type="text" id="bankAccount" name="BankAccount" class="form-input" placeholder="12-3456-7890123-00">
            </div>
          </div>
        </div>

        <!-- Service Details -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">🔧</div>
            <span>Service Details</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Fault Description <span class="required">*</span>
              </label>
              <textarea id="fault" name="Fault" class="form-textarea" placeholder="Describe the fault or issue..." required></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">
                Service Required <span class="required">*</span>
              </label>
              <textarea id="serviceRequired" name="ServiceRequired" class="form-textarea" placeholder="What service is needed..." required></textarea>
            </div>
          </div>
        </div>

        <!-- Vehicle Information -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">🚗</div>
            <span>Vehicle Information</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Make</label>
              <input type="text" id="make" name="Make" class="form-input" placeholder="Toyota" list="makeList">
              <datalist id="makeList">
                <option value="Toyota"><option value="Ford"><option value="Holden">
                <option value="Mazda"><option value="Nissan"><option value="Honda">
                <option value="Mitsubishi"><option value="Hyundai"><option value="Volkswagen">
              </datalist>
            </div>
            <div class="form-group">
              <label class="form-label">Model</label>
              <input type="text" id="model" name="Model" class="form-input" placeholder="Corolla">
            </div>
            <div class="form-group">
              <label class="form-label">Tyre Size</label>
              <input type="text" id="tyreSize" name="TyreSize" class="form-input" placeholder="205/55R16">
            </div>
          </div>
        </div>

        <!-- Location Information -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">📍</div>
            <span>Location Details</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                From Location <span class="required">*</span>
              </label>
              <input type="text" id="fromLocation" name="FromLocation" class="form-input" placeholder="123 Main St, Auckland" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                To Location
              </label>
              <input type="text" id="toLocation" name="ToLocation" class="form-input" placeholder="456 Queen St, Auckland">
            </div>
          </div>
        </div>

        <!-- Additional Flags -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">🏴</div>
            <span>Additional Options</span>
          </div>
          <div class="flag-group">
            <label class="flag-item">
              <input type="checkbox" id="paidFlag" name="Paid" class="flag-checkbox">
              <span>Paid</span>
            </label>
            <label class="flag-item">
              <input type="checkbox" id="closePostFlag" name="CloseAndPost" class="flag-checkbox">
              <span>Close and Post</span>
            </label>
            <label class="flag-item">
              <input type="checkbox" id="textFlag" name="TextFlag" class="flag-checkbox">
              <span>Send SMS Notification</span>
            </label>
            <label class="flag-item">
              <input type="checkbox" id="batchFileFlag" name="BatchFileCreated" class="flag-checkbox" style="display: none;">
              <span style="display: none;">Batch File Created</span>
            </label>
          </div>
          
          <!-- Status Selection (hidden, set programmatically) -->
          <input type="hidden" id="jobStatus" name="Status" value="Active">
          
          <!-- Additional Notes for Activity Log -->
          <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">
              Additional Notes (optional)
            </label>
            <textarea id="suppUpdate" name="SuppUpdate" class="form-textarea" placeholder="Any special instructions or updates..." style="height: 80px;"></textarea>
          </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
          <div>
            <span style="color:var(--text-secondary);font-size:.9em">
              All fields marked with <span class="required">*</span> are required
            </span>
          </div>
          <div class="submit-actions">
            <button type="button" class="btn-submit btn-secondary" onclick="clearForm()">Clear Form</button>
            <button type="button" class="btn-submit btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button type="submit" class="btn-submit btn-primary">Submit Job</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div>Submitting job...</div>
    </div>
  </div>

  <!-- Keyboard Hints -->
  <div class="keyboard-hint">
    <strong>Keyboard Shortcuts:</strong><br>
    <span class="shortcut">Tab</span> Navigate fields<br>
    <span class="shortcut">Ctrl+Enter</span> Submit form<br>
    <span class="shortcut">Esc</span> Clear focus
  </div>

  <script>
    'use strict';

    // Configuration
    const SPO_HOST = 'roadandrescue.sharepoint.com';
    const SPO_SITE_PATH = '/sites/rar';
    const SPO_LIST_TITLE = 'Forman Pacific Consolidated';

    const MSAL_CONFIG = {
      auth: {
        clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
        authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
        redirectUri: window.location.origin + '/admin'
      },
      cache: { cacheLocation: 'sessionStorage', storeAuthStateInCookie: true }
    };

    // State
    let currentClient = 'coolth';
    let selectedType = null;
    let msalInstance = null;
    let currentUser = null;

    // Initialize
    async function initialize() {
      try {
        // Initialize MSAL
        if (!window.msal || !window.msal.PublicClientApplication) {
          showError('Authentication library failed to load');
          setTimeout(() => window.location.href = '/admin', 3000);
          return;
        }

        msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);
        await msalInstance.initialize();

        // Check authentication
        const accounts = msalInstance.getAllAccounts();
        if (!accounts.length) {
          showWarning('Please sign in to continue');
          setTimeout(() => window.location.href = '/admin', 2000);
          return;
        }

        currentUser = accounts[0];
        document.getElementById('userInfo').textContent = currentUser.name || currentUser.username;

        // Setup form
        setupTypeSelector();
        setupAmountCalculations();
        setupKeyboardShortcuts();
        loadDraft();

        // Generate Coolth identifier
        generateCoolthIdentifier();

      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize. Please refresh the page.');
      }
    }

    // Client Selection
    function selectClient(client) {
      currentClient = client;
      
      // Update tabs
      document.querySelectorAll('.client-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.client === client);
      });

      // Update form based on client
      const regoInput = document.getElementById('rego');
      const invoiceInput = document.getElementById('invoiceIdentifier');
      const coolthGroup = document.getElementById('coolthIdentifierGroup');
      
      // Toggle quick-fill templates
      const coolthTemplates = document.querySelectorAll('.coolth-template');
      const eekTemplates = document.querySelectorAll('.quick-btn:not(.coolth-template)');
      
      if (client === 'eek') {
        // EEK: Rego is primary identifier and required
        coolthGroup.style.display = 'none';
        invoiceInput.required = false;
        invoiceInput.value = '';
        regoInput.required = true;
        regoInput.placeholder = 'ABC123 (Required)';
        document.getElementById('regoRequired').style.display = 'inline';
        
        // Show EEK templates, hide Coolth templates
        coolthTemplates.forEach(btn => btn.style.display = 'none');
        eekTemplates.forEach(btn => btn.style.display = 'inline-block');
      } else {
        // Coolth: Custom identifier is primary, Rego is optional
        coolthGroup.style.display = 'block';
        invoiceInput.required = true;
        generateCoolthIdentifier();
        regoInput.required = false;
        regoInput.placeholder = 'ABC123 (Optional for Coolth)';
        document.getElementById('regoRequired').style.display = 'none';
        
        // Show Coolth templates, hide EEK templates
        coolthTemplates.forEach(btn => btn.style.display = 'inline-block');
        eekTemplates.forEach(btn => btn.style.display = 'none');
      }

      showSuccess(`Switched to ${client === 'eek' ? 'EEK Mechanical' : 'Coolth Tech'} form`);
    }

    // Generate Coolth Identifier
    function generateCoolthIdentifier() {
      const year = new Date().getFullYear();
      const random = Math.floor(Math.random() * 900) + 100;
      document.getElementById('invoiceIdentifier').value = `CTH-${year}-${random}`;
    }

    // Type Selection
    function setupTypeSelector() {
      const buttons = document.querySelectorAll('.type-btn');
      
      buttons.forEach(btn => {
        btn.addEventListener('click', () => selectType(btn.dataset.type));
        btn.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectType(btn.dataset.type);
          }
        });
      });
    }

    function selectType(type) {
      selectedType = type;
      document.getElementById('jobType').value = type;

      // Update UI
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
      });

      // Show/hide conditional sections
      const financialSection = document.getElementById('financialSection');
      const supplierSection = document.getElementById('supplierSection');

      // Financial section for Billable, Supplier, Refund, Reimbursement, Deposit
      const showFinancial = ['Billable', 'Supplier', 'Refund', 'Reimbursement', 'Deposit'].includes(type);
      financialSection.classList.toggle('show', showFinancial);
      
      // Supplier section only for Supplier type
      supplierSection.classList.toggle('show', type === 'Supplier');

      // Update required fields
      if (type === 'Supplier') {
        document.getElementById('supplierEmail').required = true;
        document.getElementById('supplierPhone').required = true;
        document.getElementById('supplierName').required = true;
      } else {
        document.getElementById('supplierEmail').required = false;
        document.getElementById('supplierPhone').required = false;
        document.getElementById('supplierName').required = false;
      }

      // Update financial fields requirement
      document.getElementById('amount').required = showFinancial;
    }

    // Amount Calculations
    function setupAmountCalculations() {
      const amountInput = document.getElementById('amount');
      const gstInput = document.getElementById('gstAmount');
      const totalInput = document.getElementById('totalAmount');

      amountInput.addEventListener('input', () => {
        const amount = parseFloat(amountInput.value) || 0;
        const gst = amount * 0.15; // 15% GST
        const total = amount + gst;

        gstInput.value = gst.toFixed(2);
        totalInput.value = total.toFixed(2);
      });
    }

    // Quick Fill Templates
    function quickFill(template) {
      const templates = {
        'tyre-change': {
          fault: 'Flat tyre',
          serviceRequired: 'Tyre change service',
          type: 'Billable'
        },
        'jump-start': {
          fault: 'Dead battery',
          serviceRequired: 'Jump start service',
          type: 'Billable'
        },
        'fuel-delivery': {
          fault: 'Out of fuel',
          serviceRequired: 'Fuel delivery',
          type: 'Billable'
        },
        'lockout': {
          fault: 'Keys locked in vehicle',
          serviceRequired: 'Vehicle unlock service',
          type: 'Billable'
        },
        'towing': {
          fault: 'Vehicle breakdown',
          serviceRequired: 'Towing service',
          type: 'Billable'
        },
        // Coolth-specific templates
        'fridge-emergency': {
          fault: 'Fridge not cooling - food at risk',
          serviceRequired: 'Emergency refrigeration repair',
          type: 'Billable',
          amount: 349
        },
        'freezer-breakdown': {
          fault: 'Freezer defrosting - stock spoiling',
          serviceRequired: 'Emergency freezer repair',
          type: 'Billable',
          amount: 349
        },
        'commercial-chiller': {
          fault: 'Commercial chiller failure',
          serviceRequired: 'Priority commercial refrigeration service',
          type: 'Billable',
          amount: 549
        },
        'hvac-maintenance': {
          fault: 'Scheduled HVAC maintenance',
          serviceRequired: 'Heat pump/AC service - Full system check',
          type: 'Billable',
          amount: 450
        }
      };

      const data = templates[template];
      if (data) {
        document.getElementById('fault').value = data.fault;
        document.getElementById('serviceRequired').value = data.serviceRequired;
        if (data.amount) {
          document.getElementById('amount').value = data.amount;
          // Trigger GST calculation
          const event = new Event('input', { bubbles: true });
          document.getElementById('amount').dispatchEvent(event);
        }
        selectType(data.type);
        showSuccess('Template applied');
      }
    }

    // Form Submission
    async function handleSubmit(event) {
      event.preventDefault();
      
      if (!validateForm()) return;

      showLoading(true);

      try {
        const formData = collectFormData();
        
        // Add system-generated fields
        formData.Id = generateJobId();
        formData.StartTime = new Date().toISOString();
        formData.FPStaffEmail = currentUser.username;
        formData.Client = currentClient === 'eek' ? 'EEK Mechanical' : 'Coolth Tech';
        formData.Status = 'Active'; // Initial status

        // Map to appropriate output based on type
        const outputMapping = getOutputMapping(formData.Type);
        formData.OutputTo = outputMapping;

        // Submit to SharePoint
        await submitToSharePoint(formData);
        
        showSuccess('Job submitted successfully!');
        clearForm();
        
        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = '/admin/jobs';
        }, 2000);

      } catch (error) {
        console.error('Submission error:', error);
        showError('Failed to submit job. Please try again.');
      } finally {
        showLoading(false);
      }
    }

    function generateJobId() {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000);
      return `FP${timestamp}${random}`;
    }

    function getOutputMapping(type) {
      const mapping = {
        'Billable': 'Chargables',
        'Supplier': 'Costings',
        'Refund': 'Reimbursement',
        'Reimbursement': 'Reimbursement',
        'Deposit': 'Reimbursement',
        'Warranty': 'NoCharge',
        'Internal': 'NoCharge',
        'Other': 'NoCharge'
      };
      return mapping[type] || 'NoCharge';
    }

    function collectFormData() {
      const formData = {};
      const form = document.getElementById('jobForm');
      
      // Collect all form inputs
      const inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        if (input.name) {
          if (input.type === 'checkbox') {
            formData[input.name] = input.checked;
          } else if (input.value) {
            formData[input.name] = input.value;
          }
        }
      });

      // Handle client-specific primary identifier
      if (currentClient === 'coolth') {
        // For Coolth: Invoice identifier is primary, Rego is optional
        formData.InvoiceIdentifier = document.getElementById('invoiceIdentifier').value;
        formData.PrimaryReference = formData.InvoiceIdentifier;
        // Rego can still be captured if provided
        if (document.getElementById('rego').value) {
          formData.Rego = document.getElementById('rego').value;
        }
      } else {
        // For EEK: Rego is primary identifier
        formData.PrimaryReference = formData.Rego;
      }

      // Add calculated GST amount if applicable
      if (formData.Amount) {
        formData.GSTEXCL = parseFloat(formData.Amount);
        const gst = formData.GSTEXCL * 0.15;
        formData.GSTAmount = gst;
        formData.TotalIncGST = formData.GSTEXCL + gst;
      }

      // Add completion time for certain statuses
      if (document.getElementById('closePostFlag').checked) {
        formData.CompletionTime = new Date().toISOString();
      }

      return formData;
    }

    function validateForm() {
      const form = document.getElementById('jobForm');
      
      // Check HTML5 validation
      if (!form.checkValidity()) {
        form.reportValidity();
        return false;
      }

      // Check type selection
      if (!selectedType) {
        showError('Please select a job type');
        document.getElementById('typeSelector').scrollIntoView({ behavior: 'smooth' });
        return false;
      }

      // Client-specific validation
      if (currentClient === 'eek') {
        // EEK requires Rego as primary identifier
        if (!document.getElementById('rego').value) {
          showError('Vehicle registration is required for EEK Mechanical');
          document.getElementById('rego').focus();
          return false;
        }
      } else if (currentClient === 'coolth') {
        // Coolth requires invoice identifier, Rego is optional
        if (!document.getElementById('invoiceIdentifier').value) {
          showError('Invoice identifier is required for Coolth Tech');
          document.getElementById('invoiceIdentifier').focus();
          return false;
        }
      }

      // Supplier validation
      if (selectedType === 'Supplier') {
        const requiredSupplierFields = ['supplierName', 'supplierEmail', 'supplierPhone'];
        for (const fieldId of requiredSupplierFields) {
          if (!document.getElementById(fieldId).value) {
            showError('All supplier fields are required for Supplier type jobs');
            document.getElementById(fieldId).focus();
            return false;
          }
        }
      }

      // Financial validation for applicable types
      if (['Billable', 'Supplier', 'Refund', 'Reimbursement', 'Deposit'].includes(selectedType)) {
        if (!document.getElementById('amount').value || parseFloat(document.getElementById('amount').value) <= 0) {
          showError('Please enter a valid amount for this job type');
          document.getElementById('amount').focus();
          return false;
        }
      }

      return true;
    }

    // SharePoint Integration
    async function submitToSharePoint(data) {
      const token = await getGraphToken();
      
      // Get site and list IDs
      const site = await fetchJson(
        `https://graph.microsoft.com/v1.0/sites/${SPO_HOST}:${SPO_SITE_PATH}`,
        token
      );

      // Submit to main job list
      const mainLists = await fetchJson(
        `https://graph.microsoft.com/v1.0/sites/${site.id}/lists?$filter=displayName eq '${SPO_LIST_TITLE}'`,
        token
      );

      if (!mainLists.value?.length) {
        throw new Error('SharePoint list not found');
      }

      const mainListId = mainLists.value[0].id;

      // Create main job item
      const response = await fetch(
        `https://graph.microsoft.com/v1.0/sites/${site.id}/lists/${mainListId}/items`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fields: data })
        }
      );

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`SharePoint error: ${error}`);
      }

      const result = await response.json();

      // Log to Job Build activity log
      await logActivity(site.id, token, {
        JobIDRego: currentClient === 'eek' ? data.Rego : data.InvoiceIdentifier,
        TypeText: `${data.Type} Job Created`,
        Actor: currentUser.username,
        When: new Date().toISOString(),
        Details: `New ${data.Type} job for ${data.CustomerName}. Service: ${data.ServiceRequired}. ${data.Fault || ''}`,
        CostIfAny: data.Amount || null,
        Status: data.Status || 'Active'
      });

      return result;
    }

    async function logActivity(siteId, token, activityData) {
      try {
        // Find Job Build list
        const activityLists = await fetchJson(
          `https://graph.microsoft.com/v1.0/sites/${siteId}/lists?$filter=displayName eq 'Job Build'`,
          token
        );

        if (activityLists.value?.length) {
          const activityListId = activityLists.value[0].id;
          
          await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${activityListId}/items`,
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ fields: activityData })
            }
          );
        }
      } catch (error) {
        console.warn('Failed to log activity:', error);
        // Don't fail the main submission if activity logging fails
      }
    }

    async function getGraphToken() {
      const request = {
        scopes: ['https://graph.microsoft.com/Sites.ReadWrite.All'],
        account: currentUser
      };

      try {
        const response = await msalInstance.acquireTokenSilent(request);
        return response.accessToken;
      } catch (error) {
        // Token refresh needed
        const response = await msalInstance.acquireTokenPopup(request);
        return response.accessToken;
      }
    }

    async function fetchJson(url, token) {
      const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      return response.json();
    }

    // Utility Functions
    function clearForm() {
      document.getElementById('jobForm').reset();
      selectedType = null;
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.conditional-section').forEach(section => section.classList.remove('show'));
      generateCoolthIdentifier();
      clearDraft();
    }

    function saveDraft() {
      const formData = collectFormData();
      formData.selectedType = selectedType;
      formData.currentClient = currentClient;
      localStorage.setItem('jobFormDraft', JSON.stringify(formData));
      showSuccess('Draft saved');
    }

    function loadDraft() {
      const draft = localStorage.getItem('jobFormDraft');
      if (draft) {
        try {
          const data = JSON.parse(draft);
          
          // Restore client
          if (data.currentClient) {
            selectClient(data.currentClient);
          }

          // Restore fields
          Object.keys(data).forEach(key => {
            const input = document.querySelector(`[name="${key}"]`);
            if (input) {
              if (input.type === 'checkbox') {
                input.checked = data[key];
              } else {
                input.value = data[key];
              }
            }
          });

          // Restore type
          if (data.selectedType) {
            selectType(data.selectedType);
          }

          showSuccess('Draft restored');
        } catch (error) {
          console.error('Failed to load draft:', error);
        }
      }
    }

    function clearDraft() {
      localStorage.removeItem('jobFormDraft');
    }

    // Keyboard Shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ctrl+Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('jobForm').requestSubmit();
        }
        
        // Esc to clear focus
        if (e.key === 'Escape') {
          document.activeElement.blur();
        }

        // Alt+1-8 for type selection
        if (e.altKey && e.key >= '1' && e.key <= '8') {
          const types = ['Billable', 'Supplier', 'Refund', 'Reimbursement', 'Deposit', 'Warranty', 'Internal', 'Other'];
          const index = parseInt(e.key) - 1;
          if (types[index]) {
            selectType(types[index]);
          }
        }
      });

      // Auto-save draft every 30 seconds
      setInterval(() => {
        if (document.querySelector('input:focus, textarea:focus')) {
          saveDraft();
        }
      }, 30000);
    }

    // UI Functions
    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    function showMessage(message, type) {
      const messageEl = document.getElementById(`${type}Message`);
      messageEl.textContent = message;
      messageEl.classList.add('show');
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 5000);
    }

    function showSuccess(message) { showMessage(message, 'success'); }
    function showError(message) { showMessage(message, 'error'); }
    function showWarning(message) { showMessage(message, 'warning'); }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', initialize);

    // Prevent accidental navigation
    window.addEventListener('beforeunload', (e) => {
      const form = document.getElementById('jobForm');
      const hasData = Array.from(form.elements).some(el => 
        el.type !== 'submit' && el.type !== 'button' && el.value
      );
      
      if (hasData) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      }
    });
  </script>
  
  <!-- Custom command handling for New Job Form -->
  <script>
    // Handle commands specific to the New Job Form page
    window.fpHandleCommand = function(command) {
      switch(command) {
        case 'Triage Form':
          // This IS the triage form, so maybe switch to a specific section
          document.getElementById('typeSelector').scrollIntoView({ behavior: 'smooth' });
          showSuccess('Showing job type selection for triage');
          break;
        case 'Submit Job':
          // Submit the current form
          document.getElementById('jobForm').requestSubmit();
          break;
        case 'Clear Form':
          if (confirm('Clear all form data?')) {
            clearForm();
            showSuccess('Form cleared');
          }
          break;
        case 'Save Draft':
          saveDraft();
          break;
        case 'Load Draft':
          loadDraft();
          break;
        case 'Switch to EEK':
          selectClient('eek');
          break;
        case 'Switch to Coolth':
          selectClient('coolth');
          break;
        case 'Quick Fill Tyre Change':
          quickFill('tyre-change');
          break;
        case 'Quick Fill Jump Start':
          quickFill('jump-start');
          break;
        case 'Quick Fill Fuel Delivery':
          quickFill('fuel-delivery');
          break;
        case 'Quick Fill Lockout':
          quickFill('lockout');
          break;
        case 'Quick Fill Towing':
          quickFill('towing');
          break;
        case 'Quick Fill Fridge Emergency':
          if (currentClient === 'coolth') {
            quickFill('fridge-emergency');
          } else {
            selectClient('coolth');
            setTimeout(() => quickFill('fridge-emergency'), 100);
          }
          break;
        case 'Set Job Type Billable':
          selectType('Billable');
          break;
        case 'Set Job Type Supplier':
          selectType('Supplier');
          break;
        case 'Set Job Type Warranty':
          selectType('Warranty');
          break;
        case 'Focus Customer Name':
          document.getElementById('customerName').focus();
          break;
        case 'Focus Customer Phone':
          document.getElementById('customerPhone').focus();
          break;
        case 'Focus Fault Description':
          document.getElementById('fault').focus();
          break;
        case 'Generate New Identifier':
          if (currentClient === 'coolth') {
            generateCoolthIdentifier();
            showSuccess('New Coolth identifier generated');
          } else {
            showWarning('Identifier generation only available for Coolth Tech');
          }
          break;
        case 'Calculate GST':
          const amountField = document.getElementById('amount');
          if (amountField.value) {
            const event = new Event('input', { bubbles: true });
            amountField.dispatchEvent(event);
            showSuccess('GST calculated');
          } else {
            showWarning('Enter an amount first');
          }
          break;
        case 'Add Supplier':
          selectType('Supplier');
          document.getElementById('supplierName').focus();
          showSuccess('Switched to supplier job type');
          break;
        default:
          showSuccess(`Command: ${command}`);
      }
    };
  </script>
</body>
</html>
