<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Job | FormanPacific Service Management</title>
  <meta name="description" content="Update job details and status">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- MSAL -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  
  <!-- Standardized Data Schema -->
  <script src="/assets/js/fp-data-schema.js"></script>
  
  <!-- Standardized Admin Styles -->
  <link rel="stylesheet" href="/assets/css/fp-admin-styles.css">
  
  <!-- Mobile-First Styles -->
  <link rel="stylesheet" href="/assets/css/fp-mobile-styles.css">
  
  <!-- Command Menu -->
  <script src="/assets/js/fp-menu-loader.js"></script>

  <style>
    /* Page-specific styles */
    .page-container { display: none; min-height: 100vh; }
    .page-container.authenticated { display: block; }
    
    .job-details { display: none; }
    .job-details.show { display: block; }
    
    .card-title { font-size: 24px; font-weight: 600; margin-bottom: 20px; color: #1f2937; }
    
    /* Mobile-specific adjustments */
    @media (max-width: 768px) {
      .card-title { font-size: 20px; }
      .header-content h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading">
    <div class="spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Main Page -->
  <div id="pageContainer" class="page-container">
    <div class="header">
      <div class="header-content">
        <div class="logo">FP</div>
        <h1>Update Job</h1>
        <div class="user-info">
          <span id="userName">Loading...</span>
          <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="card">
        <h2 class="card-title">Update Job Details</h2>
        
        <div id="alertContainer"></div>
        
        <div class="form-group">
          <label class="form-label">Select Job Registration</label>
          <p style="color: #64748b; margin-bottom: 16px;">Click the button below to select a job from the available jobs list.</p>
        </div>

        <button class="btn-submit" onclick="openJobPicker()">Select Job Registration</button>
      </div>

      <div id="jobDetails" class="job-details">
        <div class="card">
          <h2 class="card-title">Job Information</h2>
          <div id="jobInfo" class="detail-grid"></div>
          
          <div class="form-group">
            <label class="form-label" for="updateNotes">Update Notes *</label>
            <textarea id="updateNotes" class="form-input" rows="4" placeholder="Enter update details..." required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="newStatus">New Status</label>
            <select id="newStatus" class="form-input">
              <option value="">Select new status...</option>
              <option value="Open">Open</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Blocked">Blocked</option>
            </select>
          </div>

          <button class="btn-submit" onclick="updateJob()">Update Job</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Picker Modal -->
  <iframe id="jobPickerFrame" src="/admin/job-picker-modal.html" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10000; border: none; background: rgba(0,0,0,0.6);"></iframe>

  <script>
    let msalInstance = null;
    let currentJob = null;

    const msalConfig = {
      auth: {
        clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
        authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
        redirectUri: window.location.origin + '/admin'
      },
      cache: { cacheLocation: 'sessionStorage' }
    };

    const GRAPH_SCOPES = ['https://graph.microsoft.com/Sites.Read.All'];

    async function initAuth() {
      try {
        if (!window.msal || !msal.PublicClientApplication) {
          console.error('MSAL failed to load.');
          return false;
        }

        msalInstance = new msal.PublicClientApplication(msalConfig);
        if (msalInstance.initialize) {
          await msalInstance.initialize();
        }

        const redirectResponse = await msalInstance.handleRedirectPromise();
        if (redirectResponse?.account) {
          msalInstance.setActiveAccount(redirectResponse.account);
        }

        const accounts = msalInstance.getAllAccounts();
        if (!accounts.length) {
          await msalInstance.loginRedirect({ scopes: GRAPH_SCOPES });
          return false;
        }

        msalInstance.setActiveAccount(accounts[0]);
        
        // Make MSAL instance available to iframes
        window.msalInstance = msalInstance;
        
        return true;
      } catch (e) {
        console.error('Auth init error:', e);
        return false;
      }
    }

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    function openJobPicker() {
      const iframe = document.getElementById('jobPickerFrame');
      iframe.style.display = 'block';
      iframe.contentWindow.postMessage({
        type: 'OPEN_PICKER',
        options: { filterPPI: false }
      }, '*');
    }

    function closeJobPicker() {
      const iframe = document.getElementById('jobPickerFrame');
      iframe.style.display = 'none';
    }

    function handleJobSelected(jobData) {
      currentJob = jobData;
      displayJobDetails(jobData);
      document.getElementById('jobDetails').classList.add('show');
      showAlert('Job details loaded successfully', 'success');
      closeJobPicker();
    }

    // Listen for messages from job picker
    window.addEventListener('message', function(event) {
      if (event.data.type === 'JOB_SELECTED') {
        handleJobSelected(event.data.job);
      } else if (event.data.type === 'JOB_PICKER_CLOSED') {
        closeJobPicker();
      } else if (event.data.type === 'REQUEST_JOBS_DATA') {
        // Handle request for jobs data from iframe
        fetchJobsDataForPicker();
      }
    });

    // Fetch jobs data for the picker iframe
    async function fetchJobsDataForPicker() {
      try {
        showAlert('Loading jobs data...', 'info');
        
        // Use the same SharePoint fetching logic as other pages
        const SPO_HOST = 'roadandrescue.sharepoint.com';
        const SPO_SITE_PATH = '/sites/rar';
        const SPO_LIST_TITLE = 'Forman Pacific Consolidated';
        
        console.log('Getting Graph token...');
        const token = await getGraphToken();
        console.log('Token obtained, fetching site...');
        
        // Get site
        const siteUrl = `https://graph.microsoft.com/v1.0/sites/${SPO_HOST}:${SPO_SITE_PATH}`;
        const siteResponse = await fetch(siteUrl, { headers: { Authorization: `Bearer ${token}` }});
        const site = await siteResponse.json();
        
        console.log('Site response:', site);
        
        if (!site.id) {
          throw new Error('Failed to get site ID from SharePoint. Response: ' + JSON.stringify(site));
        }
        
        // Get list
        const listNameOData = SPO_LIST_TITLE.replace(/'/g, "''");
        const listsUrl = `https://graph.microsoft.com/v1.0/sites/${site.id}/lists?$filter=displayName eq '${listNameOData}'`;
        const listsResponse = await fetch(listsUrl, { headers: { Authorization: `Bearer ${token}` }});
        const listsData = await listsResponse.json();
        
        if (!listsData.value || listsData.value.length === 0) {
          throw new Error(`List '${SPO_LIST_TITLE}' not found`);
        }
        
        const listId = listsData.value[0].id;
        
        // Get items
        let allItems = [];
        let nextLink = `https://graph.microsoft.com/v1.0/sites/${site.id}/lists/${listId}/items?$expand=fields&$top=999`;
        
        while (nextLink) {
          const response = await fetch(nextLink, { headers: { Authorization: `Bearer ${token}` }});
          const data = await response.json();
          
          if (data.value) {
            allItems = allItems.concat(data.value);
          }
          
          nextLink = data['@odata.nextLink'] || null;
        }
        
        const jobs = allItems.map(item => item.fields);
        
        // Send jobs data to iframe
        const iframe = document.getElementById('jobPickerFrame');
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({
            type: 'JOBS_DATA_RESPONSE',
            jobs: jobs
          }, '*');
        }
        
        showAlert('Jobs data loaded successfully', 'success');
      } catch (error) {
        console.error('Failed to fetch jobs data:', error);
        showAlert('Failed to load jobs data: ' + error.message, 'error');
      }
    }

    // Get Graph API token
    async function getGraphToken() {
      const account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
      if (!account) throw new Error('No signed-in account');

      const request = { scopes: GRAPH_SCOPES, account };
      try {
        const { accessToken } = await msalInstance.acquireTokenSilent(request);
        return accessToken;
      } catch (err) {
        console.warn('Silent token failed; attempting interactive', err);
        const resp = await msalInstance.acquireTokenPopup({ scopes: GRAPH_SCOPES });
        return resp?.accessToken || '';
      }
    }

    function displayJobDetails(job) {
      const container = document.getElementById('jobInfo');
      container.innerHTML = `
        <div class="detail-item">
          <div class="detail-label">Job ID</div>
          <div class="detail-value fp-job-id">${job.Id || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Registration</div>
          <div class="detail-value fp-vehicle-rego">${job.Rego || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Customer</div>
          <div class="detail-value fp-user">${job.CustomerName || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Phone</div>
          <div class="detail-value fp-phone">${job.CallerPhone || job.CustomerPhone || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Service Type</div>
          <div class="detail-value">${job.ServiceType || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Location</div>
          <div class="detail-value fp-location">${job.CustomerLocation || job.CustomerAddress || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Status</div>
          <div class="detail-value">${job.JobStatus || job.Status || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Price</div>
          <div class="detail-value fp-currency">${job.Price ? FP_DATA.FORMATTERS.currency(job.Price) : 'N/A'}</div>
        </div>
      `;
    }

    async function updateJob() {
      const notes = document.getElementById('updateNotes').value.trim();
      const newStatus = document.getElementById('newStatus').value;

      if (!notes) {
        showAlert('Please enter update notes', 'error');
        return;
      }

      if (!currentJob) {
        showAlert('No job loaded', 'error');
        return;
      }

      try {
        showAlert('Updating job...', 'info');

        // Prepare data packet for Power Automate
        const updateData = {
          commandNumber: 5,
          formType: 'UpdateJob',
          data: {
            jobId: currentJob.Id,
            vehicleRego: currentJob.Rego,
            customerName: currentJob.CustomerName,
            updateNotes: notes,
            newStatus: newStatus || currentJob.JobStatus || currentJob.Status,
            updatedBy: msalInstance.getActiveAccount()?.username || 'Unknown',
            updatedAt: new Date().toISOString()
          }
        };

        // Send to Power Automate
        const response = await fetch('https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e1adbceb52c94e07b923228a8c05d29d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_ok7gvPEZKmPw9q2jiKY9Msqofd65YeMtuGfSjEqxJ4', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updateData)
        });

        if (!response.ok) {
          throw new Error(`Update failed: ${response.status}`);
        }

        showAlert('Job updated successfully!', 'success');
        
        // Reset form
        document.getElementById('updateNotes').value = '';
        document.getElementById('newStatus').value = '';
        document.getElementById('jobDetails').classList.remove('show');
        
      } catch (error) {
        showAlert('Failed to update job: ' + error.message, 'error');
      }
    }

    function logout() {
      if (msalInstance) {
        msalInstance.logoutRedirect();
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', async function() {
      const authenticated = await initAuth();
      if (authenticated) {
        document.getElementById('loadingScreen').classList.add('authenticated');
        document.getElementById('pageContainer').classList.add('authenticated');
        document.getElementById('userName').textContent = msalInstance.getActiveAccount()?.name || 'User';
      } else {
        window.location.href = '/admin';
      }
    });
  </script>
</body>
</html>
