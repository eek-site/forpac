<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Login | FormanPacific</title>
  <meta name="description" content="Secure administrator access portal for FormanPacific service claims management platform" />
  <meta name="robots" content="noindex, nofollow" />

  <!-- Microsoft Authentication Library -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <style>
    /* (styles unchanged) */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--primary-color:#1e3c72;--primary-dark:#152a52;--secondary-color:#2a5298;--success-color:#22c55e;--error-color:#ef4444;--warning-color:#f59e0b;--text-primary:#1e293b;--text-secondary:#64748b;--border-color:#e2e8f0;--bg-light:#f8fafc}
    body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}
    .bg-pattern{position:absolute;width:100%;height:100%;opacity:.1;background-image:radial-gradient(circle at 20% 80%,#fff 0%,transparent 50%),radial-gradient(circle at 80% 20%,#fff 0%,transparent 50%),radial-gradient(circle at 40% 40%,#fff 0%,transparent 50%);animation:float 20s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translate(0,0) rotate(0)}33%{transform:translate(-20px,-20px) rotate(1deg)}66%{transform:translate(20px,-10px) rotate(-1deg)}}
    .login-container{background:#fff;border-radius:24px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);width:100%;max-width:460px;padding:48px 40px;animation:slideUp .6s cubic-bezier(.34,1.56,.64,1);position:relative;z-index:1}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .logo-section{text-align:center;margin-bottom:32px}
    .logo{width:90px;height:90px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border-radius:20px;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:40px;margin-bottom:24px;box-shadow:0 10px 25px -5px rgba(30,60,114,.3);position:relative;overflow:hidden}
    .logo::after{content:"";position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,.1),transparent);transform:rotate(45deg);animation:shine 3s infinite}
    @keyframes shine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}100%{transform:translateX(100%) translateY(100%) rotate(45deg)}}
    h1{color:var(--text-primary);font-size:32px;font-weight:700;margin-bottom:8px;letter-spacing:-.5px}
    .subtitle{color:var(--text-secondary);font-size:16px}
    .divider{position:relative;margin:32px 0;text-align:center}
    .divider::before{content:"";position:absolute;top:50%;left:0;right:0;height:1px;background:var(--border-color)}
    .divider span{background:#fff;padding:0 16px;color:var(--text-secondary);font-size:14px;position:relative}
    .login-methods{display:flex;flex-direction:column;gap:12px}
    .login-button{width:100%;padding:16px;background:#fff;border:2px solid var(--border-color);border-radius:12px;font-size:16px;font-weight:600;color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .2s ease;position:relative;overflow:hidden}
    .login-button:hover{background:var(--bg-light);border-color:var(--primary-color);transform:translateY(-2px);box-shadow:0 8px 16px -4px rgba(30,60,114,.15)}
    .login-button:active{transform:translateY(0);box-shadow:0 2px 4px -1px rgba(30,60,114,.1)}
    .login-button.primary{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border:none}
    .login-button.primary:hover{background:linear-gradient(135deg,var(--primary-dark),var(--primary-color));transform:translateY(-2px)}
    .login-button:disabled{opacity:.6;cursor:not-allowed;transform:none!important}
    .microsoft-logo{width:20px;height:20px}
    .message{padding:14px 16px;border-radius:10px;margin-top:20px;font-size:14px;display:none;animation:slideDown .3s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .error-message{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .success-message{background:#f0fdf4;border:1px solid #bbf7d0;color:#14532d}
    .warning-message{background:#fffbeb;border:1px solid #fed7aa;color:#92400e}
    .info-message{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
    .loading{display:none;text-align:center;padding:20px}
    .loading.active{display:block}
    .spinner{width:48px;height:48px;border:4px solid var(--border-color);border-top:4px solid var(--primary-color);border-radius:50%;animation:spin 1s cubic-bezier(.68,-.55,.265,1.55) infinite;margin:20px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .security-features{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:24px;padding-top:24px;border-top:1px solid var(--border-color)}
    .security-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary)}
    .security-icon{width:16px;height:16px;color:var(--success-color)}
    .footer-links{display:flex;justify-content:center;gap:24px;margin-top:24px;padding-top:24px;border-top:1px solid var(--border-color)}
    .footer-links a{color:var(--text-secondary);text-decoration:none;font-size:14px;transition:color .2s ease}
    .footer-links a:hover{color:var(--primary-color)}
    .popup-notice{background:var(--info-message);padding:12px;border-radius:8px;margin-top:16px;font-size:13px;color:var(--text-primary);display:none}
    .popup-notice.show{display:block}
    .session-warning{position:fixed;top:20px;right:20px;background:var(--warning-color);color:#fff;padding:16px 20px;border-radius:10px;display:none;animation:slideInRight .3s ease;box-shadow:0 10px 25px -5px rgba(245,158,11,.3)}
    @keyframes slideInRight{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
    @media (max-width:480px){.login-container{padding:32px 24px}h1{font-size:28px}.security-features{grid-template-columns:1fr}.footer-links{flex-direction:column;align-items:center;gap:12px}}
    @media (prefers-color-scheme:dark){:root{--bg-light:#1e293b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border-color:#334155}.login-container{background:#0f172a;box-shadow:0 20px 25px -5px rgba(0,0,0,.5)}.login-button{background:#1e293b;border-color:#334155}.login-button:hover{background:#334155}.divider span{background:#0f172a}}
  </style>
</head>
<body>
  <div class="bg-pattern"></div>

  <div class="login-container">
    <div class="logo-section">
      <div class="logo">FP</div>
      <h1>Admin Portal</h1>
      <p class="subtitle">Secure access for administrators</p>
    </div>

    <div class="divider"><span>Sign in with</span></div>

    <div class="login-methods">
      <button id="primaryLoginBtn" class="login-button primary" onclick="signIn()">
        <svg class="microsoft-logo" viewBox="0 0 21 21">
          <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
          <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
          <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
          <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
        </svg>
        Microsoft Work Account
      </button>

      <button id="alternativeLoginBtn" class="login-button" onclick="alternativeLogin()">
        <svg class="microsoft-logo" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11H3v2h6v-2zm0-4H3v2h6V7zm0 8H3v2h6v-2zm12-8h-6v2h6V7zm0 4h-6v2h6v-2zm0 4h-6v2h6v-2z"/>
        </svg>
        Microsoft Forms Portal
      </button>
    </div>

    <div id="popupNotice" class="popup-notice">
      <strong>Popup blocked?</strong> Please allow popups for this site or click the sign-in button again to use redirect.
    </div>

    <div id="errorMessage" class="message error-message"></div>
    <div id="successMessage" class="message success-message"></div>
    <div id="warningMessage" class="message warning-message"></div>
    <div id="infoMessage" class="message info-message"></div>

    <div id="loadingIndicator" class="loading">
      <div class="spinner"></div>
      <p style="color:var(--text-secondary);margin-top:16px">Authenticating your credentials...</p>
    </div>

    <div class="security-features">
      <div class="security-item">
        <svg class="security-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z"/></svg>
        <span>256-bit encryption</span>
      </div>
      <div class="security-item">
        <svg class="security-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg>
        <span>Single Sign-On</span>
      </div>
      <div class="security-item">
        <svg class="security-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/></svg>
        <span>Activity monitoring</span>
      </div>
      <div class="security-item">
        <svg class="security-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>
        <span>Compliance verified</span>
      </div>
    </div>

    <div class="footer-links">
      <a href="/">Home</a>
      <a href="/support">Support</a>
      <a href="/privacy">Privacy</a>
    </div>
  </div>

  <div id="sessionWarning" class="session-warning">
    Your session will expire in 5 minutes. Please complete your login.
  </div>

  <script>
    // --- Safety: work even if MSAL CDN fails ---
    const LogLevel = (window.msal && window.msal.LogLevel) ? window.msal.LogLevel
      : { Error: 0, Warning: 1, Info: 2, Verbose: 3 };

    let msalInstance=null, authInProgress=false, popupBlocked=false;
    let sessionTimer, warningTimer;

    const msalConfig={
      auth:{
        clientId:'d67be044-6aaa-4d01-ada2-da0cc50d2034',
        authority:'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
        redirectUri: window.location.origin + '/admin',
        navigateToLoginRequestUrl:false
      },
      cache:{cacheLocation:'sessionStorage',storeAuthStateInCookie:true},
      system:{
        windowHashTimeout:60000,iframeHashTimeout:60000,loadFrameTimeout:10000,
        loggerOptions:{
          loggerCallback:(level,message,containsPii)=>{
            if(containsPii) return;
            if(message?.includes('monitorPopupForHash') && message?.includes('window closed')){
              if(!popupBlocked){ showWarning('Sign-in window was closed. Please try again.'); }
              authInProgress=false; enableButtons(); return;
            }
            if(level===LogLevel.Error) console.error('[MSAL Error]',message);
            else if(level===LogLevel.Warning) console.warn('[MSAL Warning]',message);
            else if(level===LogLevel.Info) console.info('[MSAL Info]',message);
          },
          logLevel: LogLevel.Warning
        }
      }
    };

    const loginRequest={scopes:['openid','profile','user.read'],prompt:'select_account'};

    function startSessionTimer(){
      clearTimeout(sessionTimer); clearTimeout(warningTimer);
      warningTimer=setTimeout(()=>{document.getElementById('sessionWarning').style.display='block';},25*60*1000);
      sessionTimer=setTimeout(()=>{signOut();},30*60*1000);
    }

    function handleResponse(response){
      if(response){
        const account=response.account;
        msalInstance.setActiveAccount(account);
        sessionStorage.setItem('msalAccount', JSON.stringify(account));
        showSuccess(`Welcome, ${account.name || 'user'}! Redirecting to dashboard...`);
        startSessionTimer();
        setTimeout(()=>{ window.location.href='/admin/dashboard'; },1500);
      }
    }

    async function initializeMsal(){
      try{
        if(!window.msal || !window.msal.PublicClientApplication){
          showError('Microsoft sign-in library failed to load. Please check your connection or try again.');
          return;
        }
        msalInstance=new msal.PublicClientApplication(msalConfig);

        // initialize() exists on newer versions; guard in case it’s undefined
        if (typeof msalInstance.initialize === 'function') {
          await msalInstance.initialize();
        }

        // Complete redirect if returning from AAD
        const response = await msalInstance.handleRedirectPromise();
        if(response){ handleResponse(response); return; }

        checkExistingSession();
      }catch(error){
        console.error('MSAL initialization error:',error);
        showError('Authentication system initialization failed. Please refresh the page.');
      }
    }

    function checkExistingSession(){
      if(!msalInstance) return;
      const active=msalInstance.getActiveAccount();
      const accounts=msalInstance.getAllAccounts();
      const account=active || accounts[0];
      if(account){
        msalInstance.setActiveAccount(account);
        showSuccess('You are already signed in. Redirecting...');
        setTimeout(()=>{ window.location.href='/admin/dashboard'; },1000);
      }
    }

    async function signIn(){
      if(authInProgress){ showInfo('Authentication already in progress. Please wait...'); return; }
      hideAllMessages(); document.getElementById('popupNotice').classList.remove('show');

      if(!window.msal || !msalInstance){
        showError('Sign-in is unavailable (MSAL not loaded). Please refresh and try again.');
        return;
      }

      authInProgress=true; popupBlocked=false; disableButtons();
      const loadingDiv=document.getElementById('loadingIndicator'); loadingDiv.classList.add('active');

      try{
        const popupResponse=await attemptPopupLogin();
        if(popupResponse){ handleResponse(popupResponse); }
      }catch(error){
        if(error?.errorCode==='popup_window_error' || popupBlocked){
          try{ await msalInstance.loginRedirect(loginRequest); }catch(re){ handleAuthError(re); }
        }else{
          handleAuthError(error);
        }
      }finally{
        loadingDiv.classList.remove('active');
        authInProgress=false; enableButtons();
      }
    }

    async function attemptPopupLogin(){
      // Test for popup blockers
      const testPopup=window.open('','_blank','width=1,height=1,left=10000,top=10000');
      if(!testPopup || testPopup.closed || typeof testPopup.closed==='undefined'){
        popupBlocked=true; document.getElementById('popupNotice').classList.add('show');
        const err = new Error('popup_window_error'); err.errorCode='popup_window_error'; throw err;
      }
      testPopup.close();
      return await msalInstance.loginPopup(loginRequest);
    }

    function handleAuthError(error){
      console.error('Authentication error:',error);
      const code = error?.errorCode || '';
      const msg  = (error?.errorMessage || error?.message || '').toLowerCase();

      if(code==='user_cancelled' || msg.includes('user_cancelled')){
        showWarning('Sign-in cancelled. Please try again when ready.');
      }else if(code==='interaction_in_progress'){
        showWarning('Another sign-in is in progress. Please wait…');
      }else if(code==='popup_window_error' || popupBlocked){
        showInfo('Popup was blocked. Click the sign-in button again to use redirect method.');
        document.getElementById('popupNotice').classList.add('show');
      }else if(code==='network_error' || msg.includes('network')){
        showError('Network error. Please check your internet connection.');
      }else if(code==='consent_required'){
        showWarning('Additional permissions required. Please try again.');
      }else if(code==='login_required'){
        showWarning('Login required. Please sign in.');
      }else{
        showError('Authentication failed. Please try again or contact support.');
      }
    }

    function signOut(){
      const account = msalInstance?.getActiveAccount() || msalInstance?.getAllAccounts?.()[0];
      if(account){
        msalInstance.logoutRedirect({account, postLogoutRedirectUri: window.location.origin + '/admin'});
      }
      sessionStorage.clear();
    }

    function alternativeLogin(){
      showWarning('Redirecting to Microsoft Forms portal...');
      setTimeout(()=>{ window.location.href='https://forms.office.com/?login_hint=zx@roadandrescue.com'; },1000);
    }

    function disableButtons(){document.getElementById('primaryLoginBtn').disabled=true;document.getElementById('alternativeLoginBtn').disabled=true;}
    function enableButtons(){document.getElementById('primaryLoginBtn').disabled=false;document.getElementById('alternativeLoginBtn').disabled=false;}

    function showError(m){hideAllMessages();const d=document.getElementById('errorMessage');d.textContent=m;d.style.display='block'}
    function showSuccess(m){hideAllMessages();const d=document.getElementById('successMessage');d.textContent=m;d.style.display='block'}
    function showWarning(m){hideAllMessages();const d=document.getElementById('warningMessage');d.textContent=m;d.style.display='block'}
    function showInfo(m){hideAllMessages();const d=document.getElementById('infoMessage');d.textContent=m;d.style.display='block'}
    function hideAllMessages(){['errorMessage','successMessage','warningMessage','infoMessage'].forEach(id=>{const el=document.getElementById(id); if(el) el.style.display='none';});}

    window.addEventListener('online',()=>{ if(authInProgress){ showInfo('Connection restored. You can try signing in again.'); }});
    window.addEventListener('offline',()=>{ showError('No internet connection. Please check your network.'); authInProgress=false; enableButtons(); });
    window.addEventListener('popstate',()=>{ try{ sessionStorage.removeItem('msal.interaction.status'); }catch{} authInProgress=false; enableButtons(); });
    window.addEventListener('beforeunload',()=>{ try{ sessionStorage.removeItem('msal.interaction.status'); }catch{} });

    window.addEventListener('DOMContentLoaded',()=>{ initializeMsal(); });
  </script>
</body>
</html>
