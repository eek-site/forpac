<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | FormanPacific Service Claims Management</title>
  <meta name="description" content="FormanPacific administrator dashboard for service claims management and supplier coordination" />

  <!-- Microsoft Authentication Library -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <!-- Command Menu -->
  <script src="/assets/js/fp-menu-loader.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;color:#2c3e50}

    /* Loading */
    .loading-screen{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999}
    .loading-screen.authenticated{display:none}
    .spinner{width:60px;height:60px;border:4px solid #e2e8f0;border-top:4px solid #1e3c72;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{color:#718096;font-size:1.1em}

    /* Dashboard */
    .dashboard-container{display:none;animation:fadeIn .5s ease}
    .dashboard-container.authenticated{display:block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* Header */
    .header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:1000}
    .header-content{max-width:1400px;margin:0 auto;padding:20px 30px;display:flex;justify-content:space-between;align-items:center}
    .logo-section{display:flex;align-items:center;gap:15px}
    .logo{width:50px;height:50px;background:linear-gradient(135deg,#1e3c72,#2a5298);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:24px}
    .company-info{display:flex;flex-direction:column}
    .company-name{font-size:1.6em;font-weight:600;color:#1e3c72}
    .dashboard-label{font-size:.9em;color:#718096;font-weight:500}
    .user-section{display:flex;align-items:center;gap:20px}
    .user-info{text-align:right}
    .user-name{font-weight:600;color:#2d3748}
    .user-role{font-size:.85em;color:#718096}
    .btn-logout{background:#e53e3e;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s}
    .btn-logout:hover{background:#c53030;transform:translateY(-2px)}

    .container{max-width:1400px;margin:0 auto;padding:20px}

    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 20px rgba(0,0,0,.08);transition:.3s;cursor:pointer;position:relative;overflow:hidden;border-top:4px solid transparent}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .stat-card.emergency{border-top-color:#f56565}
    .stat-card.claims{border-top-color:#4299e1}
    .stat-card.suppliers{border-top-color:#48bb78}
    .stat-card.compliance{border-top-color:#9f7aea}
    .stat-value{font-size:2.5em;font-weight:700;margin:10px 0;color:#1e3c72}
    .stat-label{color:#718096;font-size:.9em;text-transform:uppercase;letter-spacing:1px}
    .stat-change{font-size:.85em;margin-top:10px}
    .positive{color:#48bb78}.negative{color:#f56565}

    /* Main grid */
    .main-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    @media (max-width:968px){.main-grid{grid-template-columns:1fr}}

    .service-panel{background:#fff;border-radius:20px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.08)}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .panel-title{font-size:1.6em;color:#2d3748;font-weight:600}
    .view-all{color:#4299e1;text-decoration:none;font-weight:500;font-size:.95em}
    .view-all:hover{text-decoration:underline}

    /* Jobs */
    .job-list{list-style:none;padding:0}
    .job-item{background:#f8fafc;border-radius:12px;padding:15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;transition:.3s;cursor:pointer;border-left:3px solid transparent}
    .job-item:hover{background:#fff;transform:translateX(5px);box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .job-item.urgent{background:#fff5f5;border-left-color:#f56565}
    .job-item.insurance{border-left-color:#4299e1}
    .job-item.corporate{border-left-color:#9f7aea}
    .job-info h3{margin:0 0 5px 0;font-size:1.05em;color:#2d3748}
    .job-info p{margin:0;color:#718096;font-size:.9em}
    .job-status{display:flex;flex-direction:column;align-items:flex-end;gap:5px}
    .status-badge{padding:5px 12px;border-radius:20px;font-size:.8em;font-weight:700;text-transform:uppercase}
    .status-pending{background:#fef3c7;color:#92400e}
    .status-assigned{background:#dbeafe;color:#1e40af}
    .status-in-progress{background:#d1fae5;color:#065f46}
    .status-complete{background:#e9d5ff;color:#6b21a8}
    .response-time{font-size:.85em;color:#718096}

    /* Suppliers */
    .supplier-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px}
    .supplier-card{background:#f8fafc;border-radius:12px;padding:15px;text-align:center;transition:.25s;cursor:pointer;border:2px solid transparent}
    .supplier-card:hover{background:#fff;border-color:#4299e1;transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,.1)}
    .supplier-avatar{width:60px;height:60px;border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#fff}
    .supplier-avatar.available{background:linear-gradient(135deg,#48bb78,#38a169)}
    .supplier-avatar.busy{background:linear-gradient(135deg,#ed8936,#dd6b20)}
    .supplier-avatar.offline{background:linear-gradient(135deg,#a0aec0,#718096)}
    .supplier-name{font-weight:600;margin-bottom:5px;color:#2d3748;font-size:.95em}
    .supplier-specialty{font-size:.8em;color:#718096;margin-bottom:5px}
    .supplier-status{font-size:.85em;font-weight:500}

    /* Quick actions */
    .quick-actions{background:#fff;border-radius:20px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.08);margin-bottom:30px}
    .actions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px}
    .action-btn,.action-link{padding:15px 20px;border:2px solid #e2e8f0;border-radius:12px;background:#fff;color:#2d3748;font-weight:600;cursor:pointer;transition:.25s;text-align:center;text-decoration:none;display:flex;align-items:center;justify-content:center;gap:10px}
    .action-btn:hover,.action-link:hover{background:#1e3c72;color:#fff;border-color:#1e3c72;transform:translateY(-2px);box-shadow:0 10px 25px rgba(30,60,114,.3)}
    .action-icon{font-size:1.2em}
    .action-link.highlight{border-color:#4299e1;background:linear-gradient(135deg,#fff,#f0f9ff)}
    .action-link.highlight:hover{background:#4299e1;border-color:#4299e1}

    /* Footer */
    .footer{text-align:center;padding:30px 20px;color:#718096;font-size:.9em}

    /* Unauthorized */
    .unauthorized-screen{display:none;position:fixed;inset:0;background:#fff;align-items:center;justify-content:center;flex-direction:column;z-index:10000}
    .unauthorized-content{text-align:center;max-width:400px;padding:40px}
    .unauthorized-icon{font-size:4em;margin-bottom:20px}
    .unauthorized-title{font-size:1.8em;color:#2d3748;margin-bottom:10px}
    .unauthorized-message{color:#718096;margin-bottom:30px}
    .btn-login{background:#1e3c72;color:#fff;padding:12px 30px;border-radius:8px;text-decoration:none;display:inline-block;font-weight:600;transition:.25s}
    .btn-login:hover{background:#2a5298;transform:translateY(-2px)}
    
    /* Toast notifications */
    .toast-container{position:fixed;top:20px;right:20px;z-index:9999}
    .toast{background:#fff;padding:14px 18px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.15);margin-bottom:10px;display:flex;align-items:center;gap:12px;min-width:300px;animation:slideInRight .3s ease;border-left:4px solid}
    .toast.success{border-left-color:#48bb78}.toast.error{border-left-color:#f56565}.toast.warning{border-left-color:#ed8936}.toast.info{border-left-color:#4299e1}
    @keyframes slideInRight{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
  </style>
</head>
<body>
  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Loading -->
  <div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">Verifying authentication...</div>
  </div>

  <!-- Unauthorized -->
  <div class="unauthorized-screen" id="unauthorizedScreen">
    <div class="unauthorized-content">
      <div class="unauthorized-icon">🔒</div>
      <h1 class="unauthorized-title">Authentication Required</h1>
      <p class="unauthorized-message">You must be logged in to access the FormanPacific Admin Dashboard.</p>
      <a href="/admin" class="btn-login">Go to Login</a>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard-container" id="dashboardContainer">
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">FP</div>
          <div class="company-info">
            <div class="company-name">FormanPacific</div>
            <div class="dashboard-label">Administrator Dashboard</div>
          </div>
        </div>
        <div class="user-section">
          <div class="user-info">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-role">System Administrator</div>
          </div>
          <button class="btn-logout" onclick="logout()">Sign Out</button>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card emergency">
          <div class="stat-label">Active Emergency Jobs</div>
          <div class="stat-value" id="emergencyJobs">12</div>
          <div class="stat-change positive">↑ 15% from yesterday</div>
        </div>
        <div class="stat-card claims">
          <div class="stat-label">Claims Processing</div>
          <div class="stat-value" id="claimsProcessing">47</div>
          <div class="stat-change positive">↑ 8% from last week</div>
        </div>
        <div class="stat-card suppliers">
          <div class="stat-label">Active Suppliers</div>
          <div class="stat-value" id="activeSuppliers">523</div>
          <div class="stat-change positive">↑ 12 this month</div>
        </div>
        <div class="stat-card compliance">
          <div class="stat-label">Avg Response Time</div>
          <div class="stat-value" id="avgResponseTime">32m</div>
          <div class="stat-change positive">↓ 5 min improvement</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <h2 class="panel-title">Quick Actions</h2>
        <div class="actions-grid">
          <button class="action-btn" onclick="createNewClaim()"><span class="action-icon">📋</span>New Claim</button>
          <button class="action-btn" onclick="dispatchSupplier()"><span class="action-icon">🚀</span>Dispatch Supplier</button>
          <a href="/admin/jobs-master" class="action-link highlight"><span class="action-icon">📑</span>Jobs Master List</a>
          <a href="/admin/job-activity" class="action-link highlight"><span class="action-icon">📝</span>Job Activity Log</a>
          <button class="action-btn" onclick="viewReports()"><span class="action-icon">📊</span>View Reports</button>
          <button class="action-btn" onclick="manageSuppliers()"><span class="action-icon">👥</span>Manage Suppliers</button>
          <button class="action-btn" onclick="systemStatus()"><span class="action-icon">🔧</span>System Status</button>
          <button class="action-btn" onclick="togglePhoneSystem()"><span class="action-icon">📞</span>Phone System</button>
        </div>
      </div>

      <!-- Main Grid -->
      <div class="main-grid">
        <!-- Active Claims -->
        <div class="service-panel">
          <div class="panel-header">
            <h2 class="panel-title">Active Claims</h2>
            <a href="/admin/jobs-master" class="view-all">View All →</a>
          </div>
          <ul class="job-list" id="activeJobsList">
            <li class="job-item urgent insurance">
              <div class="job-info">
                <h3>Water Damage - Commercial Property</h3>
                <p>📍 Auckland CBD - Tower Insurance</p>
              </div>
              <div class="job-status">
                <span class="status-badge status-in-progress">In Progress</span>
                <span class="response-time">Response: 28 min</span>
              </div>
            </li>
            <li class="job-item insurance">
              <div class="job-info">
                <h3>Vehicle Breakdown - Mechanical</h3>
                <p>📍 Wellington - AA Insurance</p>
              </div>
              <div class="job-status">
                <span class="status-badge status-assigned">Assigned</span>
                <span class="response-time">ETA: 15 min</span>
              </div>
            </li>
            <li class="job-item corporate">
              <div class="job-info">
                <h3>HVAC Emergency - Office Building</h3>
                <p>📍 Christchurch - Corporate Direct</p>
              </div>
              <div class="job-status">
                <span class="status-badge status-pending">Pending</span>
                <span class="response-time">Queue: #3</span>
              </div>
            </li>
            <li class="job-item insurance">
              <div class="job-info">
                <h3>Tree Removal - Storm Damage</h3>
                <p>📍 Hamilton - State Insurance</p>
              </div>
              <div class="job-status">
                <span class="status-badge status-complete">Complete</span>
                <span class="response-time">Resolved: 45 min</span>
              </div>
            </li>
            <li class="job-item corporate">
              <div class="job-info">
                <h3>Electrical Fault - Retail Store</h3>
                <p>📍 Tauranga - Corporate Client</p>
              </div>
              <div class="job-status">
                <span class="status-badge status-assigned">Assigned</span>
                <span class="response-time">ETA: 20 min</span>
              </div>
            </li>
          </ul>
        </div>

        <!-- Supplier Status -->
        <div class="service-panel">
          <div class="panel-header">
            <h2 class="panel-title">Supplier Status</h2>
            <a href="#" class="view-all">Manage All →</a>
          </div>
          <div class="supplier-grid" id="supplierGrid">
            <div class="supplier-card"><div class="supplier-avatar available">JB</div><div class="supplier-name">John Brown</div><div class="supplier-specialty">Plumbing</div><div class="supplier-status positive">Available</div></div>
            <div class="supplier-card"><div class="supplier-avatar busy">SK</div><div class="supplier-name">Sarah Kim</div><div class="supplier-specialty">Electrical</div><div class="supplier-status negative">On Job</div></div>
            <div class="supplier-card"><div class="supplier-avatar available">MT</div><div class="supplier-name">Mike Taylor</div><div class="supplier-specialty">HVAC</div><div class="supplier-status positive">Available</div></div>
            <div class="supplier-card"><div class="supplier-avatar busy">AL</div><div class="supplier-name">Anna Lee</div><div class="supplier-specialty">Building</div><div class="supplier-status negative">Driving</div></div>
            <div class="supplier-card"><div class="supplier-avatar offline">RP</div><div class="supplier-name">Rob Park</div><div class="supplier-specialty">Automotive</div><div class="supplier-status">Offline</div></div>
            <div class="supplier-card"><div class="supplier-avatar available">LW</div><div class="supplier-name">Lisa Wong</div><div class="supplier-specialty">Tree Services</div><div class="supplier-status positive">Available</div></div>
          </div>
        </div>
      </div>

      <!-- System Health -->
      <div class="service-panel">
        <div class="panel-header">
          <h2 class="panel-title">System Health & Performance</h2>
          <a href="#" class="view-all">Full Analytics →</a>
        </div>
        <div class="stats-grid" style="margin-top:20px">
          <div style="background:#f8fafc;padding:20px;border-radius:12px;text-align:center">
            <div style="font-size:.9em;color:#718096;margin-bottom:10px">Phone System</div>
            <div style="font-size:1.5em;font-weight:700;color:#48bb78" id="phoneSystemStatus">ACTIVE</div>
          </div>
          <div style="background:#f8fafc;padding:20px;border-radius:12px;text-align:center">
            <div style="font-size:.9em;color:#718096;margin-bottom:10px">API Status</div>
            <div style="font-size:1.5em;font-weight:700;color:#48bb78" id="apiStatus">OPERATIONAL</div>
          </div>
          <div style="background:#f8fafc;padding:20px;border-radius:12px;text-align:center">
            <div style="font-size:.9em;color:#718096;margin-bottom:10px">Response Rate</div>
            <div style="font-size:1.5em;font-weight:700;color:#4299e1" id="responseRate">98.5%</div>
          </div>
          <div style="background:#f8fafc;padding:20px;border-radius:12px;text-align:center">
            <div style="font-size:.9em;color:#718096;margin-bottom:10px">Active Users</div>
            <div style="font-size:1.5em;font-weight:700;color:#9f7aea" id="activeUsers">47</div>
          </div>
        </div>
      </div>

      <div class="footer">
        <p>&copy; 2025 FormanPacific Service Claims Management. All rights reserved. | Admin Portal v2.1</p>
      </div>
    </div>
  </div>

  <script>
    // Keep msalInstance in outer scope for logout()
    let msalInstance = null;
    let statsTimer = null;

    const msalConfig = {
      auth: {
        clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
        authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
        // Match your /admin login page redirect
        redirectUri: window.location.origin + '/admin'
      },
      cache: {
        cacheLocation: 'sessionStorage',
        storeAuthStateInCookie: false
      }
    };

    // Toast notifications
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = {success:'✓',error:'✖',warning:'⚠',info:'ℹ'};
      toast.innerHTML = `<span style="font-size:18px">${icons[type]}</span><span style="flex:1">${message}</span><button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;font-size:18px">×</button>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    function showDashboard(account){
      document.getElementById('userName').textContent = account.name || account.username || 'Administrator';
      document.getElementById('loadingScreen').classList.add('authenticated');
      document.getElementById('dashboardContainer').classList.add('authenticated');

      if (!statsTimer){
        statsTimer = setInterval(updateStats, 10000);
      }
    }

    function showUnauthorized(){
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('unauthorizedScreen').style.display = 'flex';
    }

    async function initAuth(){
      try{
        if(!window.msal || !window.msal.PublicClientApplication){
          console.error('MSAL failed to load.');
          showUnauthorized();
          return;
        }

        msalInstance = new msal.PublicClientApplication(msalConfig);

        // First, complete any pending redirect
        const redirectResponse = await msalInstance.handleRedirectPromise();
        if (redirectResponse && redirectResponse.account){
          msalInstance.setActiveAccount(redirectResponse.account);
        }

        // Decide what to show
        const active = msalInstance.getActiveAccount();
        const accounts = msalInstance.getAllAccounts();
        const account = active || accounts[0];

        if (account){
          msalInstance.setActiveAccount(account);
          showDashboard(account);
        } else {
          showUnauthorized();
        }
      } catch (e){
        console.error('Auth init error:', e);
        showUnauthorized();
      }
    }

    async function logout(){
      try{
        const account = msalInstance?.getActiveAccount() || msalInstance?.getAllAccounts?.()[0];
        sessionStorage.clear();
        if (account){
          await msalInstance.logoutRedirect({
            account,
            postLogoutRedirectUri: window.location.origin + '/admin'
          });
        } else {
          window.location.href = '/admin';
        }
      } catch (e){
        console.error('Logout error:', e);
        sessionStorage.clear();
        window.location.href = '/admin';
      }
    }

    // Enhanced quick action functions with better feedback
    function createNewClaim(){ 
      showToast('Opening new claim form...', 'info');
      // In a real app, this would navigate to a claim creation form
      setTimeout(() => showToast('This would open the claim creation interface', 'info'), 1000);
    }

    function dispatchSupplier(){ 
      showToast('Opening supplier dispatch panel...', 'info');
      setTimeout(() => showToast('This would open the dispatch interface', 'info'), 1000);
    }

    function viewReports(){ 
      showToast('Loading reports dashboard...', 'info');
      setTimeout(() => showToast('This would display comprehensive reports', 'info'), 1000);
    }

    function manageSuppliers(){ 
      showToast('Opening supplier management...', 'info');
      setTimeout(() => showToast('This would open supplier management tools', 'info'), 1000);
    }

    function systemStatus(){ 
      showToast('System Status:\n\n✅ All systems operational\n✅ API endpoints responding\n✅ Database connected\n✅ Phone system active', 'success');
    }

    function togglePhoneSystem(){ 
      if(confirm('Toggle phone system status?')) {
        const statusEl = document.getElementById('phoneSystemStatus');
        const isActive = statusEl.textContent === 'ACTIVE';
        statusEl.textContent = isActive ? 'INACTIVE' : 'ACTIVE';
        statusEl.style.color = isActive ? '#f56565' : '#48bb78';
        showToast(`Phone system ${isActive ? 'deactivated' : 'activated'}`, isActive ? 'warning' : 'success');
      }
    }

    // Enhanced stat animation with more realistic variations
    function updateStats(){
      const stats = [
        { id: 'emergencyJobs', min: 8, max: 15, suffix: '' },
        { id: 'claimsProcessing', min: 40, max: 55, suffix: '' },
        { id: 'activeSuppliers', min: 500, max: 550, suffix: '' },
        { id: 'avgResponseTime', min: 25, max: 40, suffix: 'm' }
      ];

      stats.forEach(stat => {
        const el = document.getElementById(stat.id);
        if (el && Math.random() > 0.8) { // Less frequent updates
          const currentVal = parseInt(el.textContent.replace(/\D/g, ''), 10);
          const variance = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
          const newVal = Math.max(stat.min, Math.min(stat.max, currentVal + variance));
          
          el.style.transform = 'scale(1.05)';
          el.style.transition = 'transform 0.2s ease';
          el.textContent = newVal + stat.suffix;
          
          setTimeout(() => {
            el.style.transform = 'scale(1)';
          }, 200);
        }
      });
    }

    // Enhanced supplier status updates
    function updateSupplierStatuses() {
      const suppliers = document.querySelectorAll('.supplier-card');
      suppliers.forEach(card => {
        if (Math.random() > 0.95) { // Very infrequent status changes
          const avatar = card.querySelector('.supplier-avatar');
          const status = card.querySelector('.supplier-status');
          const statuses = [
            { class: 'available', text: 'Available', color: 'positive' },
            { class: 'busy', text: 'On Job', color: 'negative' },
            { class: 'busy', text: 'Driving', color: 'negative' },
            { class: 'offline', text: 'Offline', color: '' }
          ];
          
          const newStatus = statuses[Math.floor(Math.random() * statuses.length)];
          avatar.className = `supplier-avatar ${newStatus.class}`;
          status.textContent = newStatus.text;
          status.className = `supplier-status ${newStatus.color}`;
        }
      });
    }

    // Job status simulation
    function simulateJobUpdates() {
      const jobs = document.querySelectorAll('.job-item');
      jobs.forEach(job => {
        if (Math.random() > 0.98) { // Very rare updates
          const statusBadge = job.querySelector('.status-badge');
          const responseTime = job.querySelector('.response-time');
          
          // Simulate progression through statuses
          if (statusBadge.textContent === 'Pending') {
            statusBadge.textContent = 'Assigned';
            statusBadge.className = 'status-badge status-assigned';
            responseTime.textContent = 'ETA: ' + (Math.floor(Math.random() * 30) + 10) + ' min';
            showToast('Job status updated: Assigned to supplier', 'info');
          } else if (statusBadge.textContent === 'Assigned') {
            statusBadge.textContent = 'In Progress';
            statusBadge.className = 'status-badge status-in-progress';
            responseTime.textContent = 'Started: ' + (Math.floor(Math.random() * 15) + 5) + ' min ago';
            showToast('Job status updated: Work in progress', 'info');
          }
        }
      });
    }

    // Enhanced timer with multiple update types
    function startEnhancedTimer() {
      setInterval(() => {
        updateStats();
        updateSupplierStatuses();
        simulateJobUpdates();
      }, 15000); // Every 15 seconds
    }

    window.addEventListener('DOMContentLoaded', initAuth);
  </script>
  
  <!-- Custom command handling for dashboard -->
  <script>
    // Handle commands specific to the dashboard
    window.fpHandleCommand = function(command) {
      switch(command) {
        case 'Triage Form':
          window.location.href = '/admin/triage';
          break;
        case 'New Claim':
          createNewClaim();
          break;
        case 'Dispatch Supplier':
          dispatchSupplier();
          break;
        case 'View Reports':
          viewReports();
          break;
        case 'Manage Suppliers':
          manageSuppliers();
          break;
        case 'System Status':
          systemStatus();
          break;
        case 'Toggle Phone System':
          togglePhoneSystem();
          break;
        case 'Jobs Master':
          window.location.href = '/admin/jobs-master';
          break;
        case 'Job Activity':
          window.location.href = '/admin/job-activity';
          break;
        case 'Edit Activity':
          window.location.href = '/admin/job-activity-edit';
          break;
        case 'Refresh Dashboard':
          updateStats();
          updateSupplierStatuses();
          simulateJobUpdates();
          showToast('Dashboard refreshed', 'success');
          break;
        case 'Emergency Alert':
          showToast('🚨 Emergency jobs require immediate attention', 'warning');
          document.querySelector('.stat-card.emergency').style.animation = 'pulse 1s ease-in-out 3';
          break;
        case 'Show Active Jobs':
          document.querySelector('.service-panel').scrollIntoView({ behavior: 'smooth' });
          showToast('Showing active jobs section', 'info');
          break;
        case 'Show Suppliers':
          document.querySelectorAll('.service-panel')[1].scrollIntoView({ behavior: 'smooth' });
          showToast('Showing supplier status section', 'info');
          break;
        case 'Quick Stats':
          const emergency = document.getElementById('emergencyJobs').textContent;
          const claims = document.getElementById('claimsProcessing').textContent;
          const suppliers = document.getElementById('activeSuppliers').textContent;
          const response = document.getElementById('avgResponseTime').textContent;
          showToast(`Quick Stats: ${emergency} emergency jobs, ${claims} claims processing, ${suppliers} active suppliers, ${response} avg response`, 'info');
          break;
        case 'System Health':
          const phone = document.getElementById('phoneSystemStatus').textContent;
          const api = document.getElementById('apiStatus').textContent;
          const rate = document.getElementById('responseRate').textContent;
          const users = document.getElementById('activeUsers').textContent;
          showToast(`System Health: Phone ${phone}, API ${api}, Response rate ${rate}, ${users} active users`, 'info');
          break;
        case 'Job Complete':
          // Simulate completing the first in-progress job
          const inProgressJob = document.querySelector('.status-in-progress');
          if (inProgressJob) {
            inProgressJob.textContent = 'Complete';
            inProgressJob.className = 'status-badge status-complete';
            const responseTime = inProgressJob.parentElement.querySelector('.response-time');
            responseTime.textContent = 'Completed: Just now';
            showToast('Job marked as complete', 'success');
          } else {
            showToast('No in-progress jobs to complete', 'warning');
          }
          break;
        case 'Add Supplier':
          manageSuppliers();
          break;
        case 'Update Job':
          showToast('Job update functionality would open here', 'info');
          break;
        case 'Emergency Response':
          showToast('🚨 Activating emergency response protocol', 'warning');
          // Highlight emergency jobs
          document.querySelectorAll('.job-item.urgent').forEach(job => {
            job.style.boxShadow = '0 0 20px rgba(245, 101, 101, 0.5)';
            setTimeout(() => job.style.boxShadow = '', 3000);
          });
          break;
        default:
          showToast(`Command: ${command}`, 'info');
          console.log('Dashboard received command:', command);
      }
    };

    // Add pulse animation for emergency alerts
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
    `;
    document.head.appendChild(style);

    // Start enhanced updates when dashboard loads
    setTimeout(() => {
      if (document.getElementById('dashboardContainer').classList.contains('authenticated')) {
        startEnhancedTimer();
      }
    }, 2000);
  </script>
</body>
</html>
