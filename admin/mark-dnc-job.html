<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cancel Job (DNC) - FP Service Management</title>
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; min-height: 100vh; }

.loading { position: fixed; inset: 0; background: #fff; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; }
.loading.authenticated { display: none; }
.spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #1e3c72; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: #718096; font-size: 14px; }

.page-container { display: none; min-height: 100vh; }
.page-container.authenticated { display: block; }

.header { background: linear-gradient(135deg, #1e3c72, #2a5298); color: #fff; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.header-left { display: flex; align-items: center; gap: 16px; }
.back-btn { background: rgba(255,255,255,0.2); color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.2s; text-decoration: none; display: flex; align-items: center; gap: 6px; }
.back-btn:hover { background: rgba(255,255,255,0.3); color: #fff; text-decoration: none; }
.page-title { font-size: 20px; font-weight: 700; }
.page-icon { font-size: 24px; }

.main-content { padding: 24px; max-width: 800px; margin: 0 auto; }
.content-card { background: #fff; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }

.form-group { margin-bottom: 20px; }
.form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; }
.form-input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; }
.form-input:focus { outline: none; border-color: #1e3c72; box-shadow: 0 0 0 3px rgba(30,60,114,0.1); }
.form-textarea { min-height: 100px; resize: vertical; }
.form-select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: #fff; }

.btn { padding: 12px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
.btn-primary { background: #1e3c72; color: #fff; }
.btn-primary:hover { background: #1a3260; }
.btn-secondary { background: #6b7280; color: #fff; }
.btn-secondary:hover { background: #5b6370; }
.btn-success { background: #10b981; color: #fff; }
.btn-success:hover { background: #059669; }
.btn-danger { background: #ef4444; color: #fff; }
.btn-danger:hover { background: #dc2626; }
.btn-warning { background: #f59e0b; color: #fff; }
.btn-warning:hover { background: #d97706; }

.alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; border: 1px solid; }
.alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }
.alert-error { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
.alert-info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
.alert-warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }

.loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.loading-overlay.show { display: flex; }
.loading-card { background: #fff; padding: 30px; border-radius: 8px; text-align: center; }

.job-info-card { 
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe); 
  border: 2px solid #0ea5e9; 
  border-radius: 12px; 
  padding: 20px; 
  margin-bottom: 20px; 
}
.job-info-header { 
  display: flex; justify-content: space-between; align-items: center; 
  margin-bottom: 16px; 
}
.job-rego { 
  font-size: 1.4em; font-weight: 700; 
  color: #0c4a6e; 
}
.job-status { 
  background: #fbbf24; color: #92400e; 
  padding: 6px 12px; border-radius: 16px; 
  font-size: 0.85em; font-weight: 600; 
}
.job-details-grid { 
  display: grid; grid-template-columns: 1fr 1fr; 
  gap: 12px; 
}
.job-detail { 
  display: flex; flex-direction: column; 
}
.detail-label { 
  font-size: 0.85em; color: #64748b; 
  font-weight: 500; margin-bottom: 2px; 
}
.detail-value { 
  color: #1e293b; font-weight: 500; 
}

.cancellation-reasons { 
  display: grid; grid-template-columns: 1fr 1fr; 
  gap: 12px; margin-bottom: 16px; 
}
.reason-option { 
  background: #f8fafc; border: 2px solid #e2e8f0; 
  border-radius: 8px; padding: 12px; cursor: pointer; 
  transition: all 0.2s ease; text-align: center; 
}
.reason-option:hover { border-color: #1e3c72; }
.reason-option.selected { 
  background: #dbeafe; border-color: #1e3c72; 
  color: #1e3c72; font-weight: 600; 
}

.consequences-warning { 
  background: #fef3c7; border: 2px solid #f59e0b; 
  border-radius: 8px; padding: 16px; margin-bottom: 20px; 
}
.warning-header { 
  font-weight: 700; color: #92400e; 
  margin-bottom: 8px; 
}
.warning-list { 
  color: #92400e; font-size: 0.9em; 
}

@media (max-width: 768px) {
  .header { padding: 12px 16px; }
  .page-title { font-size: 18px; }
  .main-content { padding: 16px; }
  .content-card { padding: 20px; }
  .job-details-grid { grid-template-columns: 1fr; }
  .cancellation-reasons { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="loading" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">Verifying access...</div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-card">
        <div class="spinner"></div>
        <div style="margin-top: 15px;">Processing cancellation...</div>
    </div>
</div>

<div class="page-container" id="pageContainer">
    <div class="header">
        <div class="header-left">
            <a href="command-menu.html" class="back-btn">‚Üê Back to Menu</a>
            <div class="page-icon">‚ùå</div>
            <div class="page-title">Cancel Job (DNC)</div>
        </div>
    </div>

    <div class="main-content">
        <!-- Job Selection Section -->
        <div class="content-card">
            <h2>Select Job to Cancel</h2>
            <p style="color: #64748b; margin-bottom: 20px;">
                Choose a job registration number to cancel. DNC stands for "Do Not Continue" - 
                this will permanently cancel the job and update all related records.
            </p>
            
            <button class="btn btn-primary" onclick="selectJob()">
                üìã Select Job Registration
            </button>
            
            <div id="selectedJobInfo" style="display: none;"></div>
        </div>
        
        <!-- Cancellation Form -->
        <div class="content-card" id="cancellationForm" style="display: none;">
            <h2>Cancellation Details</h2>
            
            <!-- Cancellation Reason -->
            <div class="form-group">
                <label class="form-label">Reason for Cancellation *</label>
                <div class="cancellation-reasons">
                    <div class="reason-option" onclick="selectReason('customer-request')">
                        Customer Request
                    </div>
                    <div class="reason-option" onclick="selectReason('unable-to-service')">
                        Unable to Service
                    </div>
                    <div class="reason-option" onclick="selectReason('duplicate-booking')">
                        Duplicate Booking
                    </div>
                    <div class="reason-option" onclick="selectReason('payment-issue')">
                        Payment Issue
                    </div>
                    <div class="reason-option" onclick="selectReason('outside-coverage')">
                        Outside Coverage
                    </div>
                    <div class="reason-option" onclick="selectReason('other')">
                        Other Reason
                    </div>
                </div>
                <input type="hidden" id="cancellationReason" required>
            </div>
            
            <!-- Additional Notes -->
            <div class="form-group">
                <label for="cancellationNotes" class="form-label">
                    Cancellation Notes 
                    <span style="color: #64748b; font-weight: normal;">(optional)</span>
                </label>
                <textarea 
                    id="cancellationNotes" 
                    class="form-input form-textarea" 
                    placeholder="Provide additional details about the cancellation..."
                ></textarea>
            </div>
            
            <!-- Warning about consequences -->
            <div class="consequences-warning">
                <div class="warning-header">‚ö†Ô∏è Cancellation Consequences</div>
                <div class="warning-list">
                    This action will:
                    <ul style="margin: 8px 0 0 20px;">
                        <li>Mark the job as "DNC" (Do Not Continue)</li>
                        <li>Set job status to Cancelled/Closed</li>
                        <li>Update payment status to unpaid</li>
                        <li>Delete related supplier assignments</li>
                        <li>Log the cancellation in system records</li>
                        <li><strong>This action cannot be easily undone</strong></li>
                    </ul>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="cancelCancellation()">
                    Cancel
                </button>
                <button class="btn btn-danger" onclick="confirmCancellation()" disabled id="cancelJobBtn">
                    ‚ùå Cancel Job (DNC)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include Job Picker Modal -->
<iframe 
    id="jobPickerFrame"
    src="job-picker-modal.html" 
    style="display: none;" 
    onload="initJobPicker()"
></iframe>

<script>
let msalInstance = null;
let selectedJob = null;
let selectedReason = null;

const msalConfig = {
  auth: {
    clientId: 'd67be044-6aaa-4d01-ada2-da0cc50d2034',
    authority: 'https://login.microsoftonline.com/61ffc6bc-d9ce-458b-8120-d32187c3770d',
    redirectUri: window.location.origin + '/admin'
  },
  cache: {
    cacheLocation: 'sessionStorage',
    storeAuthStateInCookie: true
  },
  system: {
    allowNativeBroker: false,
    windowHashTimeout: 10000,
    iframeHashTimeout: 10000
  }
};

async function initAuth(){
  try{
    if(!window.msal || !window.msal.PublicClientApplication){
      console.error('MSAL failed to load.');
      return false;
    }

    msalInstance = new msal.PublicClientApplication(msalConfig);
    const redirectResponse = await msalInstance.handleRedirectPromise();
    if (redirectResponse && redirectResponse.account){
      msalInstance.setActiveAccount(redirectResponse.account);
    }

    const active = msalInstance.getActiveAccount();
    const accounts = msalInstance.getAllAccounts();
    const account = active || accounts[0];

    if (account){
      msalInstance.setActiveAccount(account);
      return true;
    } else {
      return false;
    }
  } catch (e){
    console.error('Auth init error:', e);
    return false;
  }
}

function showPage(){
  document.getElementById('loadingScreen').classList.add('authenticated');
  document.getElementById('pageContainer').classList.add('authenticated');
}

function showUnauthorized(){
  window.location.href = '/admin';
}

function showLoading(){
  document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading(){
  document.getElementById('loadingOverlay').classList.remove('show');
}

function showAlert(message, type = 'info'){
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.textContent = message;
  document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.content-card'));
  setTimeout(() => alertDiv.remove(), 5000);
}

// Initialize job picker iframe communication
function initJobPicker() {
  console.log('Job picker iframe loaded');
  // Listen for messages from job picker iframe
  window.addEventListener('message', handleJobPickerMessage);
}

function handleJobPickerMessage(event) {
  console.log('Received message:', event.data);
  
  if (event.data.type === 'JOB_SELECTED') {
    // Hide the iframe
    document.getElementById('jobPickerFrame').style.display = 'none';
    handleJobSelection(event.data.job);
  } else if (event.data.type === 'JOB_PICKER_CLOSED') {
    console.log('Job picker closed');
    // Hide the iframe
    document.getElementById('jobPickerFrame').style.display = 'none';
  }
}

// Job selection functions
function selectJob() {
  console.log('Opening job picker...');
  
  // Get the iframe
  const iframe = document.getElementById('jobPickerFrame');
  
  if (!iframe) {
    showAlert('Job picker not available', 'error');
    return;
  }
  
  console.log('Iframe contentWindow:', iframe.contentWindow);
  
  // Show the iframe so the modal is visible
  iframe.style.display = 'block';
  iframe.style.position = 'fixed';
  iframe.style.top = '0';
  iframe.style.left = '0';
  iframe.style.width = '100%';
  iframe.style.height = '100%';
  iframe.style.zIndex = '10000';
  iframe.style.border = 'none';
  
  // Send message to iframe to open picker
  iframe.contentWindow.postMessage({
    type: 'OPEN_PICKER',
    options: { filterPPI: false }
  }, '*');
}

function handleJobSelection(job) {
  console.log('Job selected:', job);
  selectedJob = job;
  displaySelectedJob(job);
  document.getElementById('cancellationForm').style.display = 'block';
}

function displaySelectedJob(job) {
  const container = document.getElementById('selectedJobInfo');
  const rego = job.Rego || 'Unknown';
  const customer = job.CustomerName || (job.FirstName + ' ' + job.LastName) || 'Unknown Customer';
  const service = job.ServiceType || job.ServiceRequired || 'Service';
  const price = job.Price || job.TotalPrice || job.Amount || 0;
  const status = job.Status || job.JobStatus || 'Active';
  
  container.innerHTML = `
    <div class="job-info-card">
      <div class="job-info-header">
        <div class="job-rego">Job: ${rego}</div>
        <div class="job-status">${status}</div>
      </div>
      <div class="job-details-grid">
        <div class="job-detail">
          <div class="detail-label">Customer</div>
          <div class="detail-value">${customer}</div>
        </div>
        <div class="job-detail">
          <div class="detail-label">Service Type</div>
          <div class="detail-value">${service}</div>
        </div>
        <div class="job-detail">
          <div class="detail-label">Price</div>
          <div class="detail-value">$${Number(price).toLocaleString()}</div>
        </div>
        <div class="job-detail">
          <div class="detail-label">Email</div>
          <div class="detail-value">${job.Email || 'Not provided'}</div>
        </div>
      </div>
    </div>
  `;
  
  container.style.display = 'block';
}

// Cancellation reason selection
function selectReason(reason) {
  // Clear previous selections
  document.querySelectorAll('.reason-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  // Select new reason
  event.target.classList.add('selected');
  selectedReason = reason;
  document.getElementById('cancellationReason').value = reason;
  
  // Enable cancel button if job is selected
  updateCancelButton();
}

function updateCancelButton() {
  const btn = document.getElementById('cancelJobBtn');
  btn.disabled = !selectedJob || !selectedReason;
}

// Cancellation process
async function confirmCancellation() {
  if (!selectedJob || !selectedReason) {
    showAlert('Please select a job and cancellation reason', 'error');
    return;
  }
  
  const confirmation = confirm(
    `Are you sure you want to cancel job ${selectedJob.Rego}?\n\n` +
    `This will mark it as DNC (Do Not Continue) and cannot be easily undone.`
  );
  
  if (!confirmation) return;
  
  showLoading();
  
  try {
    // Prepare cancellation data
    const cancellationData = {
      jobId: selectedJob.Id || selectedJob.ID,
      rego: selectedJob.Rego,
      reason: selectedReason,
      notes: document.getElementById('cancellationNotes').value,
      cancelledBy: msalInstance.getActiveAccount()?.username || 'Unknown',
      cancelledAt: new Date().toISOString(),
      originalData: selectedJob
    };
    
    // Call Power Automate flow
    const result = await callCancellationFlow(cancellationData);
    console.log('Cancellation result:', result);
    
    showAlert('Job successfully cancelled (DNC)', 'success');
    
    // Reset form
    resetForm();
    
    // Optional: redirect back to menu after a delay
    setTimeout(() => {
      window.location.href = 'command-menu.html';
    }, 2000);
    
  } catch (error) {
    console.error('Cancellation failed:', error);
    showAlert('Failed to cancel job: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}

async function callCancellationFlow(data) {
  // Power Automate flow endpoint with signature
  const flowEndpoint = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e1adbceb52c94e07b923228a8c05d29d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_ok7gvPEZKmPw9q2jiKY9Msqofd65YeMtuGfSjEqxJ4';
  
  const response = await fetch(flowEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      commandNumber: 0,
      action: 'MarkDNCJob',
      data: {
        jobId: data.jobId,
        rego: data.rego,
        customerName: selectedJob.CustomerName || 'Unknown',
        serviceType: selectedJob.ServiceType || 'Unknown',
        email: selectedJob.Email || '',
        phone: selectedJob.CallerPhone || '',
        price: selectedJob.Price || 0,
        reason: data.reason,
        notes: data.notes,
        cancelledBy: data.cancelledBy,
        cancelledAt: data.cancelledAt,
        fullJobData: selectedJob
      }
    })
  });
  
  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Flow failed: ${response.status} ${response.statusText} - ${errorText}`);
  }
  
  return response.json();
}

function cancelCancellation() {
  const confirmation = confirm('Are you sure you want to cancel this cancellation?');
  if (confirmation) {
    resetForm();
  }
}

function resetForm() {
  selectedJob = null;
  selectedReason = null;
  
  document.getElementById('selectedJobInfo').style.display = 'none';
  document.getElementById('cancellationForm').style.display = 'none';
  document.getElementById('cancellationNotes').value = '';
  document.getElementById('cancellationReason').value = '';
  
  document.querySelectorAll('.reason-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  updateCancelButton();
}

// Initialize page
window.addEventListener('DOMContentLoaded', async function(){
  const authenticated = await initAuth();
  if(authenticated){
    showPage();
  } else {
    showUnauthorized();
  }
});
</script>

</body>
</html>
